<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>computed 可能成为一个错误的工具（译文）</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-BzoAWw-A.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-DJrwyo0V.css"><link rel="modulepreload" crossorigin="" href="/assets/computed可能成为一个错误的工具（译文）-BYJhYxKN.js"><meta property="og:title" content="computed 可能成为一个错误的工具（译文）"><meta name="twitter:title" content="computed 可能成为一个错误的工具（译文）"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">computed 可能成为一个错误的工具（译文）</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2022-02-28 22:56</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2023-02-13 18:28</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/翻译">翻译</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">3.4K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">12 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言">🔗</a></h1><p>起因是在看 <code>vueuse/core</code> 里面的 <code>eagerComputed</code> 函数时，在文档下面有一篇文章</p><p>看完发现相当的有意思，所以挑一些段落来翻译，随便写写</p><blockquote><p>文章地址：<a href="https://dev.to/linusborg/vue-when-a-computed-property-can-be-the-wrong-tool-195j" target="_blank" rel="noopener">Vue: When a computed property can be the wrong tool</a></p></blockquote><h1 id="正文" tabindex="-1">正文 <a class="header-anchor" href="#正文">🔗</a></h1><p>如果你是一个 <code>Vue</code> 玩家，你大概知道计算属性，并且和我一样，认为它太棒了，就跟它的名字一样理所当然</p><p>对于我来说，计算属性是处理派生状态（派生状态可以理解为由其他的状态生成的状态，这里的其他状态可以理解为这个派生状态的依赖 <code>dependencies</code>）的一种非常符合人体工程学以及优雅的方式。但是在一些场景下，有可能降低性能，我意识到许多人可能不知道，所以尝试写下这篇文章来解释为什么计算属性可能会降低性能</p><p>当我们在 <code>Vue</code> 中讨论计算属性 <code>computed properties</code> 时，为了搞清楚我们在讨论什么，这里使用下面的例子来说明：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> todos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">([</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  {</span><span style="--s-dark:#B8A965;--s-light:#998418"> title</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Wahs Dishes</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#B8A965;--s-light:#998418"> done</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  {</span><span style="--s-dark:#B8A965;--s-light:#998418"> title</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Throw out trash</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#B8A965;--s-light:#998418"> done</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999"> }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">])</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> openTodos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> todos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">filter</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">todo</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">todo</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">done</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> hasOpenTodos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">openTodos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><p>上面的代码中，<code>openTodos</code> 派生自 <code>todos</code> ， <code>hasOpenTodos</code> 又派生自 <code>openTodos</code> 。看起来非常的 <code>nice</code> ，因为现在我们传递和使用这些响应式对象，每当它们依赖的（响应式）对象发生改变的时候它们就会自动地更新。</p><p>如果我们使用这些响应式对象在一个响应式的上下文中，比如一个 <code>Vue</code> 的模板，一个渲染 <code>render</code> 函数或者是一个 <code>watch</code> 函数，这些操作也会对计算属性的改变而反应，然后更新，这就是我们熟悉的 <code>Vue</code> 核心的一种魔力。</p><p>**注意：**我使用了组合式（<code>composition</code>）的 API 是因为刚好这几天我在使用它。文章中描述对于计算属性的行为同样适用于配置式（<code>options</code>）的 API ，毕竟使用的是相同的响应式系统。</p><h2 id="计算属性特殊的地方" tabindex="-1">计算属性特殊的地方 <a class="header-anchor" href="#计算属性特殊的地方">🔗</a></h2><p>有两点使得计算属性变得特殊，并且这两点和本文的要点相关：</p><ul><li>计算属性的结果是缓存的，只有它依赖的响应式对象发生了改变，它才就会重新地计算</li><li>获取结果的计算过程是惰性的</li></ul><h3 id="缓存" tabindex="-1">缓存 <a class="header-anchor" href="#缓存">🔗</a></h3><p>计算属性的结果是缓存的。在上面的例子中，只要不改变 <code>todos</code> 数组， 多次调用 <code>openTodos.value</code> 都会返回相同的值，这个值是不用重新调用 <code>filter</code> 方法来计算的。对于昂贵的任务来说这特别的棒，因为这确保了任务只在必须的时候才被重新执行，这里的“必须”可以理解为它依赖的响应式对象发生了改变。</p><h3 id="惰性计算" tabindex="-1">惰性计算 <a class="header-anchor" href="#惰性计算">🔗</a></h3><p>计算属性也是惰性计算的，但真的是这样吗？</p><p>惰性计算可以理解为一旦计算属性的值被读取（初始化或者由于它的依赖发生改变而被标记为更新），计算属性的回调函数会执行。</p><p>所以如果一个带有昂贵计算的计算属性在任何地方都没被使用，这个昂贵的操作不会被执行，这是处理大量数据时的另一个性能优势。</p><h2 id="惰性计算何时会提高性能" tabindex="-1">惰性计算何时会提高性能 <a class="header-anchor" href="#惰性计算何时会提高性能">🔗</a></h2><p>根据文章先前部分的解释，计算属性的惰性计算通常来说是一个优点，特别是对于昂贵的（计算代价大）操作：它确保了真的需要结果的时候才会去计算。</p><p>这意味着某些操作，比如过滤一个大的列表，如果过滤的结果不被你写的代码的任何一部分读取和使用的话，会简单地跳过这个计算过程。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">input</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">text</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-model</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">newTodo</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">button</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-on:click</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">addTodo</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">Save</span><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> @click</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">showList = !showList</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    Toggle ListView</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-if</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">showList</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-if</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">hasOpenTodos</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">h2</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">{{ openTodos.length }} Todos:</span><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">h2</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">ul</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">li</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-for</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">todo in openTodos</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">          {{ todo.title }}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">li</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">ul</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">span</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-else</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">No todos yet. Add one!</span><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">span</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setup</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> showListView</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4D9375;--s-light:#1E754F">false</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> todos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">([</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  {</span><span style="--s-dark:#B8A965;--s-light:#998418"> title</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Wahs Dishes</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#B8A965;--s-light:#998418"> done</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  {</span><span style="--s-dark:#B8A965;--s-light:#998418"> title</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Throw out trash</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#B8A965;--s-light:#998418"> done</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999"> }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">])</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> openTodos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> todos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">filter</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">todo</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">todo</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">done</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> hasOpenTodos</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">openTodos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTodo</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">''</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> addTodo</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  todos</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    title</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> todo</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    done</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>可以戳这里查看在线代码 <a href="https://sfc.vuejs.org/#eyJBcHAudnVlIjoiPHNjcmlwdCBzZXR1cD5cbmltcG9ydCB7IHJlYWN0aXZlLCByZWYsIGNvbXB1dGVkIH0gZnJvbSAndnVlJ1xuXG5jb25zdCBzaG93TGlzdCA9IHJlZihmYWxzZSlcbiAgXG5jb25zdCB0b2RvcyA9IHJlYWN0aXZlKFtcbiAgeyB0aXRsZTogJ1dhaHMgRGlzaGVzJywgZG9uZTogdHJ1ZX0sXG4gIHsgdGl0bGU6ICdUaHJvdyBvdXQgdHJhc2gnLCBkb25lOiBmYWxzZSB9XG5dKVxuXG5jb25zdCBvcGVuVG9kb3MgPSBjb21wdXRlZCgoKSA9PiB0b2Rvcy5maWx0ZXIodG9kbyA9PiAhdG9kby5kb25lKSlcbmNvbnN0IGhhc09wZW5Ub2RvcyA9IGNvbXB1dGVkKCgpID0+ICEhb3BlblRvZG9zLnZhbHVlLmxlbmd0aClcblxuY29uc3QgbmV3VG9kbyA9IHJlZignJylcbmZ1bmN0aW9uIGFkZFRvZG8oKSB7XG4gIHRvZG9zLnB1c2goe1xuICAgIHRpdGxlOiBuZXdUb2RvLnZhbHVlLFxuICAgIGRvbmU6IGZhbHNlXG4gIH0pXG4gIGNvbnNvbGUubG9nKHRvZG9zKVxufVxuXG48L3NjcmlwdD5cblxuPHRlbXBsYXRlPlxuICA8aW5wdXQgdHlwZT1cInRleHRcIiB2LW1vZGVsPVwibmV3VG9kb1wiPlxuXHQ8YnV0dG9uIHR5cGU9XCJidXR0b25cIiB2LW9uOmNsaWNrPVwiYWRkVG9kb1wiPlNhdmU8L2J1dHRvbj5cbiAgPGJ1dHRvbiBAY2xpY2s9XCJzaG93TGlzdCA9ICFzaG93TGlzdFwiPlxuICAgIFRvZ2dsZSBMaXN0Vmlld1xuICA8L2J1dHRvbj5cbiAgPHRlbXBsYXRlIHYtaWY9XCJzaG93TGlzdFwiPlxuICBcdDx0ZW1wbGF0ZSB2LWlmPVwiaGFzT3BlblRvZG9zXCI+XG4gICAgICA8aDI+e3sgb3BlblRvZG9zLmxlbmd0aCB9fSBUb2Rvczo8L2gyPiBcbiAgICAgIDx1bD5cbiAgICAgICAgPGxpIHYtZm9yPVwidG9kbyBpbiBvcGVuVG9kb3NcIj5cbiAgICAgICAgICB7eyB0b2RvLnRpdGxlIH19XG4gICAgICAgIDwvbGk+XG4gICAgICA8L3VsPlxuICAgIDwvdGVtcGxhdGU+XG4gICAgPHNwYW4gdi1lbHNlPk5vIHRvZG9zIHlldC4gQWRkIG9uZSE8L3NwYW4+XG4gIDwvdGVtcGxhdGU+XG4gIFxuPC90ZW1wbGF0ZT4ifQ==" target="_blank" rel="noopener">SFC Playground</a></p><p>当 <code>showList</code> 初始化为 <code>false</code> 的时候，模板或者渲染函数不会读取到 <code>openTodos</code> ，相应地，过滤的操作不会发生，无论是初始或者添加了一个新的 <code>todo</code> ，并且 <code>todos.length</code> 发生了改变。只有在 <code>showList</code> 设置为 <code>true</code> 之后，这些计算属性才会被读取，然后才会触发它们的计算。</p><p>当然在这个简单的例子中，过滤操作的工作量很小，但是你可以想象一下更加昂贵的操作，这是一个巨大的优势。</p><h2 id="惰性计算何时会降低性能" tabindex="-1">惰性计算何时会降低性能 <a class="header-anchor" href="#惰性计算何时会降低性能">🔗</a></h2><p>不利的一面：如果计算属性返回的结果只能在使用它之后才能知道，这意味着 <code>Vue</code> 的响应式系统无法事先知道这个返回值。</p><p>换句话说，<code>Vue</code> 可以意识到一个或者多个计算属性的依赖发生改变，所以可以在下次值被读取的时候重新计算，但是 <code>Vue</code> 无法知道，在那个时刻，计算属性返回的值是否是不同的。</p><h3 id="为什么这会成为一个问题？" tabindex="-1">为什么这会成为一个问题？ <a class="header-anchor" href="#为什么这会成为一个问题？">🔗</a></h3><p>你的代码的其他部分可能依赖了这个计算属性，或者可能是另一个计算属性，可能是一个 <code>watch</code> ，可能是一个模板或者渲染函数。</p><p>所以 <code>Vue</code> 没办法，只能把这些依赖也标记为更新的，防止返回值不同。</p><p>如果这些依赖这个计算属性的过程存在一些昂贵的操作，可能就会触发昂贵地重计算，尽管被依赖的计算属性的返回了和上一次相同值，即重计算是没有必要的。</p><h2 id="复现问题" tabindex="-1">复现问题 <a class="header-anchor" href="#复现问题">🔗</a></h2><p>下面是一个简单的例子：想象一下，我们有一个列表，有一个按钮用来增加次数。一旦次数达到 <code>100</code> ，我们逆序去展示这个列表（是的，这个例子有点蠢。）</p><p><a href="https://sfc.vuejs.org/#eyJBcHAudnVlIjoiPHNjcmlwdCBzZXR1cD5cbiAgaW1wb3J0IHsgcmVmLCByZWFjdGl2ZSwgY29tcHV0ZWQsIG9uVXBkYXRlZCB9IGZyb20gJ3Z1ZSdcblxuICBjb25zdCBsaXN0ID0gcmVhY3RpdmUoWzEsMiwzLDQsNV0pXG4gIFxuICBjb25zdCBjb3VudCA9IHJlZigwKVxuICBmdW5jdGlvbiBpbmNyZWFzZSgpIHtcbiAgICBjb3VudC52YWx1ZSsrXG4gIH1cbiAgXG4gIGNvbnN0IGlzT3ZlcjEwMCA9IGNvbXB1dGVkKCgpID0+IGNvdW50LnZhbHVlID4gMTAwKVxuICBcbiAgY29uc3Qgc29ydGVkTGlzdCA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICAvLyBpbWFnaW5lIHRoaXMgdG8gYmUgZXhwZW5zaXZlXG4gICAgcmV0dXJuIGlzT3ZlcjEwMC52YWx1ZSA/IFsuLi5saXN0XS5yZXZlcnNlKCkgOiBbLi4ubGlzdF1cbiAgfSlcbiAgXG4gIG9uVXBkYXRlZCgoKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2NvbXBvbmVudCByZS1yZW5kZXJlZCEnKVxuICB9KVxuICBcbjwvc2NyaXB0PlxuXG48dGVtcGxhdGU+XG4gIDxidXR0b24gQGNsaWNrPVwiaW5jcmVhc2VcIj5cbiAgICBDbGljayBtZVxuICA8L2J1dHRvbj5cbiAgPGJyPlxuICA8aDM+XG4gICAgTGlzdFxuICA8L2gzPlxuICA8dWw+XG4gICAgPGxpIHYtZm9yPVwiaXRlbSBpbiBzb3J0ZWRMaXN0XCI+XG4gICAgICB7eyBpdGVtIH19XG4gICAgPC9saT5cbiAgPC91bD5cbjwvdGVtcGxhdGU+In0=" target="_blank" rel="noopener">SFC playground</a></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> @click</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">increase</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    Click me</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">br</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">h3</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    List</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">h3</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">ul</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">li</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v-for</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">item in sortedList</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      {{ item }}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">li</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">ul</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setup</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> computed</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> onUpdated</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> list</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">([</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">2</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">3</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">4</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">5</span><span style="--s-dark:#666666;--s-light:#999999">])</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> count</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> increase</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  count</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isOver100</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> count</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 100</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> sortedList</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 想象这是一个昂贵的操作</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isOver100</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#666666;--s-light:#999999"> [...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">list</span><span style="--s-dark:#666666;--s-light:#999999">].</span><span style="--s-dark:#80A665;--s-light:#59873A">reverse</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#666666;--s-light:#999999"> [...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">list</span><span style="--s-dark:#666666;--s-light:#999999">]</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">onUpdated</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 在更新组件时打印</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">component re-rendered!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>**提问：**点击了 <code>101</code> 次按钮，组件会重渲染多少次？</p><p>脑袋里已经浮现出答案了吗？确定吗？</p><p><strong>答案：</strong> 组件会重新渲染 <strong><code>101</code></strong> 次</p><p>我猜有些人可能会猜想一个不同的答案，比如：“组件渲染一次，即使点击了 <code>101</code> 次按钮”。但这是错误的，原因是计算属性的惰性计算。</p><p>很疑惑？我们一步步地梳理下，看看到底发生了什么：</p><p>1.当我们点击了按钮， <code>count</code> 增加了。组件不会重渲染，因为我们没有在模板中使用 <code>count</code> 。 2.但是当 <code>count</code> 改变，计算属性 <code>isOver100</code> 被标记为 <code>dirty</code> 脏的，这里的 <code>dirty</code> 意思是该计算属性的一个响应式的依赖发生了改变，所以它的返回值必须重新计算。 3.由于惰性计算，重新计算只有在读取 <code>isOver100.value</code> 的时候才会发生，在发生前，我们（以及 <code>Vue</code> ）无法知道计算属性会返回 <code>false</code> 还是改变成 <code>true</code> 。 4.然而 <code>sortedList</code> 依赖了 <code>isOver100</code> ，所以 <code>sortedList</code> 也被标记为 <code>dirty</code> 脏的。同样，它不会被重新计算，只有被读取时候，才会触发计算过程。 5.因为模板依赖了 <code>sortedList</code> ，同样也被标记为 <code>dirty</code> （有可能发生变化，需要重新计算），然后组件就重新渲染了。 6.渲染的过程中，读取到了 <code>sortedList.value</code> 。 7.<code>sortedList</code> 现在重新计算了，由于读取到了 <code>isOver100.value</code> ，所以 <code>isOver100</code> 也重新计算了，但是返回的值仍然是 <code>false</code> 。 8.所以现在我们重新渲染了组件，重新计算了“昂贵”的 <code>sortedList</code> 计算属性，尽管所有的操作都是没有必要的，返回的新的虚拟 <code>DOM</code> 或者模板看起来都和先前的一样。</p><p>真正的罪魁祸首是 <code>isOver100</code> ， 这是一个经常更新的值， 但通常返回和先前相同的值，最重要的是，这是一个便宜的操作，并不能从计算属性的缓存特性中获益。我们只是觉得这样使用符合人体工程学，看起来很 “<code>nice</code>” 。</p><p>当这样的计算属性（指类似 <code>isOver100</code> 的计算属性）被另一个带有昂贵计算的计算属性（能够从缓存特性中获益）或者模板依赖时，可能会触发不必要地更新，进而严重降低代码的性能。</p><p>这种情况本质上可以理解为下面行为的组合：</p><p>1.一个昂贵的计算属性，被观察者或者模板依赖 2.另一个经常重新计算返回相同值的计算属性</p><h2 id="当遇到了时候，如何解决？" tabindex="-1">当遇到了时候，如何解决？ <a class="header-anchor" href="#当遇到了时候，如何解决？">🔗</a></h2><p>看到现在，你可能有两个问题：</p><p>1.哇，真的很糟吗？ 2.如何避免？</p><p>第一个问题：冷静下来，这不是一个很糟的问题。</p><p><code>Vue</code> 的响应式系统通常非常的高效，重渲染也一样，特别是现在的 <code>Vue3</code> 版本。通常，零星的不必要的更新也不会使得性能变得很差，即使默认情况下任何状态的更新都会导致重渲染。</p><p>所以这个问题只适用于频繁更新状态，进而在另一个地方触发频繁的，不必要的，昂贵的（非常大的组件，计算量很大的计算属性等）更新。</p><p>如果你遇到这样一种场景，可以使用一个自定义的工具函数来解决它。</p><h3 id="自定义的-eagercomputed-工具函数" tabindex="-1">自定义的 <code>eagerComputed</code> 工具函数 <a class="header-anchor" href="#自定义的-eagercomputed-工具函数">🔗</a></h3><p><code>Vue</code> 的响应式系统导出了我们所需的工具函数，使得我们可以构建一个个人版本的 <code>computed</code> ，它的计算是立即的，非惰性的。</p><p>我们称这个自定义 <code>computed</code> 为 <code>eagerComputed</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> shallowRef</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> readonly</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> eagerComputed</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fn</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> result</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> shallowRef</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    result</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    flush</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">sync</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // 立即执行获取更新后的值</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  })</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#80A665;--s-light:#59873A"> readonly</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">result</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>我们可以像使用计算属性一样使用这个 <code>eagerComputed</code> ，但是行为上不同的地方是 <code>eagerComputed</code> 的更新是立即的，非惰性的，避免了不必要的更新。</p><p>点击查看修复之后的例子 <a href="https://sfc.vuejs.org/#eyJBcHAudnVlIjoiPHNjcmlwdCBzZXR1cD5cbiAgaW1wb3J0IHsgcmVmLCByZWFjdGl2ZSwgc2hhbGxvd1JlZiwgcmVhZG9ubHksIGNvbXB1dGVkLCBvblVwZGF0ZWQsIHdhdGNoRWZmZWN0IH0gZnJvbSAndnVlJ1xuXG4gIGZ1bmN0aW9uIGVhZ2VyQ29tcHV0ZWQoZm4pIHtcbiAgICBjb25zdCByZXN1bHQgPSBzaGFsbG93UmVmKClcbiAgICB3YXRjaEVmZmVjdCgoKSA9PiB7XG4gICAgICByZXN1bHQudmFsdWUgPSBmbigpXG4gICAgfSwgXG4gICAge1xuICAgICAgZmx1c2g6ICdzeW5jJyAvLyBuZWVkZWQgc28gdXBkYXRlcyBhcmUgaW1tZWRpYXRlLlxuICAgIH0pXG5cbiAgICByZXR1cm4gcmVhZG9ubHkocmVzdWx0KVxuICB9XG4gIFxuICBjb25zdCBsaXN0ID0gcmVhY3RpdmUoWzEsMiwzLDQsNV0pXG4gIFxuICBjb25zdCBjb3VudCA9IHJlZigwKVxuICBmdW5jdGlvbiBpbmNyZWFzZSgpIHtcbiAgICBjb3VudC52YWx1ZSsrXG4gIH1cbiAgXG4gIGNvbnN0IGlzT3ZlcjEwMCA9IGVhZ2VyQ29tcHV0ZWQoKCkgPT4gY291bnQudmFsdWUgPiAxMDApXG4gIFxuICBjb25zdCBzb3J0ZWRMaXN0ID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgIC8vIGltYWdpbmUgdGhpcyB0byBiZSBleHBlbnNpdmVcbiAgICByZXR1cm4gaXNPdmVyMTAwLnZhbHVlID8gWy4uLmxpc3RdLnJldmVyc2UoKSA6IFsuLi5saXN0XVxuICB9KVxuICBcbiAgb25VcGRhdGVkKCgpID0+IHtcbiAgICBjb25zb2xlLmxvZygnY29tcG9uZW50IHJlLXJlbmRlcmVkIScpXG4gIH0pXG4gIFxuPC9zY3JpcHQ+XG5cbjx0ZW1wbGF0ZT5cbiAgPGJ1dHRvbiBAY2xpY2s9XCJpbmNyZWFzZVwiPlxuICAgIENsaWNrIG1lXG4gIDwvYnV0dG9uPlxuICA8YnI+XG4gIDxoMz5cbiAgICBMaXN0XG4gIDwvaDM+XG4gIDx1bD5cbiAgICA8bGkgdi1mb3I9XCJpdGVtIGluIHNvcnRlZExpc3RcIj5cbiAgICAgIHt7IGl0ZW0gfX1cbiAgICA8L2xpPlxuICA8L3VsPlxuPC90ZW1wbGF0ZT4ifQ==" target="_blank" rel="noopener">SFC Playground</a></p><p>什么时候该使用 <code>computed</code> ，什么时候又该使用 <code>eagerComputed</code> 呢？</p><ul><li>当你需要复杂的计算需要执行，可以真正地从缓存和惰性计算中获益，并且只在必要的时候重新计算时，使用 <code>computed</code> 。</li><li>当你有一个简单的操作，这个操作很少改变返回值，并且经常是一个 <code>boolean</code> 值，使用 <code>eagerComputed</code> 。</li></ul><p>**注意：**记住这个 <code>eagerComputed</code> 使用一个同步的观察者，意味着对于每一个响应式的改变，计算是同步且立即的，如果一个响应式依赖改变了 <code>3</code> 次，那么计算过程会重新计算 <code>3</code> 次。所以它应该被用于简单且便宜的操作。</p><h1 id="后记" tabindex="-1">后记 <a class="header-anchor" href="#后记">🔗</a></h1><p>相当有意思的一篇文章，总结一下就是：</p><p>由于 <code>computed</code> 是惰性计算取值的，响应式系统无法第一时间知道返回的值是否改变，那么只能理解为改变了，这样才能保持结果和预期一致，如果理解为没改变，从而依然使用缓存的值，但是实际的结果发生了改变的话，就会和预期的结果不一致，造成程序错误。</p><p>很多时候很容易写出如下的代码：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isXXXEmpty</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> computed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> XXXList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><p>然后使用一个 <code>watchEffect</code> 来判断</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isXXXEmpty</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // 昂贵的操作</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span></code></pre><p>每次我们往非空的 <code>XXXList</code> 里面添加一条数据，体感上 <code>watchEffect</code> 是不应该运行的，但是实际上每次对 <code>XXXList</code> 添加元素都会执行这个 <code>watchEffect</code> 。</p><p>不过一般我们都不会去在意这种小的消耗，因为 <code>watchEffect</code> 内部只在 <code>isXXXEmpty.value</code> 为 <code>false</code> 时才执行一段昂贵的逻辑。</p><p>而使用 <code>watchSyncEffect</code> 来模拟 <code>computed</code> ，使得取值是非惰性的，这样响应式系统能够<strong>立即</strong>知道本次的值和上次的值是否不同，进而触发依赖它的其他响应式对象是否进行更新操作。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isXXXEmpty</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> eagerComputed</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> XXXList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 每次对 XXXList 添加元素已经不会再触发该 effect 了</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 只有真的发生改变才会触发，比如从 true 变为 false ，或者从 false 变为 true 。</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isXXXEmpty</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // 昂贵的操作</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span></code></pre><p>颇有一种<a href="https://baike.baidu.com/item/%E8%96%9B%E5%AE%9A%E8%B0%94%E7%9A%84%E7%8C%AB/554903" target="_blank" rel="noopener">薛定谔的猫</a>的感觉，你无法知道 <code>computed</code> 返回的值是否发生了改变，我们称之为“薛定谔的 <code>computed</code> 返回值” （~不是~</p><p>如果还是不明白的话，可以看看 <code>computed</code> 以及 <code>ref</code> 的实现方式，配合文章食用更佳~</p><p>PS：惨，本来可以早点发的</p><p>这两天睡眠有点不足，感觉疲惫，加上原来帖子的地址突然不能访问了…</p><p>小摆了几天😂</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#Vue</div><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/1f077da7591b" class="" truncate="" title="如何懒加载图片"><i class="i-mi:chevron-left" mr-1=""></i><span>如何懒加载图片</span></a><a href="/0f6aabfdf118" class="" ml-auto="" truncate="" title="什么是base64编码"><span>什么是base64编码</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-4c769fad="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-4c769fad=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-4c769fad=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-4c769fad=""></i></div><div flex="~ col grow" gap-2="" lg:gap-4="" data-v-4c769fad=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-4c769fad=""></textarea><div flex="" items-start="" data-v-4c769fad=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-4c769fad="">支持 Markdown 语法</a><div ml-auto="" data-v-4c769fad=""></div><!----><button class="mujika-button" data-v-4c769fad="" data-v-15330f5f=""><!--[--><!--]--><!--[-->点击登录<!--]--></button></div></div></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-4c769fad="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" items-center="" justify-center="" data-v-4c769fad="">哦呢该，如果没有评论的话，瓦达西...</div><!----><!----><!--]--></div></div><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT © Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。</div></footer></div></div></body></html>