<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>react æºç ä¹‹ scheduler</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-4gPi1Ho2.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-afYcuv6x.css"><link rel="modulepreload" crossorigin="" href="/assets/react-æºç ä¹‹-scheduler-DTimV8cD.js"><meta property="og:title" content="react æºç ä¹‹ scheduler"><meta name="twitter:title" content="react æºç ä¹‹ scheduler"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="æ‹ã®æ­Œçš„logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="è‡ªåŠ¨" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="æ—¥é—´" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="å¤œé—´" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">react æºç ä¹‹ scheduler</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">å‘è¡¨äº</span><span pl-1="">2022-12-21 17:46</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">æ›´æ–°äº</span><span pl-1="">2023-02-13 18:28</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">åˆ†ç±»äº</span><!--[--><a pl-1="" href="/category/ç¼–ç¨‹">ç¼–ç¨‹</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">æ€»å­—æ•°</span><span pl-1="">4.2K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">é˜…è¯»æ—¶é•¿ â‰ˆ</span><span pl-1="">15 åˆ†é’Ÿ</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€">ğŸ”—</a></h1><p>æœ€è¿‘åœ¨çœ‹ <code>react</code> çš„æºç ï¼Œæ¥å†™ä¸€å†™åœ¨ <code>react</code> ä¸­çš„ä»»åŠ¡è°ƒåº¦æ¨¡å—</p><p>åœ¨ <code>react</code> ä¸­ï¼Œ <code>react</code> è‡ªå·±å®ç°äº†ä¸€å¥—ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œè¿™ä¸ªç³»ç»Ÿæˆä¸ºä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ï¼Œå³ <code>scheduler</code></p><p>ä¸ºä»€ä¹ˆå†™è¿™ä¸ªï¼Œæ˜¯å› ä¸ºå…¶å® <code>scheduler</code> åŒ…å’Œ <code>react</code> çš„è€¦åˆåŸºæœ¬æ²¡æœ‰ï¼Œè€Œä¸”å®ç°æ¯”è¾ƒç®€æ´ï¼Œæ‰€ä»¥æ‹¿å‡ºæ¥å†™å†™</p><p>ï¼ˆ<s>æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯å…¶ä»–æ¨¡å—æˆ‘çœ‹ä¸æ‡‚å•Š</s>)</p><h1 id="æ­£æ–‡" tabindex="-1">æ­£æ–‡ <a class="header-anchor" href="#æ­£æ–‡">ğŸ”—</a></h1><p>æœ¬æ–‡ä¸€åˆ‡çš„æºç æ¥æºäº <code>react 18.2.0</code></p><p><code>scheduler</code> åŒ…çš„æºç åœ¨ <code>package/scheduler</code> ä¸‹</p><p>å…¶æ ¸å¿ƒçš„æ–‡ä»¶ä¸º <code>package/scheduler/src/forks/Scheduler.js</code> ï¼Œä¸»è¦çš„é€»è¾‘éƒ½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­</p><p>åœ¨ <code>scheduler</code> æ¨¡å—ä¸­å®šä¹‰äº†å‡ ç§ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œæ”¾åœ¨ <code>package/scheduler/src/SchedulerPriorities.js</code> ä¸­</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> type</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 4</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 5</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">NoPriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ImmediatePriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">UserBlockingPriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">NormalPriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">LowPriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 4</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">IdlePriority</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 5</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span></code></pre><p>æ•°å­—è¶Šä½ï¼Œåˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ„å‘³ç€ä»»åŠ¡éœ€è¦æ›´å¿«çš„è¢«æ‰§è¡Œ</p><p>å¯¹äºæ¯ç§ä¼˜å…ˆçº§ï¼Œä»–ä»¬éƒ½å¯¹åº”äº†æŸä¸ªè¶…æ—¶æ—¶é—´ï¼Œåœ¨ <code>package/scheduler/src/forks/Scheduler.js</code> çš„ <code>78 ~ 85</code> è¡Œä¸­ï¼Œå®šä¹‰äº†å‡ ç§å¦‚ä¸‹çš„è¶…æ—¶æ—¶é—´</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">maxSigned31BitInt</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1073741823</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ç«‹å³æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">IMMEDIATE_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// åœ¨ x ms å†…æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">USER_BLOCKING_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 250</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">NORMAL_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 5000</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">LOW_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 10000</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// å¯ä»¥æ— é™è¶…æ—¶</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">IDLE_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1073741823</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span></code></pre><p>å¯¹äºæ¯ä¸ªä¼˜å…ˆçº§å¯¹åº”çš„è¶…æ—¶æ—¶é—´ï¼Œåˆ™æ˜¯åœ¨ <code>unstable_scheduleCallback</code> å‡½æ•°ä¸­åŒ¹é…çš„</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> unstable_scheduleCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  callback</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: {</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Task</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  switch</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    case</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ImmediatePriority</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> IMMEDIATE_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    case</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> UserBlockingPriority</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> USER_BLOCKING_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    case</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> IdlePriority</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> IDLE_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    case</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> LowPriority</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> LOW_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    case</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> NormalPriority</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    default</span><span style="--s-dark:#666666;--s-light:#999999">:</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> NORMAL_PRIORITY_TIMEOUT</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>åœ¨åé¢æˆ‘ä»¬ä¹Ÿä¼šè®²åˆ°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æ¥å‘è°ƒåº¦ç³»ç»Ÿä¸­æ³¨å†Œä»»åŠ¡</p><p>åœ¨è°ƒåº¦ç³»ç»Ÿä¸­ï¼Œä¸»è¦ä½¿ç”¨ä¸¤ä¸ªæœ€å°å †æ¥å­˜æ”¾ä»»åŠ¡åˆ—è¡¨ï¼Œä¸€ä¸ªæ˜¯å¤„äºè°ƒåº¦ä¸­çš„ä»»åŠ¡åˆ—è¡¨ï¼Œä¸€ä¸ªæ˜¯å»¶è¿Ÿè°ƒåº¦çš„ä»»åŠ¡åˆ—è¡¨</p><p>åœ¨ <code>package/scheduler/src/forks/Scheduler.js</code> çš„ <code>88 ~ 89</code> è¡Œä¸­</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Array</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Task</span><span style="--s-dark:#666666;--s-light:#999999">&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> [];</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Array</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Task</span><span style="--s-dark:#666666;--s-light:#999999">&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> [];</span></span></code></pre><p>åœ¨è°ƒåº¦ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä¸¤ç§ä»»åŠ¡ï¼Œåˆæˆ–è€…è¯´ä»»åŠ¡çš„ä¸¤ç§çŠ¶æ€ï¼Œä¸€ç§æ˜¯æ­£åœ¨è°ƒåº¦ä¸­ä»»åŠ¡ï¼Œä¸€ç§æ˜¯å»¶è¿Ÿä»»åŠ¡</p><p>å»¶è¿Ÿä»»åŠ¡ä¼šæ”¾åˆ° <code>timerQueue</code> ä¸­ï¼Œå¦‚æœå»¶è¿Ÿæ—¶é—´ç»“æŸï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«æ”¾åˆ° <code>taskQueue</code> ä¸­æ‰§è¡Œè°ƒåº¦è¿‡ç¨‹</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>react</code> è‡ªå·±å®ç°äº†ä¸€ä¸ªæœ€å°å †çš„ç®—æ³•ï¼Œåœ¨ <code>package/scheduler/src/SchedulerMinHeap.js</code> ä¸‹</p><p>è¯¥æ–‡ä»¶å¯¼å‡ºä¸€äº›æ“ä½œå †çš„å·¥å…·å‡½æ•°ï¼Œå¦‚ä¸‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> push</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#CB7676;--s-light:#AB5959">:</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Node</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">heap</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Heap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> node</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#CB7676;--s-light:#AB5959">:</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Node</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">heap</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Heap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> T</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> pop</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#CB7676;--s-light:#AB5959">:</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Node</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">heap</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Heap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> T</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å½“ç„¶ï¼Œè¿™äº›å‡½æ•°çš„å®ç°éƒ½ä¸æ˜¯é‡ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ä»»åŠ¡é—´çš„æ¯”è¾ƒå‡½æ•°ï¼Œå³å°æ ¹å †çš„å †é¡¶æ˜¯å¦‚ä½•æ¯”è¾ƒå‡ºæ¥çš„</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> compare</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">a</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Node</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> b</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Node</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">diff</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> a</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">b</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> diff</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> diff</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> a</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> b</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œä»»åŠ¡çš„ä¼˜å…ˆçº§å’Œä¸¤ä¸ªå­—æ®µå…³è”ï¼Œä¸€ä¸ªæ˜¯ <code>sortIndex</code>ï¼Œ ä¸€ä¸ªæ˜¯ <code>id</code></p><p>åœ¨å°æ ¹å †ä¸­å­˜æ”¾çš„æ˜¯ä»»åŠ¡å¯¹è±¡ <code>Task</code>ï¼Œæ¯ä¸€ä¸ª <code>Task</code> å®ƒçš„ <code>js</code> å¯¹è±¡ç»“æ„å¦‚ä¸‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">type</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Task</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  id</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  callback</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Callback</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  startTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  expirationTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  sortIndex</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>å…¶ä¸­ <code>id</code> ä¸ºæ•°å­—ï¼Œåœ¨å…¨å±€æœ‰ä¸€ä¸ª <code>id</code> è‡ªå¢å˜é‡ï¼Œåœ¨ <code>package/scheduler/src/forks/Scheduler.js</code> çš„ <code>92</code> è¡Œ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Incrementing id counter. Used to maintain insertion order.</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskIdCounter</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span></code></pre><p>æ¯æ¬¡æœ‰æ–°çš„ä»»åŠ¡è¿›æ¥ï¼Œå°±ä¼šæŠŠä»»åŠ¡çš„ <code>id</code> ç½®ä¸ºè¿™ä¸ª <code>taskIdCounter</code> çš„å€¼ï¼Œç„¶å <code>taskIdCounter</code> è‡ªå¢ï¼Œä¸ºä¸‹ä¸€ä¸ª <code>Task</code> åšå‡†å¤‡</p><p><code>callback</code> å³å›è°ƒå‡½æ•°</p><p><code>priorityLevel</code> ä¸ºè¯¥ä»»åŠ¡çš„ä¼˜å…ˆçº§</p><p><code>startTime</code> æœ‰ä¸¤ä¸ªå«ä¹‰ï¼Œå¦‚æœæ­¤æ—¶æ˜¯ç«‹å³è°ƒåº¦ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼ä¸º <code>currentTime()</code> å³æ³¨å†Œè¿™ä¸ªä»»åŠ¡çš„æ—¶é—´</p><p>å¦‚æœæ˜¯å»¶æ—¶ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„å€¼ä¸º <code>currentTime() + delay</code> ï¼Œè¿™é‡Œçš„ <code>delay</code> ä¸ºç”¨æˆ·æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´ï¼Œåé¢åœ¨ <code>unstable_scheduleCallback</code> å‡½æ•°ä¹Ÿè¿˜ä¼šè®²åˆ°</p><p>ä¹Ÿå¯ä»¥å¯ä»¥ç®€å•ç†è§£ä¸ºå¼€å§‹è°ƒåº¦çš„æ—¶é—´ï¼Œåœ¨ <code>startTime</code> å¼€å§‹è°ƒåº¦ä»»åŠ¡</p><p><code>expirationTime</code> å³ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä»»åŠ¡æœ€æ™šæ‰§è¡Œçš„æ—¶é—´ï¼Œå³ <code>startTime + priorityLevel__timeout</code></p><p><code>priorityLevel__timeout</code> å³è¯¥ä»»åŠ¡å¯¹åº”çš„ä¼˜å…ˆçº§æ‰€å¯¹åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå‰é¢çš„ <code>unstable_scheduleCallback</code> å‡½æ•°å†…çš„ <code>switch</code> æœ‰è®²è¿‡</p><p>å¯¹äº <code>sortIndex</code>ï¼Œ å®ƒåœ¨è°ƒåº¦é˜Ÿåˆ—å’Œå»¶æ—¶é˜Ÿåˆ—ä¸­çš„å«ä¹‰ä¸åŒï¼Œåœ¨ <code>unstable_scheduleCallback</code> å‡½æ•°ä¸­ï¼Œåˆ†åˆ«èµ‹äºˆäº†ä¸åŒçš„å€¼ï¼Œå¦‚ä¸‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> unstable_scheduleCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  callback</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: {</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Task</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> getCurrentTime</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ... ç¡®å®š startTime ï¼Œæœ‰ delay é‚£ä¹ˆå°±æ˜¯ currentTime() + delay ï¼Œæ²¡æœ‰å°±æ˜¯ currentTime()</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ... ç¡®å®šä¼˜å…ˆçº§çš„ timeout</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var </span><span style="--s-dark:#BD976A;--s-light:#B07D48">newTask</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Task</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    id</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskIdCounter</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    startTime</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    expirationTime</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    sortIndex</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">-</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å»¶æ—¶ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    newTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> startTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    newTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> expirationTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTask</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒåº¦é˜Ÿåˆ—çš„ <code>sortIndex</code> ä¸º <code>expirationTime</code> ï¼Œå³ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå³ä»»åŠ¡çš„æœ€æ™šæ‰§è¡Œæ—¶é—´</p><p>å¦‚æœä»»åŠ¡ <code>A</code> çš„è¿‡æœŸæ—¶é—´æ¯”ä»»åŠ¡ <code>B</code> æ—©ï¼Œé‚£ä¹ˆ <code>A</code> æ˜¯ä¸€å®šè¦å…ˆæ‰§è¡Œçš„</p><p>è€Œå»¶æ—¶ä»»åŠ¡çš„ <code>sortIndex</code> åˆ™æ˜¯ä»»åŠ¡çš„ <code>startTime</code> ï¼Œå³ä»»åŠ¡åº”è¯¥<strong>ä»å»¶æ—¶é˜Ÿåˆ—æ”¾åˆ°è°ƒåº¦é˜Ÿåˆ—</strong>çš„æ—¶é—´</p><p>å½“ <code>sortIndex</code> ç›¸åŒçš„æ—¶å€™ï¼Œæ­¤æ—¶ä¼šæŒ‰ç…§ <code>id</code> è¿›è¡Œåˆ¤æ–­ï¼Œå³å…ˆåŠ å…¥çš„ä¼šå…ˆæ‰§è¡Œï¼Œè€ŒååŠ å…¥çš„ä¼šåæ‰§è¡Œ</p><p>åœ¨å‡½æ•° <code>advanceTimers</code> ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªå»¶æ—¶ä»»åŠ¡ä»å»¶æ—¶é˜Ÿåˆ—æ”¾åˆ°è°ƒåº¦é˜Ÿåˆ—ä¹‹åï¼Œ <code>sortIndex</code> å±æ€§ä¹Ÿä¼šæ›´æ–°æˆ <code>expirationTime</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å»¶æ—¶é˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> timer</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  while</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timer</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ç”±äºå°æ ¹å †æ— æ³•æŒ‡å®šåˆ é™¤æŸä¸ª Task</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è€Œæ¥å£æš´éœ²äº†ä¸€ä¸ª unstable_cancelCallback å‡½æ•°ï¼Œå†…éƒ¨å°±æ˜¯æŠŠ Task çš„ callback å±æ€§ç½®ç©º</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ‰€ä»¥è¿™é‡Œè¦è¿‡æ»¤æ‰è¿™äº›è¢«å–æ¶ˆçš„ Task</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      pop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ£€æµ‹åˆ°å½“å‰æ—¶é—´å·²ç»å¤§äºå»¶æ—¶ä»»åŠ¡çš„å¯åŠ¨æ—¶é—´äº†</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999"> &lt;=</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å»¶æ—¶ä»»åŠ¡ä»å»¶æ—¶é˜Ÿåˆ—å¼¹å‡º</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      pop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ›´æ–° sortIndex ï¼Œæ­¤æ—¶å®ƒå°±æ˜¯ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡äº†</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      timer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> timer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">expirationTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ”¾åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> timer</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ²¡èµ°åˆ°ä¸Šé¢ä¸¤ä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆç¡®å®šæ­¤æ—¶çš„å»¶æ—¶ä»»åŠ¡ startTime &gt; currentTime ï¼Œæ­¤æ—¶è¿˜ä¸ç”¨å°†å®ƒæ”¾åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è€Œåˆç”±äºå»¶æ—¶é˜Ÿåˆ—æ˜¯æœ€å°å †ï¼Œå¯ä»¥åˆ¤æ–­åé¢çš„å»¶æ—¶ä»»åŠ¡çš„ startTime éƒ½ä¼šå¤§äº currentTime ï¼Œè¿™é‡Œå°±ç›´æ¥è·³å‡ºå¾ªç¯ç»“æŸå‡½æ•°å³å¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æŸ¥çœ‹ä¸‹ä¸ªå»¶æ—¶ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    timer</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p><code>advanceTimers</code> å¯ä»¥ç®€å•ç†è§£ä¸ºæŠŠå»¶æ—¶é˜Ÿåˆ—ä¸­åº”è¯¥æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—çš„ä»»åŠ¡æ”¾åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­</p><p>å‰é¢æˆ‘ä»¬åˆ†æäº† <code>Task</code> çš„æ•°æ®ç»“æ„ä»¥åŠ <code>Task</code> çš„ä¼˜å…ˆçº§ï¼Œè¶…æ—¶æ—¶é—´ç­‰</p><p>å¯¹äºæ¯ä¸ª <code>Task</code> ï¼Œå½“è½®åˆ°å®ƒæ‰§è¡Œçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œè€Œæ˜¯é€šè¿‡å¼‚æ­¥å½¢å¼æ¥æ‰§è¡Œ</p><p>åœ¨ä»£ç ä¸­çš„ <code>599 ~ 630</code> è¡Œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœ‰å‡ ä¸ªå¼‚æ­¥çš„ <code>api</code> ï¼Œ<code>setImmediate</code> ï¼Œ<code>MessageChannel</code> ä»¥åŠ <code>setTimeout</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> localSetImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">function</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    localSetImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">performWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> MessageChannel</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">undefined</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> channel</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> MessageChannel</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> port</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> channel</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">port2</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  channel</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">port1</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">onmessage</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> performWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    port</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">postMessage</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    localSetTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">performWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>ä»ä¸Šå¾€ä¸‹ï¼Œå±‚å±‚åœ°é™çº§ï¼Œæœ€ä¼˜çš„é€‰æ‹©æ˜¯ <code>setImmediate</code> ï¼Œæ¬¡ä¼˜é€‰æ‹© <code>MessageChannel</code> ï¼Œå¦‚æœå‰é¢éƒ½ä¸æ”¯æŒï¼Œé‚£ä¹ˆé€‰æ‹© <code>setTimeout</code></p><p>åœ¨è¯¥æ®µä»£ç çš„æ³¨é‡Šä¸­ï¼Œæåˆ°äº†ä½¿ç”¨æ¯ä¸ª <code>api</code> çš„åŸå› </p><p>å¯¹äº <code>setImmediate</code></p><blockquote><p>Node.js and old IE. Thereâ€™s a few reasons for why we prefer setImmediate. Unlike MessageChannel, it doesnâ€™t prevent a Node.js process from exiting. (Even though this is a DOM fork of the Scheduler, you could get here with a mix of Node.js 15+, which has a MessageChannel, and jsdom.) <a href="https://github.com/facebook/react/issues/20756" target="_blank" rel="noopener">https://github.com/facebook/react/issues/20756</a></p><p>But also, it runs earlier which is the semantic we want. If other browsers ever implement it, itâ€™s better to use it. Although both of these would be inferior to native scheduling.</p></blockquote><p>å¤§æ„å°±æ˜¯ï¼Œè¿™ä¸ª <code>api</code> æ˜¯ <code>node</code> å’Œè€ <code>IE</code> ä¸‹æ”¯æŒçš„ï¼Œå¯¹æ¯” <code>MessageChannel</code> ï¼Œ<code>setImmediate</code> ä¸ä¼šé˜»ç¢ <code>node</code> è¿›ç¨‹çš„é€€å‡ºï¼Œä»¥åŠä¼šè¢«æ›´æ—©çš„æ‰§è¡Œ</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œ<code>react</code> åœ¨ <code>SSR</code> ä¸‹ä¼šè·‘åœ¨ <code>node</code> ç«¯ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå…ˆåˆ¤æ–­ <code>setImmediate</code></p><p>å¯¹äº <code>MessageChannel</code> ï¼Œå¯¹äºå¾ˆå¤šäººæ¥è¯´å¯èƒ½ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œè¿™é‡Œæ”¾ä¸€ä¸ª <code>MDN</code> çš„åœ°å€ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener">MessageChannel - MDN</a></p><blockquote><p>DOM and Worker environments. We prefer MessageChannel because of the 4ms setTimeout clamping.</p></blockquote><p>è¿™ä¸ª <code>api</code> åœ¨ <code>DOM</code> å’Œ <code>Worker</code> ç¯å¢ƒä¸‹å¯ç”¨ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒçš„åŸå› æ˜¯ <code>setTimeout</code> å­˜åœ¨æœ€å° <code>4ms</code> çš„å»¶è¿Ÿï¼Œè€Œ <code>MessageChannel</code> æ²¡æœ‰è¿™ä¸ªé™åˆ¶</p><p>å…³äº <code>setTimeout</code> çš„ <code>4ms</code> å»¶è¿Ÿï¼Œè¿™é‡Œè´´ä¸€ä¸ªé“¾æ¥ï¼Œè®²çš„å¾ˆå¥½ <a href="https://zhuanlan.zhihu.com/p/155752686" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆ setTimeout æœ‰æœ€å°æ—¶å»¶ 4ms ? - çŸ¥ä¹</a></p><p><code>react</code> ä¸­ä¼šæœ‰åµŒå¥— <code>setTimeout</code> çš„æƒ…å†µï¼Œè€Œåœ¨è°ƒåº¦å™¨çš„è®¾ç½®ä¸­ï¼Œæ¯ä¸ªæ—¶é—´ç‰‡ä¸º <code>5ms</code> ï¼Œå¦‚æœè§¦å‘äº† <code>4ms</code> çš„é™åˆ¶ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´åªå‰© <code>1ms</code> ç”¨äºæ‰§è¡Œäº†ï¼Œè¿™å¯¹äºè°ƒåº¦æ¥è¯´æ˜¯æ— æ³•æ¥å—äº†</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ° <code>unstable_scheduleCallback</code> è¿™ä¸ªå‡½æ•°</p><p>åœ¨åˆ¤æ–­å®Œæ˜¯è°ƒåº¦ä»»åŠ¡è¿˜æ˜¯å»¶æ—¶ä»»åŠ¡ä¹‹åï¼Œè¿™ä¸ªå‡½æ•°é™¤äº†æŠŠä»»åŠ¡æ¨å…¥ç›¸åº”çš„å°æ ¹å †ä¹‹åï¼Œè¿˜ä¼šæ‰§è¡Œä¸€äº›æ“ä½œ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> unstable_scheduleCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  callback</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: {</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Task</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å»¶æ—¶ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> startTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è°ƒåº¦ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isHostCallbackScheduled</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isPerformingWork</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      isHostCallbackScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      requestHostCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flushWork</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTask</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œé¢æœ‰å››ä¸ªå‡½æ•°ï¼Œ<code>requestHostTimeout</code> ã€ <code>requestHostCallback</code> ã€ <code>handleTimeout</code> ã€ <code>flushWork</code></p><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ <code>requestHostTimeout</code> å’Œ <code>requestHostCallback</code> è¿™ä¸¤ä¸ªå‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ms</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  taskTimeoutID</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> localSetTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    callback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">getCurrentTime</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ms</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å…¶ä¸­ <code>requestHostTimeout</code> å¾ˆç®€å•ï¼Œå°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª <code>setTimeout</code> å®ä»»åŠ¡ï¼Œè®°å½•äº†ä»»åŠ¡çš„ <code>ID</code></p><p>ä¼ å…¥ <code>requestHostTimeout</code> çš„ <code>callback</code> ä¸º <code>handleTimeout</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ¢å¤æ ‡å¿—ä½</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  isHostTimeoutScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¤„ç†å¯ä»¥æ”¾åˆ°è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—çš„å»¶è¿Ÿä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¦‚æœæ­¤æ—¶æœªè°ƒåº¦ï¼Œä½†æ˜¯è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—å­˜åœ¨ä»»åŠ¡ï¼Œè¦å¯åŠ¨è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¦‚æœæ­¤æ—¶æœªè°ƒåº¦ï¼Œä½†æ˜¯è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—ç©ºäº†ï¼Œè€Œå»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—éç©ºï¼Œåˆ™è¦å¯åŠ¨ä¸€ä¸ª setTimeout æ¥é€’å½’æ‰§è¡Œ handleTimeout </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ç”¨äºä¸‹ä¸€æ¬¡é‡æ–°æ‰§è¡Œ advanceTimers æ¥å¤„ç†èƒ½æ”¾å…¥è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—çš„å»¶è¿Ÿä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isHostCallbackScheduled</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      isHostCallbackScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      requestHostCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flushWork</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> firstTimer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>ç®€å•è®² <code>handleTimeout</code> å°±æ˜¯ <code>advanceTimers</code> åŒ…äº†ä¸€å±‚ï¼Œç„¶ååœ¨èƒ½å¯åŠ¨è°ƒåº¦çš„æƒ…å†µä¸‹å¯åŠ¨è°ƒåº¦</p><p>å¯¹äº <code>requestHostTimeout(handleTimeout)</code> ï¼Œåœ¨æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ä¸­ï¼ŒæŸä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ª <code>setTimeout</code> ä¼šçœŸæ­£åœ°æ‰§è¡Œåˆ°</p><p>å› ä¸ºå»¶æ—¶é˜Ÿåˆ—ä»»åŠ¡çš„å †é¡¶æ˜¯åœ¨ä¸æ–­å˜åŒ–çš„ï¼Œå‡è®¾æˆ‘ä»¬ç°åœ¨æ¨å…¥äº†ä¸‰ä¸ªå»¶æ—¶ä»»åŠ¡ <code>2 1 3</code> æ•°å­—ä»£è¡¨å»¶è¿Ÿçš„æ—¶é—´ï¼ˆå•ä½ï¼š<code>s</code>ï¼‰</p><p>å½“æˆ‘ä»¬æŠŠ <code>2</code> æ”¾å…¥å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—ä¹‹åï¼Œè°ƒåº¦ç³»ç»Ÿä¼šå¯åŠ¨ä¸€ä¸ª <code>setTimeout</code> ï¼Œåœ¨ <code>2s</code> ä¹‹åæ‰§è¡Œä¸€æ¬¡ <code>handleTimeout</code></p><p>è€Œåœ¨ <code>0.5s</code> ä¹‹åæˆ‘ä»¬æ”¾å…¥äº†ä»»åŠ¡ <code>1</code> ï¼Œæ­¤æ—¶å»¶æ—¶ä»»åŠ¡å †é¡¶å·²ç»ä¸æ˜¯ä»»åŠ¡ <code>2</code> äº†ï¼ˆä»»åŠ¡ <code>2</code> çš„ <code>startTime</code> æ¯”ä»»åŠ¡ <code>1</code> è¦å¤§ï¼Œå³ä»»åŠ¡ <code>1</code> çš„å»¶è¿Ÿæ—¶é—´æ¯”ä»»åŠ¡ <code>2</code> è¦çŸ­ï¼‰ï¼Œä½†æ˜¯ä»»åŠ¡ <code>2</code> çš„å›è°ƒä¾ç„¶å­˜åœ¨</p><p>æ‰€ä»¥è¿™æ—¶æˆ‘ä»¬éœ€è¦å–æ¶ˆä»»åŠ¡ <code>2</code> çš„å›è°ƒï¼Œå†å¯åŠ¨ä»»åŠ¡ <code>1</code> çš„å›è°ƒï¼Œè¿™æ ·é€»è¾‘ä¸Šæ‰æ˜¯æ­£ç¡®çš„</p><p>æ¥ç€æˆ‘ä»¬ç«‹é©¬åŠ å…¥å»¶æ—¶ä»»åŠ¡ <code>3</code> ï¼Œç”±äºæ­¤æ—¶å»¶æ—¶ä»»åŠ¡ <code>3</code> çš„ <code>startTime</code> æ¯”ä»»åŠ¡ <code>1</code> çš„å¤§ï¼Œæ­¤æ—¶å»¶æ—¶ä»»åŠ¡é˜Ÿåˆ—å †é¡¶è¿˜æ˜¯ä»»åŠ¡ <code>1</code> ï¼Œæ­¤æ—¶åˆ™ä¸ç”¨è¿›è¡Œæ“ä½œ</p><p>åœ¨ä»£ç ä¸­ï¼Œæœ‰ä¸¤å¤„æ¸…ç†çš„æƒ…å†µï¼Œå…¶ä¸­ä¸€å¤„ä¸º <code>unstable_scheduleCallback</code> ä¸­ï¼Œåœ¨å¤„ç†å»¶æ—¶ä»»åŠ¡æ—¶ï¼Œä¼šå…ˆæ¸…ç†å›è°ƒ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> unstable_scheduleCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">PriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  callback</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Callback</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: {</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">},</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Task</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    newTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">sortIndex</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> startTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTask</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœè°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œä¸”æ­¤æ—¶æ–°çš„ä»»åŠ¡æ˜¯æœ€å…ˆè¯¥æ”¾åˆ°è°ƒåº¦ä»»åŠ¡çš„é˜Ÿåˆ—çš„è¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // åŸæœ¬çš„å›è°ƒè¦å–æ¶ˆï¼Œå› ä¸ºæ­¤æ—¶ç¬¬ä¸€ä¸ªè¯¥æ”¾åˆ°è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡å·²ç»æ”¹å˜</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isHostTimeoutScheduled</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        cancelHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        isHostTimeoutScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å¯åŠ¨å®šæ—¶å™¨</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> startTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> newTask</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¦ä¸€å¤„ä¸º <code>flushWork</code> ä¸­ï¼Œåœ¨æ‰§è¡Œ <code>workLoop</code> å‰ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸º <code>workLoop</code> ç»“æŸå‰ä¼šæŠŠå»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—çš„å †é¡¶æ‹¿å‡ºæ¥å¼€ä¸€ä¸ª <code>setTimeout</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> flushWork</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å­˜åœ¨çš„è¯è¦å–æ¶ˆæ‰ï¼Œå› ä¸º workLoop ä¼šé‡æ–°å¯åŠ¨ handleTimeout</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isHostTimeoutScheduled</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    isHostTimeoutScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    cancelHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> workLoop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> finally</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> workLoop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  currentTask</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  while</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">enableSchedulerDebugging</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isSchedulerPaused</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    )</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å»¶è¿Ÿä»»åŠ¡é˜Ÿåˆ—éç©ºï¼Œå–å †é¡¶å¼€å¯å®šæ—¶å™¨</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> firstTimer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯¹äº <code>requestHostCallback</code> ï¼Œå®ƒä¼šæŠŠå›è°ƒèµ‹ç»™ <code>scheduledHostCallback</code> å˜é‡</p><p>ç„¶ååˆ¤æ–­ <code>isMessageLoopRunning</code> ï¼Œåœ¨éè°ƒåº¦çŠ¶æ€ä¸‹æ‰æ‰§è¡Œä¸€æ¬¡è°ƒåº¦ï¼Œå³æ‰§è¡Œ <code>schedulePerformWorkUntilDeadline</code> å‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestHostCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  scheduledHostCallback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> callback</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isMessageLoopRunning</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    isMessageLoopRunning</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>åœ¨å‰é¢æˆ‘ä»¬çŸ¥é“ <code>schedulePerformWorkUntilDeadline</code> å°±æ˜¯å– <code>setImmediate</code> ã€ <code>MessageChannel</code> ã€ <code>setTimeout</code> ä¸­çš„ä¸€ä¸ª</p><p>ç„¶åçœŸæ­£æ‰§è¡Œçš„æ˜¯ <code>performWorkUntilDeadline</code> è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡åå­—ä¸éš¾ç†è§£ï¼Œå°±æ˜¯æ‰§è¡Œä»»åŠ¡ç›´åˆ°æˆªè‡³æ—¶é—´</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">performWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduledHostCallback</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !== null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> getCurrentTime</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasMoreWork</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      hasMoreWork</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> scheduledHostCallback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> finally</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasMoreWork</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        schedulePerformWorkUntilDeadline</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        isMessageLoopRunning</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        scheduledHostCallback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    isMessageLoopRunning</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  needsPaint</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸Šæ¥å°±åˆ¤æ–­äº† <code>scheduledHostCallback</code> æ˜¯å¦å­˜åœ¨ï¼Œç„¶ååœ¨ <code>try</code> é‡Œé¢æ‰§è¡Œäº†</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œè¿™ä¸ª <code>scheduledHostCallback</code> å…¶å®å°±æ˜¯ <code>flushWork</code> è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºä¹‹å‰åœ¨ <code>unstable_scheduleCallback</code> ä¸­ï¼Œå°±è°ƒç”¨äº† <code>requestHostCallback(flushWork)</code></p><p>åœ¨ <code>finally</code> é‡Œé¢ï¼Œä¼šæ ¹æ® <code>scheduledHostCallback</code> è¿”å›çš„æƒ…å†µæ¥åˆ¤æ–­æ˜¯å¦ç»§ç»­è¿›è¡Œè°ƒåº¦ï¼Œå¦‚æœ <code>hasMoreWork</code> ä¸ºçœŸï¼Œé‚£ä¹ˆè¡¨æ˜æ­¤æ—¶è¿˜æœ‰ä»»åŠ¡ï¼Œéœ€è¦ç»§ç»­è¿›è¡Œè°ƒåº¦</p><p>å¦‚æœä¸ºå‡ï¼Œé‚£ä¹ˆæŠŠå…¨å±€å˜é‡ <code>isMessageLoopRunning</code> ç½®ä¸ºå‡ï¼Œæ„å‘³ç€æ­¤æ—¶æ²¡æœ‰è°ƒåº¦ï¼Œ <code>scheduledHostCallback</code> ç½®ä¸º <code>null</code> ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„ <code>flushWork</code></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>flushWork</code> è¿™ä¸ªå‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> flushWork</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦å·²å®Œæˆ</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  isHostCallbackScheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¼€å§‹æ‰§è¡Œå›è°ƒ</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  isPerformingWork</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ä¿å­˜ä¹‹å‰çš„ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">previousPriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentPriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ‰§è¡Œå›è°ƒ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> workLoop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> finally</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ›´æ–°æ ‡å¿—ä½</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentTask</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¢å¤ä¹‹å‰ä¼˜å…ˆçº§</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentPriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> previousPriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å›è°ƒæ‰§è¡Œå®Œæˆ</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    isPerformingWork</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æ ¸å¿ƒé€»è¾‘ä¸º <code>workLoop</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> workLoop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> initialTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å–è°ƒåº¦é˜Ÿåˆ—å †é¡¶å…ƒç´ </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  currentTask</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦é˜Ÿåˆ—éç©ºæƒ…å†µä¸‹å¼€å§‹å¾ªç¯ ï¼ˆenableSchedulerDebugging &amp;&amp; isSchedulerPaused è¿™ä¸ªæ¡ä»¶ä¸ç”¨çœ‹ï¼Œè°ƒè¯•ç”¨çš„ï¼‰</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  while</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">enableSchedulerDebugging</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isSchedulerPaused</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  )</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å½“å‰ä»»åŠ¡è¿‡æœŸæ—¶é—´å¤§äºå½“å‰æ—¶é—´ä¸”æ­¤æ—¶æ— å‰©ä½™æ—¶é—´</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æˆ–è€…æ­¤æ—¶å‰ä»»åŠ¡è¿‡æœŸæ—¶é—´å¤§äºå½“å‰æ—¶é—´ä¸”æ­¤æ—¶åº”è¯¥äº¤è¿˜ä¸»çº¿ç¨‹æ§åˆ¶æƒ</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // åˆ™é€€å‡ºå¾ªç¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">expirationTime</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hasTimeRemaining</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#80A665;--s-light:#59873A"> shouldYieldToHost</span><span style="--s-dark:#666666;--s-light:#999999">())</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    )</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // åªå¤„ç† callback ä¸ºå‡½æ•°çš„æƒ…å†µ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> callback</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">function</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      currentPriorityLevel</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">priorityLevel</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // ä»»åŠ¡æ˜¯å¦è¶…æ—¶äº†</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">didUserCallbackTimeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">expirationTime</span><span style="--s-dark:#666666;--s-light:#999999"> &lt;=</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ‰§è¡Œä»»åŠ¡ï¼Œä»»åŠ¡å¯èƒ½è¿”å›ä¸€ä¸ªå‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">continuationCallback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> callback</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">didUserCallbackTimeout</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      currentTime</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> getCurrentTime</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è¿”å›äº†å‡½æ•°ï¼Œåˆ™å½“å‰ä»»åŠ¡çš„ callback æ›´æ–°ä¸ºè¿™ä¸ªè¿”å›çš„å‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // ç„¶åè¿›è¡Œä¸‹ä¸€æ¬¡çš„è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> continuationCallback</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">function</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        currentTask</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">callback</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> continuationCallback</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è¿”å›éå‡½æ•°ï¼Œåˆ™è¡¨æ˜å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆäº†ï¼Œç›´æ¥å¼¹å‡º</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          pop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        }</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        advanceTimers</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      pop</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentTask</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">taskQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ä»»åŠ¡è¿˜æœ‰ï¼Œå³ä¸Šé¢çš„ while æå‰é€€å‡º</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ­¤æ—¶è¿”å› true ï¼Œè¡¨æ˜è¿˜æœ‰ä»»åŠ¡æœªå¤„ç†ï¼ŒperformWorkUntilDeadline é‡Œçš„ hasMoreWork ä¸º true</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è¿™æ ·ä¼šå†æ¬¡æ‰§è¡Œ schedulePerformWorkUntilDeadline ï¼Œåœ¨ä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ—¶æ‰§è¡Œ performWorkUntilDeadline å‡½æ•°ï¼Œæ„æˆä¸€ä¸ªå¾ªç¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentTask</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> peek</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timerQueue</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">firstTimer</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      requestHostTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handleTimeout</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> firstTimer</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentTime</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>åœ¨è¿™é‡Œé¢çš„é€»è¾‘ä¸­ï¼Œæœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œä¸€ä¸ªæ˜¯ <code>shouldYieldToHost</code> ä»¥åŠ <code>continuationCallback</code></p><p><code>shouldYieldToHost</code> ä¼šè®¡ç®—æ—¶é—´ç‰‡æ˜¯å¦æœ‰å‰©ä½™ï¼Œæœ‰çš„è¯å°±ä¼šç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œæ— å‰©ä½™å°±ä¼šç»“æŸå¾ªç¯</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> shouldYieldToHost</span><span style="--s-dark:#666666;--s-light:#999999">():</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> boolean</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeElapsed</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> getCurrentTime</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">startTime</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // frameInterval ä¸º 5ms ï¼Œå³æ—¶é—´ç‰‡é•¿åº¦</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeElapsed</span><span style="--s-dark:#666666;--s-light:#999999"> &lt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> frameInterval</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è¿™ä¸ª enableIsInputPending ç›®å‰æ˜¯ false ä¸ç®¡</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">enableIsInputPending</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">needsPaint</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeElapsed</span><span style="--s-dark:#666666;--s-light:#999999"> &lt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> continuousInputInterval</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isInputPending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#80A665;--s-light:#59873A"> isInputPending</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeElapsed</span><span style="--s-dark:#666666;--s-light:#999999"> &lt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> maxInterval</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isInputPending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#80A665;--s-light:#59873A"> isInputPending</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">continuousOptions</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è¿˜æ²¡åˆ°æ—¶é—´ç‰‡é•¿åº¦ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>ä¸­é—´è¿™ä¸€æ®µå…¶å®ç›®å‰å¯ä»¥ä¸ç®¡ï¼Œå› ä¸º <code>enableIsInputPending</code> è¿™ä¸ªé…ç½®ç›®å‰æ˜¯å…³é—­çš„</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/12/21/202212211704785.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/12/21/202212211704785.avif" alt=""></a></p><p>æ‰€ä»¥æ•´æ®µçš„é€»è¾‘å°±æ˜¯æ—¶é—´ç‰‡æ˜¯å¦æ¶ˆè€—å®Œ</p><p>ç„¶åæ˜¯ <code>continuationCallback</code> ï¼Œåœ¨è°ƒåº¦ä¸­ï¼Œå…¶å®æ˜¯æ‰§è¡Œå•ä½æ˜¯ä¸€ä¸ª <code>callback</code> ï¼Œè°ƒåº¦ç³»ç»Ÿåœ¨æ‰§è¡Œå®Œä¸€ä¸ª <code>callback</code> ä¹‹åæ‰èƒ½æ‰§è¡Œæ—¶é—´ç‰‡åˆ¤æ–­</p><p>è¿™ä¼šå¯¼è‡´å¦‚æœä¸€ä¸ª <code>callback</code> å¦‚æœæ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆè°ƒåº¦ç³»ç»Ÿå°±èµ·ä¸äº†ä½œç”¨äº†ï¼Œæ‰€ä»¥è¿™ä¸ª <code>continuationCallback</code> å¯ä»¥çœ‹æˆæš´éœ²ç»™è°ƒç”¨è€…çš„ä¸€ä¸ªæ¥å£</p><p>è°ƒç”¨è€…å¯ä»¥è‡ªè¡Œå¯¹ <code>callback</code> è¿›è¡Œåˆ†å‰²ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ <code>callback</code> ï¼Œç”¨äºä¸‹ä¸€è½®çš„è°ƒåº¦</p><p>åˆ°æ­¤ï¼Œæ ¸å¿ƒçš„ä»£ç å°±åŸºæœ¬è®²å®Œäº†ï¼Œæ•´ä¸ªæµç¨‹æˆ‘ä»¬å¯ä»¥æ€»ç»“å¦‚ä¸‹</p><p>åœ¨ä¸å¼•å…¥å»¶æ—¶ä»»åŠ¡è¿™ä¸ªæ¦‚å¿µçš„å‰æä¸‹ï¼Œå¯ä»¥å¾ˆç®€å•åœ°æ¦‚æ‹¬è°ƒåº¦æµç¨‹</p><p>æ¯æ¬¡é€šè¿‡ <code>MessageChannel</code> å¯åŠ¨è°ƒåº¦ï¼Œè°ƒåº¦çš„å†…å®¹ä¸ºï¼Œå¦‚æœå½“å‰æ—¶é—´ç‰‡è¿˜æœ‰å‰©ä½™ï¼Œåˆ™æ‹¿å‡ºè°ƒåº¦é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡æ‰§è¡Œï¼Œç›´åˆ°æ—¶é—´ç‰‡æ¶ˆè€—å®Œæˆæˆ–è€…è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º</p><p>å¦‚æœæ—¶é—´ç‰‡æ¶ˆè€—å®Œï¼Œä½†æ˜¯æ­¤æ—¶è°ƒåº¦é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆé‡æ–°å¯åŠ¨ä¸€ä¸ª <code>MessageChannel</code> å›è°ƒï¼Œç„¶åé‡å¤ä¸Šä¸€è¡Œçš„æµç¨‹</p><p>è€Œå»¶æ—¶ä»»åŠ¡ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆæ”¾å»¶æ—¶ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åæŠŠæœ€åº”è¯¥å…ˆè°ƒåº¦çš„å»¶æ—¶ä»»åŠ¡é€šè¿‡ <code>setTimeout</code> æ”¾å…¥è°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§ä¸Šé¢çš„æµç¨‹æ‰§è¡Œ</p><h1 id="åè®°" tabindex="-1">åè®° <a class="header-anchor" href="#åè®°">ğŸ”—</a></h1><p>è™½ç„¶ <code>scheduler</code> åŒ…å’Œ <code>react</code> çš„æ•´ä½“å…³ç³»ä¸å¤§ï¼Œä½†æ˜¯çœ‹èµ·æ¥å¯¹äºæˆ‘æ¥è¯´è¿˜æ˜¯æœ‰ä¸€äº›éš¾åº¦</p><p>å½“ç„¶ï¼Œé™¤äº†æ•´ä½“çš„é€»è¾‘ï¼Œè¿˜æœ‰ä¸€äº›å†™æ³•å¯ä»¥å­¦ä¹ ï¼Œæ¯”å¦‚ä»£ç é‡Œä¼šä¿å­˜ <code>setTimeout</code> ç­‰ä¸€äº›å®šæ—¶å™¨çš„å¼•ç”¨</p><p>ä¿è¯æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒåº¦ç³»ç»Ÿçš„ç¨³å®šæ€§</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">localSetTimeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> typeof </span><span style="--s-dark:#BD976A;--s-light:#B07D48">setTimeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> === </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">function</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? </span><span style="--s-dark:#BD976A;--s-light:#B07D48">setTimeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> : null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">localClearTimeout</span><span style="--s-dark:#666666;--s-light:#999999"> =</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  typeof </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearTimeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> === </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">function</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearTimeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> : null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">localSetImmediate</span><span style="--s-dark:#666666;--s-light:#999999"> =</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  typeof </span><span style="--s-dark:#BD976A;--s-light:#B07D48">setImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !== </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">undefined</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? </span><span style="--s-dark:#BD976A;--s-light:#B07D48">setImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> : null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span></code></pre></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#react</div><div>#react-scheduler</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/ce261f1dbe1d" class="" truncate="" title="ã€Šæœ¬æ˜¯ç¤¾ç•œçš„æˆ‘ã€‹"><i class="i-mi:chevron-left" mr-1=""></i><span>ã€Šæœ¬æ˜¯ç¤¾ç•œçš„æˆ‘ã€‹</span></a><a href="/84f2b2dfb381" class="" ml-auto="" truncate="" title="è®°ä¸€æ¬¡ VSCode Javaç±»å‹æ— æ³•è¢«è¯†åˆ«é—®é¢˜"><span>è®°ä¸€æ¬¡ VSCode Javaç±»å‹æ— æ³•è¢«è¯†åˆ«é—®é¢˜</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-93b0ae89="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-93b0ae89=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-93b0ae89=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-93b0ae89=""></i></div><div flex="~ col grow" gap-4="" data-v-93b0ae89=""><textarea disabled="" placeholder="ä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼Œç•™ä¸‹è¯„è®ºè¡Œä¸è¡Œ" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-93b0ae89=""></textarea><div flex="" items-start="" justify-between="" data-v-93b0ae89=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-93b0ae89="">æ”¯æŒ Markdown è¯­æ³• </a><button class="mujika-git-talk-button" cursor-pointer="" data-v-93b0ae89="">ç‚¹å‡»ç™»å½•</button></div></div></div><!--]--></div></div><!----><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">æ–‡ç« ç›®å½•</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT Â© Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">å¦‚æœæˆ‘å’Œç‹—ä¸€æ ·æœ‰å°¾å·´çš„è¯ï¼Œä¸€å®šä¼šè—ä¸ä½è¿™ä»½å–œæ‚¦ï¼Œè€Œå°¾å·´ä¸€ç›´æ‘‡ä¸ªä¸åœå§ã€‚</div></footer></div></div></body></html>