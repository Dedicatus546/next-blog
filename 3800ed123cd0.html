<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>恋の歌</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-D1RD9nfH.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-BmBo8YJO.css"><link rel="modulepreload" crossorigin="" href="/assets/JavaScript中的垃圾回收-D9GEI-gH.js"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">JavaScript中的垃圾回收</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2021-07-23 22:38</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2023-02-13 18:28</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/编程">编程</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">1.9K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">7 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><p><code>JavaScrip</code>中的垃圾回收。</p><p>本文参考如下的帖子</p><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/orphaned/Web/JavaScript/Memory_Management" target="_blank" rel="noopener">内存管理 | MDN</a></li><li><a href="http://newhtml.net/v8-garbage-collection/" target="_blank" rel="noopener">V8 之旅： 垃圾回收器</a></li><li><a href="http://www.jayconrod.com/posts/55/a-tour-of-v8-garbage-collection" target="_blank" rel="noopener">A tour of V8: Garbage Collection</a></li><li><a href="https://juejin.cn/post/6844903869525262349" target="_blank" rel="noopener">「前端进阶」JS 中的内存管理</a></li><li><a href="https://juejin.cn/post/6844903695721709581" target="_blank" rel="noopener">JS 垃圾回收机制笔记</a></li><li><a href="https://juejin.cn/post/6844904182512615432" target="_blank" rel="noopener">V8引擎详解（七）——垃圾回收机制</a></li></ul><h1 id="javascript-的内存管理" tabindex="-1">JavaScript 的内存管理 <a class="header-anchor" href="#javascript-的内存管理">🔗</a></h1><p>不同于<code>C</code>，<code>C++</code>的手动释放内存，<code>JavaScript</code>由引擎来为基本类型，对象，函数等来分配内存，分配内存这一块操作对用户完全透明，用户不用在意内存如何分配，分配到哪里，如何回收，这些都由引擎给做了。</p><p>由垃圾回收器来进行垃圾回收，减少了程序员的心智负担，但同时也减弱了对程序的控制程度，但总体上利大于弊。</p><h1 id="垃圾回收的目的" tabindex="-1">垃圾回收的目的 <a class="header-anchor" href="#垃圾回收的目的">🔗</a></h1><p>将不在被使用的内存释放掉，使得系统能够重新的使用这些内存来存放相关的变量</p><h1 id="垃圾回收算法" tabindex="-1">垃圾回收算法 <a class="header-anchor" href="#垃圾回收算法">🔗</a></h1><h2 id="引用计数" tabindex="-1">引用计数 <a class="header-anchor" href="#引用计数">🔗</a></h2><p>对象<code>A</code>能够通过自身去使用对象<code>B</code>，那么这个对象<code>A</code>就持有了对对象<code>B</code>的引用。</p><p>引用计数即通过判断对象是否被其他对象引用到来作为是否回首的依据。</p><p>如果一个对象没有被其他对象引用，那么这个对象应该被释放，因为已经没有其他的对象能够使用到该对象了，反之，就不应该释放该对象，避免未来的某个时刻被其他对象使用时造成错误。</p><p>缺点：存在循环引用的情况，当两个对象已经不能被其他任何对象引用但是这两个对象存在对对方的引用时，该垃圾回收算法无法对这两个对象进行回收，从而造成内存泄漏。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> f</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> o1</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {};</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  var</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> o2</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {};</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  o1</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">a</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> o2</span><span style="--s-dark:#666666;--s-light:#999999">;</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // o1 引用 o2</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  o2</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">a</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> o1</span><span style="--s-dark:#666666;--s-light:#999999">;</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // o2 引用 o1</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Hello World!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">f</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span></code></pre><p>当函数<code>f</code>执行完毕时，正常情况下应该释放对象<code>o1</code>与<code>o2</code>，但是算法发现两者仍然被其他对象引用，于是无法进行回收，造成了内存泄漏。</p><blockquote><p><code>MDN</code>上<code>内存管理</code>一章指出在<code>IE6</code>，<code>7</code>上使用引用计数来回收<code>DOM</code>对象，这种方式很容易造成内存泄漏。</p></blockquote><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> f</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> div</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">createElement</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">div</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  div</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">circleReference</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> div</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 挂载一个较大的数组，这样能够方便从内存占用上分析出来是否内存泄露了</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  div</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">lotsOfData</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Array</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">10000</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">join</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">*</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Hello World!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>如果<code>div</code>对象成功释放，那么属性<code>lotsOfData</code>应该也被释放，因为只有<code>div</code>引用了它，而实际上由于属性<code>circleReference</code>引用了自身，使得<code>div</code>的引用计数不为<code>0</code>（循环引用了），无法释放，导致属性<code>lotsOfData</code>也无法释放，造成内存泄漏。</p><h2 id="标记清除算法" tabindex="-1">标记清除算法 <a class="header-anchor" href="#标记清除算法">🔗</a></h2><p><a data-fancybox="doc-gallery" href="https://user-gold-cdn.xitu.io/2019/6/17/16b637393a752456?imageslim" target="_blank" rel="noopener noreferrer"><img src="https://user-gold-cdn.xitu.io/2019/6/17/16b637393a752456?imageslim" alt=""></a></p><p>通过一个“根”对象，去寻找能够访问到的全部的变量，然后把无法访问到的变量进行回收。</p><p>相比与引用计数，如果两个对象不再被其他对象引用，但是两者相互引用时，标记清除算法也能够鉴别出这两个对象应该被回收，因为从“根”对象已经无法达到这两个对象了。</p><p>它的有优点也是它的缺点，说成限制可能比较准确，即“那些无法从根对象查询到的对象都将被清除”。</p><p>标记清除算法已成为主流的<code>JavaScript</code>的垃圾回收算法，基于标记清除算法来改进垃圾回收。</p><h1 id="v8-堆的构成" tabindex="-1">v8 堆的构成 <a class="header-anchor" href="#v8-堆的构成">🔗</a></h1><p><a data-fancybox="doc-gallery" href="https://user-gold-cdn.xitu.io/2020/5/31/17269d61cb4ba88e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" target="_blank" rel="noopener noreferrer"><img src="https://user-gold-cdn.xitu.io/2020/5/31/17269d61cb4ba88e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></a></p><ul><li><p>新生代区 <code>New Space</code>。新生代分为两个区，一个是<code>from</code>区，一个是<code>to</code>区（相对而言），每次分配对象都会在<code>from</code>区分配，当内存将占满时，开始垃圾回收机制，把<code>from</code>区里面还被引用的对象拷贝到<code>to</code>区，然后新分配的对象开始放在<code>to</code>区，当<code>to</code>区也快占满时，就以同样的步骤转移到<code>from</code>，如此往复。新生代区的回收频率很快。新生代由副垃圾收集器（<code>Scavenging</code>）进行垃圾回收。 <a data-fancybox="doc-gallery" href="https://user-gold-cdn.xitu.io/2020/6/7/1728d89166b6a05b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" target="_blank" rel="noopener noreferrer"><img src="https://user-gold-cdn.xitu.io/2020/6/7/1728d89166b6a05b?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt=""></a></p></li><li><p>老生代区 <code>Old Space</code>。当位于新生代区的对象长时间留在新生代区时，<code>v8</code>会把这个对象搬到老生代中（<strong>晋升机制</strong>），然后隔一段时间也对老生代进行扫描，把已经无法可达的对象给释放掉。</p><p>晋升机制的条件：</p><ul><li>经历过一次副垃圾回收（<code>Scavenging</code>）算法，且并未被标记清除的，也就是过一次翻转置换操作的对象。</li><li>在进行翻转置换时，被复制的对象大于<code>to space</code>空间的<code>25%</code>。（<code>from space</code>和<code>to space</code>一定是一样大的）。</li></ul><p>晋升后的对象分配到老生代内存区，便由老生代内存区来管理。</p></li><li><p>大对象区 <code>Large Object Space</code>，专门存储大的对象，由于大对象的拷贝耗时，所以对大对象基本不移动。</p></li><li><p>代码区 <code>Code Space</code> 存放代码对象，最大限制为<code>512</code>MB，也是唯一拥有执行权限的内存。</p></li><li><p>单元区、属性单元区、Map 区 <code>Cell Space</code>、<code>Property Cell Space</code>、<code>Map Space</code>，<code>Map</code>空间存放对象的<code>Map</code>信息也就是隐藏类<code>Hiden Class</code>最大限制为<code>8</code>MB；每个<code>Map</code>对象固定大小，为了快速定位，所以将该空间单独出来。</p></li></ul><h1 id="如何查看是否内存泄漏" tabindex="-1">如何查看是否内存泄漏 <a class="header-anchor" href="#如何查看是否内存泄漏">🔗</a></h1><p>在<code>Chrome</code>浏览器，或者微软的<code>Edge</code>浏览器中，通过<code>F12</code>呼出开发者工具栏。</p><ul><li><p>打开开发者工具，选择<code>Performance</code>面板；</p><p>在 Edge 中，对应的中文面板为性能面板：</p><p><a data-fancybox="doc-gallery" href="https://z3.ax1x.com/2021/07/24/WybAtf.png" target="_blank" rel="noopener noreferrer"><img src="https://z3.ax1x.com/2021/07/24/WybAtf.png" alt=""></a></p></li><li><p>在顶部勾选<code>Memory</code>；</p></li><li><p>点击左上角的<code>record</code>按钮；</p><p>在<code>Edge</code>中，对应为左上角的记录按钮</p><p><a data-fancybox="doc-gallery" href="https://z3.ax1x.com/2021/07/24/WybJ9U.png" target="_blank" rel="noopener noreferrer"><img src="https://z3.ax1x.com/2021/07/24/WybJ9U.png" alt=""></a></p></li><li><p>点击记录后，在页面上进行各种操作，模拟用户的使用情况；</p></li><li><p>一段时间后，点击对话框的<code>stop</code>按钮，面板上就会显示这段时间的内存占用情况。</p><p><a data-fancybox="doc-gallery" href="https://z3.ax1x.com/2021/07/24/WyqnPK.png" target="_blank" rel="noopener noreferrer"><img src="https://z3.ax1x.com/2021/07/24/WyqnPK.png" alt=""></a></p></li></ul><p>在<code>Node</code>中，可以使用<code>process.memoryUsage</code>方法来查看内存使用情况。</p><blockquote><p><a href="https://nodejs.org/dist/latest-v14.x/docs/api/process.html#process_process_memoryusage" target="_blank" rel="noopener">process.memoryUsage() - Node.js 官方文档</a></p></blockquote><p><a data-fancybox="doc-gallery" href="https://z3.ax1x.com/2021/07/24/WyLPFP.png" target="_blank" rel="noopener noreferrer"><img src="https://z3.ax1x.com/2021/07/24/WyLPFP.png" alt=""></a></p><p>这个方法返回一个以字节为单位的描述内存情况的对象，属性值类型都为整型。</p><p>返回对象的属性如下：</p><ul><li><code>rss</code> 整个进程在内存中占用的大小，包括所有的<code>C++</code>对象，<code>JavaScript</code>对象以及代码；</li><li><code>heapTotal</code> 堆的大小；</li><li><code>heapUsed</code> 已使用堆的大小；</li><li><code>external</code> 存放绑定到由<code>v8</code>引擎管理的<code>JavaScript</code>的<code>C++</code>对象；</li><li><code>arrayBuffers</code> 分配给<code>ArrayBuffer</code>和<code>SharedArrayBuffer</code>对象的内存，即包括所有的<code>Buffer</code>对象，已包含在<code>external</code>的大小中。</li></ul><p>对于内存泄漏的判断，一般只需关注<code>heapUsed</code>和<code>heapTotal</code>即可。</p><h1 id="内存泄漏例子" tabindex="-1">内存泄漏例子 <a class="header-anchor" href="#内存泄漏例子">🔗</a></h1><h2 id="全局变量" tabindex="-1">全局变量 <a class="header-anchor" href="#全局变量">🔗</a></h2><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 意外定义了一个全局变量，可以使用window.a访问到它，无法被回收。</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  a</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 正确的做法使用关键字var，let，const定义变量再使用。</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // var a = 1;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // let a = 1;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // const a = 1;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">fn</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span></code></pre><h2 id="定时器" tabindex="-1">定时器 <a class="header-anchor" href="#定时器">🔗</a></h2><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> array</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> [</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  /*一个很大的数组*/</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">];</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 执行一些操作。</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 比如</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> div</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getElementById</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">div1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">div</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 使用array渲染</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>当定时器中<code>div</code>获取不到时，整个定时器失去了意义，但此时由于定时器没有被回收，而定时器又引用了<code>array</code>，导致<code>array</code>也无法被回收。</p><h2 id="闭包" tabindex="-1">闭包 <a class="header-anchor" href="#闭包">🔗</a></h2><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> str</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Array</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1000000</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">join</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">*</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      str</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">window</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">a</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">()();</span></span></code></pre><h2 id="dom-对象的引用" tabindex="-1">DOM 对象的引用 <a class="header-anchor" href="#dom-对象的引用">🔗</a></h2><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">var</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> elements</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  image</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getElementById</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">image</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> doStuff</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  elements</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">image</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">src</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">http://example.com/image_name.png</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> removeImage</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">body</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">removeChild</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getElementById</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">image</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 这个时候我们对于 #image 仍然有一个引用, Image 元素, 仍然无法被内存回收.</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/e06b336d1e34" class="" truncate="" title="HTTP知识笔记"><i class="i-mi:chevron-left" mr-1=""></i><span>HTTP知识笔记</span></a><a href="/01194d4ee87a" class="" ml-auto="" truncate="" title="DOM Event Architecture（DOM-Level-3）译文"><span>DOM Event Architecture（DOM-Level-3）译文</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-557c65bc="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-557c65bc=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-557c65bc=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-557c65bc=""></i></div><div flex="~ col grow" gap-2="" lg:gap-4="" data-v-557c65bc=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" h-4em="" lg:p-4="" lg:h-8em="" data-v-557c65bc=""></textarea><div flex="" items-start="" data-v-557c65bc=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-557c65bc="">支持 Markdown 语法</a><div ml-auto="" data-v-557c65bc=""></div><!----><button class="mujika-button" data-v-557c65bc="" data-v-15330f5f=""><!--[--><!--]--><!--[-->点击登录<!--]--></button></div></div></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-557c65bc="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" items-center="" justify-center="" data-v-557c65bc="">哦呢该，如果没有评论的话，瓦达西...</div><!----><!--]--></div></div><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-689781c6=""><div flex="" items-center="" data-v-689781c6=""><span data-v-689781c6="">由&nbsp;</span><i class="i-logos:vue" data-v-689781c6=""></i><span data-v-689781c6="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-689781c6=""></i><span data-v-689781c6="">&nbsp;驱动</span></div><div text-center="" data-v-689781c6=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-689781c6="">CC BY-NC-SA 4.0 </a>2021 - PRESENT © Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-689781c6="">如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。 - 《秒速五厘米》</div></footer></div></div></body></html>