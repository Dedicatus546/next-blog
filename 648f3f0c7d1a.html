<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>使用 canvas 来实现简单的批注功能</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-C7bQa6bS.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-C8PKLJNY.css"><link rel="modulepreload" crossorigin="" href="/assets/使用-canvas-来实现简单的批注功能-DJNJs9Qj.js"><meta property="og:title" content="使用 canvas 来实现简单的批注功能"><meta name="twitter:title" content="使用 canvas 来实现简单的批注功能"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">使用 canvas 来实现简单的批注功能</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2023-05-08 15:38</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2023-05-08 15:38</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/编程">编程</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">3.4K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">13 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言">🔗</a></h1><p>使用 canvas 来实现简单的批注功能。</p><p>最近，公司需要做（抄）一个和剪映相似的页面，<a href="https://www.capcut.cn/share/7225119904112973093" target="_blank" rel="noopener">点我直达</a>。</p><p>在剪映中，有一个批注的功能，能够对视频画面进行标注，效果如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/04/23/202304231418182.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/04/23/202304231418182.avif" alt=""></a></p><p>在经过我对 dom 的分析之后，我发现这个功能是经过 canvas 实现。</p><p>具体就是在视频容器的区域内套一个 <code>canvas</code> 元素，然后在上面绘制。</p><p>在这篇文章中，我们主要是分析如何画出指向和方框这两种批注。</p><h1 id="正文" tabindex="-1">正文 <a class="header-anchor" href="#正文">🔗</a></h1><h2 id="dom-结构" tabindex="-1">dom 结构 <a class="header-anchor" href="#dom-结构">🔗</a></h2><p>首先，我们先创建一个 <code>canvas</code> 节点，这里我们用 vue 项目来实现。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setup</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> lang</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">ts</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">HTMLCanvasElement</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">canvas</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">canvasRef</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> width</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1280</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> height</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">720</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">canvas</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">template</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>这里我们固定了宽高，当然实际上在 <code>resize</code> 事件（或者 <code>ResizeObserver</code> 观察器）时，我们可能需要重新设置 <code>canvas</code> 的宽高，这里我们简单处理。</p><p>接着我们要处理事件，这里我们主要需要三个事件，<code>mousedown</code> , <code>mousemove</code> 和 <code>mouseup</code> ，这里我们用了 <code>vueuse/core</code> ，主要是使用 <code>useEventListener</code> 这个组合式 api 。</p><p>这样我们可以专注于逻辑，而不用去在意事件的绑定与解绑。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setup</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> lang</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">ts</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> useEventListener</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vueuse/core</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">HTMLCanvasElement</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousedown</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousemove</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">mousedown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // TODO</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mouseup</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>接下来我们要考虑下存储的数据结构，在剪映中，数据结构如下：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">rect</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">arrow</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  from</span><span style="--s-dark:#666666;--s-light:#999999">: {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  to</span><span style="--s-dark:#666666;--s-light:#999999">: {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 一些其他的字段  </span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>当然，这里我们只保留一些核心的字段，在剪映中还有一些额外的字段，比如批注的颜色 <code>color</code> 字段，这里我们从简，统一使用 <code>#ff0000</code> 红色。</p><p>然后我们需要有两个变量来保存批注对象，其中一个为 <code>annotationList</code> ，保存已经不再变化的批注对象，另一个为 <code>currentAnnotationItem</code> ， 保存当前正在创建的批注对象</p><p>这里我们需要一些坐标相关的计算，需要使用 <code>vueuse/core</code> 的 <code>useElementBounding</code> 来获取 <code>canvas</code> 的盒子信息</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setup</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> lang</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">ts</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ref</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> useEventListener</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">@vueuse/core</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">rect</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">arrow</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  from</span><span style="--s-dark:#666666;--s-light:#999999">: {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  to</span><span style="--s-dark:#666666;--s-light:#999999">: {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 一些其他的字段</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">HTMLCanvasElement</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> annotationList</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">[]&gt;([]);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> ref</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  left</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  top</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  width</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasWidth</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  height</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasHeight</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> useElementBounding</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousedown</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ({</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#666666;--s-light:#999999"> }: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">MouseEvent</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 记录起始点信息</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    type</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">rect</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    from</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      x</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      y</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    to</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      x</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      y</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousemove</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ({</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#666666;--s-light:#999999"> }: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">MouseEvent</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">mousedown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 实时更新当前结束点坐标</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">assign</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mouseup</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ({</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#666666;--s-light:#999999"> }: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">MouseEvent</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">mousedown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    mousedown</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 记录结束点信息</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">assign</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      x</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      y</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    });</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 存到数组中</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    annotationList</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">assign</span><span style="--s-dark:#666666;--s-light:#999999">({},</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">script</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>现在我们已经得到了一个批注对象，接下来我们就需要将这个对象画到画布上面。</p><p>上面的代码中，在 <code>mousedown</code> 中使用了 <code>type = "rect"</code> 来初始化批注对象。</p><p>所以我们先来讲讲怎么画矩形标注。</p><h2 id="矩形标注" tabindex="-1">矩形标注 <a class="header-anchor" href="#矩形标注">🔗</a></h2><p>在 Canvas 的 2D 上下文中，已经有一个现成的绘制矩形的 API 了，即 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/strokeRect" target="_blank" rel="noopener">strokeRect(x, y, w, h)</a> 。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041118161.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041118161.avif" alt=""></a></p><p>这四个参数分别是，起始点的横坐标，起始点的纵坐标，矩形的宽，矩形的高。</p><p>这里我们可以看到剪映用的也是这个 API 。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041114792.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041114792.avif" alt=""></a></p><p>现在我们的代码中保存了 <code>currentAnnotationItem</code> 这个对象，这个对象里面有起始点坐标和结束点坐标。</p><p>所以 API 需要的四个参数我们都能通过计算得到，我们写一个 <code>drawRect</code> 函数来绘制 <code>currentAnnotationItem</code> 所表示的矩形。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">drawRect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ctx</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getContext</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2d</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">width</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">height</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">beginPath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">strokeStyle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">#ff0000</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">lineWidth</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">strokeRect</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> width</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> height</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">closePath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>然后我们在 <code>mousemove</code> 事件中加上对这个函数的调用</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousemove</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ({</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#666666;--s-light:#999999"> }: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">MouseEvent</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">mousedown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 实时更新当前结束点坐标</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">assign</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clientX</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clientY</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 绘制</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  drawRect</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span></code></pre><p>效果如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041150201.gif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041150201.gif" alt=""></a></p><p>可以发现现在的绘制存在两个问题：</p><ul><li>问题 1 ：每次绘制都会保留上次绘制的结果，导致显示错误。</li><li>问题 2 ：由于我们固定起始点 <code>from</code> 为 <code>strokeRect</code> 的头两个参数，导致当结束点 <code>to</code> 在 <code>from</code> 的左上角时会出现绘制错误。</li></ul><p>针对问题 1 ，我们需要在每次 <code>mousemove</code> 回调中的绘制前清除画布，我们实现一个 <code>clearCanvas</code> 函数，来清除画布上的当前内容。</p><p>清除画布的方法可以是调用 2D 上下文的 <code>clearRect</code> ，或者重新给 <code>canvas</code> 元素的宽高赋值，这里由于我们需要清空整个画布，所以用哪个都没差，这里我们使用后面的方法。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">clearCanvas</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">el</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">width</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">width</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">height</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> el</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">height</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>然后我们在 <code>mousemove</code> 中的 <code>drawRect</code> 之前调用一次 <code>clearCanvas</code> 。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">useEventListener</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">mousemove</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> ({</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientX</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clientY</span><span style="--s-dark:#666666;--s-light:#999999"> }: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">MouseEvent</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">mousedown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 实时更新当前结束点坐标</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">assign</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clientX</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasLeft</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">clientY</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasTop</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 清空画布</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearCanvas</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 绘制</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  drawRect</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span></code></pre><p>效果如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041557968.gif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041557968.gif" alt=""></a></p><p>可以看到现在不会出现重叠的情况了。</p><p>接下来我们开始解决问题 2 ，从上面的图可能看不出来问题 2 的症状，下面这个图就比较清晰了。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041600812.gif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041600812.gif" alt=""></a></p><p>在我们从右下往左上拖动的时候，矩形绘制的区域明显错误了。</p><p>这个问题的根本原因在于我们固定了 <code>currentAnnotationItem.from</code> 作为矩形的起始点。</p><p>绘制的时候我们总共会出现四个绘制方向，分别是：</p><ul><li>最常见的就是<strong>左上</strong>到<strong>右下</strong></li><li><strong>左下</strong>到<strong>右上</strong></li><li><strong>右上</strong>到<strong>左下</strong></li><li><strong>右下</strong>到<strong>左上</strong></li></ul><p>接着我们一个个分析。</p><p>1. <strong>左上</strong>到<strong>右下</strong></p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041628659.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041628659.avif" alt=""></a></p><p>很明显此时绘制矩形的顶点就是 <code>from</code> 的坐标，这个很容易看出来。</p><p>2. <strong>左下</strong>到<strong>右上</strong></p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041630662.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041630662.avif" alt=""></a></p><p>此时矩形的顶点是 <code>(from.x, to.y)</code> 。</p><p>3.<strong>右上</strong>到<strong>左下</strong></p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041635508.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041635508.avif" alt=""></a></p><p>此时矩形的顶点是 <code>(to.x, from.y)</code> 。</p><p>4.<strong>右下</strong>到<strong>左上</strong></p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041636564.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041636564.avif" alt=""></a></p><p>此时矩形的顶点是 <code>to</code> 的坐标。</p><p>经过分析之后，我们可以发现我们应该分别取 <code>from</code> 和 <code>to</code> 两者横纵坐标的较小值，这样绘制出来的矩形才是正确的</p><p>所以我们改动下 <code>drawRect</code> 代码</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">drawRect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ctx</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getContext</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2d</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">width</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">height</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">beginPath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">strokeStyle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">#ff0000</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">lineWidth</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">strokeRect</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 改动部分开始</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">min</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">min</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 改动部分结束</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    width</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    height</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  );</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">closePath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>经过修改之后，效果如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041646070.gif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041646070.gif" alt=""></a></p><p>现在矩形绘制基本上正确了</p><h2 id="箭头标注" tabindex="-1">箭头标注 <a class="header-anchor" href="#箭头标注">🔗</a></h2><p>这应该是本文最难的一个点了，在刚开始我也是不会的，不过我也是看了剪映里面的绘制代码，调试了很久才勉强懂得了过程。</p><p>这里我们先放一下剪映的代码。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041658300.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041658300.avif" alt=""></a></p><p>看起来还是相当复杂的，涉及了三角函数。</p><p>当然，这其中的基础是 2d 上下文的 <code>moveTo</code> , <code>lineTo</code> , <code>fill</code> API，分别是：</p><ul><li><code>moveTo(x, y)</code> 移动画笔到点 <code>(x, y)</code> 。</li><li><code>lineTo(x, y)</code> 从起始点到 <code>(x, y)</code> 连接一条路径。</li><li><code>fill()</code> 填充绘制路径围成的区域。</li></ul><p>在剪映的代码中，最后就是调用这 3 个 API 来绘制图形</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">t</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">prototype</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">draw</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">beginPath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fillStyle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> c</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">moveTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">l</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> l</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">b</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> b</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">f</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> f</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">w</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> w</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">E</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">X</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> E</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">fill</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">closePath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里的每个点就是箭头标注的点，总共 6 个点，即 7 条边。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041731755.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/04/202305041731755.avif" alt=""></a></p><p>那么我们现在就是要求出这 6 个点的坐标，其他就水到渠成了。</p><p>其中两个点其实我们已经得到了，分别是 <code>from</code> 和 <code>to</code> ，对应的代码为 <code>e.moveTo(l.x, l.y)</code> 和 <code>e.lineTo(f.x, f.y)</code> 。</p><p>我们可以把剪映的代码稍稍转换一下，如下：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">t</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">prototype</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">draw</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  d</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sqrt</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pow</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pow</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  h</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">min</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">.2</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> d</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 35</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  p</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> .7</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  y</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">atan</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  v</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">PI</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 4</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  m</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  g</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  b</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  w</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  _</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  E</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>首先变量 <code>d</code> 很容易看出来是计算点 <code>from</code> 和点 <code>to</code> 围成矩形的对角线的长度，这个公式是我们很熟悉的勾股定理 <code>z<sup>2</sup> = x<sup>2</sup> + y<sup>2</sup></code> 。</p><p>变量 <code>h</code> 和 <code>p</code> 分别是根据变量 <code>d</code> 计算的一个的长度，往下看，可以发现分别对应去计算了两个点的坐标，其中变量 <code>h</code> 对应变量 <code>b</code> 和变量 <code>w</code> ，变量 <code>p</code> 对应变量 <code>_</code> 和变量 <code>E</code> 。</p><p><code>y</code> 则是矩形的对角线和横向形成的对角线，即下图的角 <code>θ</code> 。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/06/202305061536206.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/06/202305061536206.avif" alt=""></a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Math/atan" target="_blank" rel="noopener">Math.atan()</a> 就是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Math/tan" target="_blank" rel="noopener">Math.tan()</a> 的“相反面”，它有一个专业的术语，叫反正切。</p><p>对于 <code>Math.tan()</code> ，传入角度，得到对边与领边的比值，而 <code>Math.atan()</code> 则是传入对边与领边的比值，得到角度。</p><p><code>v</code> 则是 <code>Math.PI</code> 的 1/4 ，<code>Math.PI</code> 表示 180° ， 1/4 也就是 45° 。</p><p><code>m</code> 和 <code>g</code> 则是用来补偿正负判断的。</p><p>接下来我们假设从左下移动到右上，且夹角为 30° ，此时正负补偿都是 1 ，我们可以忽略这两个变量。</p><p>我们以下半部分的箭头来分析，此时如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081000842.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081000842.avif" alt=""></a></p><p>接下来我们分析下下图中标的点，这里我们标为点 <code>t</code> 。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081031579.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081031579.avif" alt=""></a></p><p>结合代码可以发现，由于四个待求的点 <code>b</code>, <code>w</code>, <code>_</code>, <code>E</code> 都是通过目标点 <code>to</code> 来进行转化的，而此时点 <code>t</code> 的横纵坐标应该都要小于 <code>to</code> ，即 <code>to</code> 的横纵坐标都要减去某个值来得到点 <code>t</code> 。</p><p>那么此时可以排除 <code>b</code> 和 <code>_</code> ，剩下 <code>w</code> 和 <code>E</code> 。</p><p>在箭头的一边包含两个点，除了点 <code>t</code> ，还有一个 点 <code>l</code> ，如下图：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081036959.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081036959.avif" alt=""></a></p><p>那么 <code>w</code> 和 <code>E</code> 应该就对应了这两个点。</p><p>此时我们假设 <code>w</code> 对应点 <code>t</code> ，然后我们分析是否符合。</p><p>此时 <code>w</code> 的计算如下（正负补偿已忽略）：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">w</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  x</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  y</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>可以发现通过 <code>h</code> 来以及正余弦来得出偏移量，那么我们可以确此时 <code>h</code> 就是斜边，而 <code>h * Math.cos(v + y)</code> 和 <code>h * Math.sin(v + y)</code> 就是直角边。</p><p>那么我们可以得出此时构造的直角三角形应该如下图所示：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081042348.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081042348.avif" alt=""></a></p><p>此时<code>角 α + 角 β</code>的值即为 <code>y + v（45°）</code> ，所以 <code>h * Math.cos(v + y)</code> 得出了偏移量 <code>px</code> ，<code>h * Math.sin(v + y)</code> 得出了偏移量 <code>py</code> 。</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081045933.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081045933.avif" alt=""></a></p><p>那么 <code>t</code> 的坐标也就的出来了。</p><p>同理我们分析 <code>l</code> 坐标，我们可以同样构造三角形，但是我们发现角度额外减少了 <code>22.5°</code>， 即 <code>v（45°）/ 2</code> 。</p><p>以及使用 <code>p（ =0.7 * h ）</code> 来作为斜边，而不是 <code>h</code> ，此时我们把点 <code>l</code> 和 点 <code>to</code> 连接起来，此时两点的长度就是 <code>p</code> 。</p><p>我们直接上图，更容易理解：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081054398.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081054398.avif" alt=""></a></p><p>此时 <code>角 α + 角 β</code>的值即为 <code>y + v / 2（22.5°）</code> 。</p><p>其他的就和点 <code>t</code> 的计算过程一样了。</p><p>当然这里需要注意的是，<code>v</code> 的角度其实是可以自定义的，即如果你增大了 <code>v</code> 值，那么箭头顶部就会更加往外扩大，而如果你减小 <code>v</code> 值，那么箭头顶部就会往内收敛。</p><p>除此之外，<code>h</code> 和 <code>p</code> 也是可以自定义的，这两者决定了箭头的形状以及大小范围。</p><p>理解了计算过程后，我们就可以模仿（照抄）剪映写出 <code>drawArrow</code> 的代码了。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">drawArrow</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">ctx</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> canvasRef</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">getContext</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2d</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> currentAnnotationItem</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">d</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sqrt</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pow</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> + </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pow</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">h</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">min</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">d</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> * </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0.2</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 35</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">PI</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> / </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">4</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">atan</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> / </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">abs</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">p</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0.7</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> * </span><span style="--s-dark:#BD976A;--s-light:#B07D48">h</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">m</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> : -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">g</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> : -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">p1</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">p2</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> h</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">p3</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">p4</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    x</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">cos</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> m</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    y</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> *</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Math</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">sin</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> +</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> y</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> v</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> /</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">*</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> g</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  };</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">beginPath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fillStyle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">#ff0000</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">moveTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> from</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">p3</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p3</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">p1</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p1</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> to</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">p2</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p2</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">lineTo</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">p4</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">x</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> p4</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">y</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">fill</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ctx</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">closePath</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>然后我们可以看下效果图，如下：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081143286.gif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/05/08/202305081143286.gif" alt=""></a></p><p>相关的代码已经上传到我的<a href="https://github.com/Dedicatus546/annotation-canvas-vue-demo" target="_blank" rel="noopener">仓库</a>了，可以自行拉下来跑跑试试看。</p><p>当然，如果你想把代码放到业务中，可能还需要改一下，首先就是不能使用绝对值坐标来存，而应该使用百分比，因为每个人的屏幕分辨率可能不一样，这也是目前剪映的实现方法。</p><p>另外，也可以多自定义变量，比如颜色，方框的粗细等。</p><p>当然，标注的画布应该保持一个固定的长宽比，不然缩小屏幕可能会出现错位的情况。</p><h1 id="后记" tabindex="-1">后记 <a class="header-anchor" href="#后记">🔗</a></h1><p>三角函数不用真的都快忘光了，虽然从 0 到 1 我不是很行，但是从 0.99 到 1 我还是可以的😂。</p><p>目前也已经把剪映这个页面的功能都搬到了我们公司的项目上。</p><p>不过我挺讨厌抄的…</p><p>嘛，不过工作嘛，完成工作而已，不要想太多。</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#canvas</div><div>#批注</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/d174a34ab7a5" class="" truncate="" title="TypeScript 5.0（译）"><i class="i-mi:chevron-left" mr-1=""></i><span>TypeScript 5.0（译）</span></a><a href="/713d0a17c169" class="" ml-auto="" truncate="" title="2023年4月新番个人推荐"><span>2023年4月新番个人推荐</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-557c65bc="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-557c65bc=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-557c65bc=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-557c65bc=""></i></div><div flex="~ col grow" gap-2="" lg:gap-4="" data-v-557c65bc=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" h-4em="" lg:p-4="" lg:h-8em="" data-v-557c65bc=""></textarea><div flex="" items-start="" data-v-557c65bc=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-557c65bc="">支持 Markdown 语法</a><div ml-auto="" data-v-557c65bc=""></div><!----><button class="mujika-button" data-v-557c65bc="" data-v-15330f5f=""><!--[--><!--]--><!--[-->点击登录<!--]--></button></div></div></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-557c65bc="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" items-center="" justify-center="" data-v-557c65bc="">哦呢该，如果没有评论的话，瓦达西...</div><!----><!--]--></div></div><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-be8724f6=""><div flex="" items-center="" data-v-be8724f6=""><span data-v-be8724f6="">由&nbsp;</span><i class="i-logos:vue" data-v-be8724f6=""></i><span data-v-be8724f6="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-be8724f6=""></i><span data-v-be8724f6="">&nbsp;驱动</span></div><div text-center="" data-v-be8724f6=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-be8724f6="">CC BY-NC-SA 4.0 </a>2021 - PRESENT © Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-be8724f6="">如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。 - 《秒速五厘米》</div></footer></div></div></body></html>