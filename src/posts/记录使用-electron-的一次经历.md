---
title: >-
  è®°å½•ä½¿ç”¨ electron çš„ä¸€æ¬¡ç»å†
tags:
  - electron
  - vue
  - react
  - vuetify
  - ant-design-vue
categories:
  - ç¼–ç¨‹
date: 2024-11-06 18:26:39
updated: 2024-11-28 15:11:03
key: 1732777863
---


# å‰è¨€

è®°å½•ä½¿ç”¨ electron çš„ä¸€æ¬¡ç»å†ã€‚

<!-- more -->

å·²ç»å¿«ä¸€ä¸ªæœˆæ²¡æœ‰å†™å¸–å­äº†ï¼Œæ—¶é—´è¿‡çš„å¥½å¿«ï¼Œè½¬çœ¼å°±åˆåˆ°å¹´æœ«äº†ã€‚

ä¸€å·æ‰ä»è€å®¶å›åˆ°å¹¿å·ï¼Œæ­‡äº†å·®ä¸å¤šä¸€ä¸ªæœˆï¼Œè¿™æ®µæ—¶é—´ä¹Ÿæ˜¯ç”¨ electron + vue å¼€å‘äº†ä¸€ä¸ªæ¡Œé¢è½¯ä»¶ã€‚

é¡¹ç›® github åœ°å€ï¼š[jm-desktop](https://github.com/Dedicatus546/jm-desktop)

è¿™ç¯‡å¸–å­å°±è®°å½•ä¸‹è¿™ä¸€ä¸ªæœˆçš„è¿‡ç¨‹ã€‚

# æ­£æ–‡

## å‰æœŸå‡†å¤‡

é¦–å…ˆï¼Œåœ¨ç¼–å†™ä¹‹å‰ï¼Œåˆ†æäº†æ¥å£åŠ å¯†ä»¥åŠå›¾ç‰‡ç¼–ç çš„åŸç†ï¼Œè¿™éƒ¨åˆ†åœ¨ä¸‹é¢ä¸¤ç¯‡å¸–å­ä¸­ã€‚

- [è®°ä¸€æ¬¡åˆ†ææŸæ¼«æ¥å£å¯†é’¥](https://prohibitorum.top/202da2aab6d1)
- [è®°ä¸€æ¬¡åˆ†ææŸæ¼«çš„å›¾ç‰‡](https://prohibitorum.top/d5936495bfca)

## æŠ€æœ¯é€‰å‹

Web èœé¸¡ï¼Œä»€ä¹ˆ Qt ã€ winui éƒ½ä¸ä¼šï¼Œåªèƒ½ç”¨ electron æ¥åšå¥—å£³åº”ç”¨ï¼Œè¿™å¯¹æˆ‘æ¥è¯´ä¸Šæ‰‹æœ€å¿«ï¼Œå¹¶ä¸”å¯ä»¥å¿«é€Ÿå®ç°éœ€è¦çš„åŠŸèƒ½ã€‚

æœ€å¼€å§‹çš„æ—¶å€™é€‰æ‹©äº† electron + react + ant-design ï¼Œå†™åˆ°ä¸€åŠå‘ç° hold ä¸ä½ react ï¼Œå†™çš„å¤ªåˆ«æ‰­äº†ï¼Œæœæ–­æ¢æˆäº† electron + vue + ant-design-vue ï¼Œå†å†™åˆ°ä¸€åŠå‘ç° ant-design-vue å†™å‡ºæ¥åƒä¸€ä¸ªåå°ç®¡ç†ç³»ç»Ÿï¼Œå¹¶ä¸”ç¤¾åŒºç»´æŠ¤ä¸ç§¯æï¼Œæœæ–­è½¬åˆ° vuetify ä¸Šã€‚

æ‰€ä»¥æœ€åçš„æŠ€æœ¯æ ˆå°±æ˜¯ electron + vue ï¼Œç»„ä»¶åº“é€‰æ‹©äº† vuetify ã€‚ä»¥åŠä¸€äº›æ‚ä¸ƒæ‚å…«çš„åº“ã€‚

## éœ€æ±‚

å¯¹äºä¸€ä¸ªç¬¬ä¸‰æ–¹çš„æ¼«ç”» APP ï¼Œæ ¸å¿ƒçš„åŠŸèƒ½æˆ‘è§‰å¾—å°±ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æœç´¢ã€ä¸€ä¸ªæ˜¯æµè§ˆï¼Œç»†åˆ†ä¸‹æ¥å°±æ˜¯ï¼š

- æœç´¢é¡µ
- æ¼«ç”»è¯¦æƒ…é¡µ
- æ¼«ç”»é˜…è¯»é¡µ

å…¶ä»–éƒ½æ˜¯ç”œå¤´ï¼Œæ¯”å¦‚ä»€ä¹ˆé¦–é¡µï¼Œæ¯å‘¨æ¨èï¼Œè¯„è®ºï¼Œç”šè‡³ç™»å½•ï¼ˆé™¤ééœ€è¦ç™»å½•æ‰èƒ½æŸ¥çœ‹ï¼‰ç­‰ç­‰ã€‚

æ‰€ä»¥å½“æ—¶åŸºæœ¬ä¸Šæ˜¯å…ˆå®ç°è¿™äº›æ ¸å¿ƒçš„æ¨¡å—ã€‚

## ç›¸å…³èµ„æº

### é¡¹ç›®æ¨¡æ¿

ä½¿ç”¨ electron + vue ï¼Œè‡ªå·±æ­ç¯å¢ƒå°±å¤ªæ…¢äº†ï¼ˆ~~å¹¶ä¸æ˜¯æˆ‘ä¸ä¼š~~ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ¨¡æ¿ã€‚

é¡¹ç›®åœ°å€ï¼š [electron-vite-vue](https://github.com/electron-vite/electron-vite-vue)

electron-vite è¿™ä¸ªç»„ç»‡å¼€æºäº†å¤šä¸ªé¡¹ç›®ï¼ŒåŒ…æ‹¬å’Œ vue æˆ–è€… react é›†æˆçš„æ¨¡æ¿ï¼Œä»¥åŠå¼€ç®±å³ç”¨çš„ vite æ’ä»¶ï¼Œçœå»äº†è‡ªå·±æ­å»ºç›®å½•ï¼Œå¯¹äºæˆ‘è¿™ä¸ªä½“é‡çš„é¡¹ç›®å®Œå…¨å¤Ÿç”¨äº†ã€‚

ä½¿ç”¨ electron-vite-vue è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ electron ä¸»è¿›ç¨‹çš„ä»£ç ç›´æ¥å¯ä»¥ä½¿ç”¨ TypeScript ï¼Œå¤ªæ£’äº†ã€‚

### ç»„ä»¶åº“

è¿™é‡Œé€‰ç”¨äº† [vuetify](https://vuetifyjs.com/zh-Hans/getting-started/installation/#section-5b8988c5) ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäº material çš„ç»„ä»¶åº“ï¼Œç»„ä»¶å…¨é¢ï¼ˆä¸è¿‡ material æ„Ÿè§‰å’Œå›½å†…çš„å®¡ç¾æ°´åœŸä¸æœï¼Œçœ‹å¤šäº†å›½å†…çš„ app ï¼Œå†çœ‹è°·æ­Œç³»çš„æ€»æ„Ÿè§‰åˆ°äº†å¦ä¸€ä¸ªæ¬¡å…ƒï¼‰ã€‚

é…åˆ [unplugin-vue-components](https://github.com/unplugin/unplugin-vue-components) æ’ä»¶å®Œæˆè‡ªåŠ¨å¯¼å…¥ï¼Œçœç•¥å¾ˆå¤š import è¯­å¥ ã€‚

```javascript
// vite.config.ts
import { Vuetify3Resolver } from "unplugin-vue-components/resolvers";
import component from "unplugin-vue-components/vite";


export default defineConfig({
  // ...
  plugins: [
    // ...
    component({
      resolvers: [Vuetify3Resolver()],
    }),
  ],
});
```

å¯åŠ¨ä¹‹åä¼šç”Ÿæˆ `components.d.ts` æ–‡ä»¶ï¼Œæ³¨æ„è¦å°†å®ƒåŠ å…¥åˆ° TypeScript ä¸­ï¼Œè¿™æ ·å¯ä»¥å¾—åˆ°æ¨¡æ¿ä¸­çš„ç±»å‹æç¤ºã€‚

```json
// tsconfig.json
{
  // ...
  "include": [
    "src/**/*.ts",
    "src/**/*.tsx",
    "src/**/*.vue",
    "electron",
    "auto-imports.d.ts",
    "components.d.ts"
  ],
}
```

PSï¼šä¹‹å‰åœ¨ä½¿ç”¨ ant-design-vue çš„æ—¶å€™ï¼Œå‘ç°äº†ä¸€ä¸ª bug ï¼Œä½†æ˜¯æäº¤åˆ°äº† issue ä¸Šè¿˜æ²¡ä¿®ï¼ˆè™½ç„¶æˆ‘ä¹Ÿä¸ç¡®å®šåˆ°åº•æ˜¯ bug è¿˜æ˜¯ç‰¹æ€§ï¼‰ï¼Œæœç„¶è¿˜æ˜¯å¾—æœ‰å®˜æ–¹çš„å›¢é˜Ÿçš„ç»„ä»¶åº“æ‰æ¯”è¾ƒå¯ä¿¡...

è¿™é‡Œè´´ä¸Š issue åœ°å€ï¼š[the args of notification.useNotification does not work](https://github.com/vueComponent/ant-design-vue/issues/7875) ã€‚

ä¹Ÿä¸çŸ¥é“è¦å¤šä¹…æ‰èƒ½å¤„ç†è¿™ä¸ª issue ...

### åŸå­ css

è¿™é‡Œä½¿ç”¨äº† [unocss](https://unocss.dev/guide/) æ¥ç”Ÿæˆ css ç±»ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ä¸€äº›å·¥å…·ç±»ï¼Œä½¿ç”¨è¾ƒå¤šçš„æ˜¯ flex ç›¸å…³çš„ã€‚

é¦–å…ˆè¦åœ¨ vite ä¸­æ·»åŠ  unocss æ’ä»¶ã€‚

```javascript
// vite.config.ts
import unocss from "unocss/vite";

export default defineConfig({
  // ...
  plugins: [
    // ...
    unocss(),
  ],
});
```

ç„¶åé¢å¤–åˆ›å»ºä¸€ä¸ª `uno.config.ts` æ–‡ä»¶ã€‚

```javascript
// uno.config.ts
import { defineConfig, presetWind } from "unocss";

export default defineConfig({
  presets: [presetWind()],
  rules: [
    [
      "app-region-drag",
      {
        "-webkit-app-region": "drag",
      },
    ],
    [
      "app-region-nodrag",
      {
        "-webkit-app-region": "no-drag",
      },
    ],
  ],
});
```

è¿™é‡Œæˆ‘ä»¬é…ç½®äº† tailwind è§„åˆ™ï¼Œä»¥åŠå¤šç”Ÿæˆäº†ä¸¤ä¸ªç±»ï¼Œä¸»è¦æ˜¯æ¥å¿«é€Ÿå¤„ç†å¤´éƒ¨éƒ¨åˆ†æ˜¯å¦èƒ½å¤Ÿæ‹–åŠ¨çš„æƒ…å†µã€‚

æœ€ååœ¨ `main.ts` ä¸­å¯¼å…¥ `uno.css` å³å¯

```javascript
// src/main.ts
import "virtual:uno.css";

// ...
```

### æ¥å£è¯·æ±‚

ä»¥å¾€åŸºæœ¬ä¸Šéƒ½æ˜¯ç”¨ axios çš„ï¼Œè¿™æ¬¡ç”¨äº† [alova](https://alova.js.org/zh-CN/) ï¼Œå®ƒé™„å¸¦çš„åŠŸèƒ½æ›´å¤šï¼Œè€Œä¸”å†…ç½®äº† useRequest ã€ usePagination çš„ç»„åˆå¼ api ï¼Œå¤§å¤§å‡å°‘äº†å¾ˆå¤šæ ·æ¿ä»£ç ï¼Œå¾ˆæ£’ï¼Œä»¥åŠæä¾›äº†æ¥å£ç¼“å­˜ï¼Œè¿™æ ·å­åœ¨æŸäº›æ¥å£ä¸Šå¼€å¯ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘æ¥å£è°ƒç”¨æ¬¡æ•°ï¼Œåˆ‡æ¢é¡µé¢çš„ä½“éªŒä¸Šå‡å¾ˆå¤šã€‚

alova å’Œ axios åœ¨æŸç§æƒ…å†µä¸‹è¿˜æ˜¯å¾ˆåƒçš„ï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªè¯·æ±‚å®ä¾‹ï¼Œç”¨è¿™ä¸ªå®ä¾‹æ¥å‘èµ· Get ã€Post ç­‰è¯·æ±‚ã€‚

```typescript
// src/apis/http.ts
import { xhrRequestAdapter } from "@alova/adapter-xhr";
import { createAlova } from "alova";
import vueHook from "alova/vue";

const http = createAlova({
  statesHook: vueHook,
  requestAdapter: xhrRequestAdapter(),
  baseURL: "/api",
  beforeRequest(method) {
    // ...
  },
  responded: {
    async onSuccess(response, method) {
      // ...
    },
  },
});
```

è¿™é‡Œ `onSuccess` å°±å’Œ axios ä¸­çš„æ‹¦æˆªå™¨å·®ä¸å¤šï¼Œ `beforeRequest` åœ¨è¯·æ±‚å‰æ·»åŠ ä¸€äº›å…¨å±€çš„è¯·æ±‚å¤´ï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨äº† `xhrRequestAdapter` ï¼Œå³åŸºäº XMLHttpRequest å°è£…çš„é€‚é…å™¨ï¼Œç”±äº fetch é€‚é…å™¨ä¸æ”¯æŒè·å–ä¸Šä¼ ä¸‹è½½è¿›åº¦ï¼Œè€ŒåŠŸèƒ½é‡Œé¢æœ‰ä¸‹è½½æ¼«ç”»ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ `xhrRequestAdapter` ã€‚ `vueHook` åˆ™è®© alova èƒ½å¤Ÿåœ¨ setup ä¸­ä½¿ç”¨ç»„åˆå¼çš„ api ï¼Œè¿™é‡Œç”¨çš„æœ€å¤šçš„å°±æ˜¯ `useRequest` å’Œ `usePagination` ï¼Œç‰¹åˆ«æ˜¯ `usePagination` ç›¸å½“çš„æ–¹ä¾¿ï¼Œå¾ˆå¤šçš„åˆ—è¡¨é¡µéƒ½åªè¦ä¸€ä¸ª `usePagination` å°±èƒ½æ‹¿åˆ°å¤§éƒ¨åˆ†çš„çŠ¶æ€ã€‚

æ¥ç€æˆ‘ä»¬åªéœ€è¦ç¼–å†™ç›¸åº”çš„ä¸šåŠ¡è¯·æ±‚å³å¯ï¼Œæ¯”å¦‚ï¼š

```typescript
// src/apis/ajax.ts
export const loginApi = (username: string, password: string) => {
  const formData = new FormData();
  formData.append("username", username);
  formData.append("password", password);
  return http.Post<
    RespWrapper<{
      uid: number;
      username: string;
      email: string;
      avatar: string;
      jCoin: number;
      level: [number, string];
      currentExp: number;
      nextLevelExp: number;
      collectCount: number;
      maxCollectCount: number;
    }>,
    RespWrapper<{
      uid: string;
      username: string;
      email: string;
      emailverified: string;
      photo: string;
      fname: string;
      gender: string;
      message: string;
      coin: number;
      album_favorites: number;
      s: string;
      level_name: string;
      level: number;
      nextLevelExp: number;
      exp: string;
      expPercent: number;
      badges: unknown[];
      album_favorites_max: number;
      ad_free: boolean;
      ad_free_before: unknown;
      charge: string;
      jar: string;
    }>
  >("login", formData, {
    transform(res) {
      return {
        code: res.code,
        data: {
          uid: Number.parseInt(res.data.uid),
          username: res.data.username,
          email: res.data.email,
          avatar: res.data.photo,
          jCoin: res.data.coin,
          level: [res.data.level, res.data.level_name],
          currentExp: Number.parseInt(res.data.exp),
          nextLevelExp: res.data.nextLevelExp,
          collectCount: res.data.album_favorites,
          maxCollectCount: res.data.album_favorites_max,
        },
      };
    },
  });
};
```

è¿™é‡Œæœ‰ä¸¤ä¸ªæ³¨æ„çš„ç‚¹

ä¸€ä¸ªæ˜¯å°è£…çš„æ—¶å€™ä¸è¦æ·»åŠ  async ï¼Œå³ `loginApi` ä¸è¦åŠ  async ï¼Œä¸ç„¶ setup å†…ä¼ å…¥ `useRequest` å’Œ `usePagination` ä¼šæç¤ºç±»å‹é”™è¯¯ï¼ŒåŸå› æ˜¯ `http.Post` è¿”å›çš„æ˜¯ä¸€ä¸ª `Method` ç±»å‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±» Promise è€Œä¸æ˜¯ Promise ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è°ƒç”¨ `loginApi('username', 'password')` æ˜¯ä¸ä¼šå‘èµ·è¯·æ±‚çš„ï¼Œåªæœ‰ `loginApi('username', 'password').then()` æ‰ä¼šã€‚

å¦ä¸€ä¸ªæ˜¯ `http.Post` çš„ä¸¤ä¸ªæ³›å‹åˆ†åˆ«æ˜¯è½¬æ¢åç±»å‹ä»¥åŠè½¬æ¢å‰ç±»å‹ï¼Œå¦‚æœæ¥å£éœ€è¦è¿›è¡Œæ•°æ®è½¬åŒ–çš„è¯ï¼Œå¡«å†™è¿™ä¸¤ä¸ªç±»å‹å¯ä»¥åœ¨ `transform` å†…è·å¾—è‰¯å¥½çš„ç±»å‹æç¤ºï¼Œå¦‚æœä¸éœ€è¦è½¬åŒ–åˆ™ç›´æ¥ç¼–å†™ç¬¬ä¸€ä¸ªæ³›å‹å³å¯ã€‚

åœ¨ setup ä¸­ï¼Œä½¿ç”¨ `usePagination` å¯ä»¥è·å–ç»å¤§éƒ¨åˆ†çš„çŠ¶æ€ï¼š

```html
<script setup lang="ts">
import { usePagination } from "alova/client";
import { getComicListApi } from "@/apis";

const { 
  total,        // æ€»æ¡æ•°
  page,         // å½“å‰é¡µç 
  pageSize,     // æ¯é¡µå¤§å°
  pageCount,    // æœ‰å¤šå°‘é¡µ
  data,         // åˆ—è¡¨æ•°æ®
  send,         // å‘èµ·è¯·æ±‚å‡½æ•°
  loading       // åŠ è½½çŠ¶æ€
} = usePagination(
  (page) =>
    getComicListApi({
      page,
      content: formState.content,
      order: formState.order,
    }),
  {
    // é»˜è®¤èµ·å§‹é¡µå’Œé¡µå¤§å°
    initialPage: 1,
    initialPageSize: 80,
    // è¿™é‡Œ data å’Œ total å°±æ˜¯è¿”å› data å’Œ total æ‰€æ‹¿åˆ°çš„å€¼
    data: (res) => res.data.content,
    total: (res) => res.data.total,
    // è¿™é‡Œå¯ä»¥è®¾ç½®é¢å¤–çš„å‚æ•°ï¼Œè¿™æ · formState.order å˜åŒ–æ—¶ä¼šç›´æ¥é‡æ–°å‘èµ·è¯·æ±‚
    watchingStates: [() => formState.order],
  },
);
</script>
```

### ä¸»è¿›ç¨‹çš„ ioc

æ—¢ç„¶æ˜¯è‡ªå·±å†™çš„é¡¹ç›®ï¼Œé‚£å°±å¾—ç©ç©ä¸€äº›å¹³æ—¶ç”¨ä¸ä¸Šçš„ä¸œè¥¿ã€‚

æ‰€ä»¥è¿™æ¬¡æˆ‘åœ¨é¡¹ç›®é‡Œé¢ä½¿ç”¨äº†å¾®è½¯çš„ä¾èµ–æ³¨å…¥åº“ [tsyringe](https://github.com/microsoft/tsyringe) ã€‚

è¿™æ˜¯ä¸€ä¸ªè½»é‡çš„ IOC åº“ï¼Œç”¨æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå’Œ spring å¾ˆç›¸ä¼¼ã€‚

é¦–å…ˆæˆ‘ä»¬è¦åœ¨ `tsconfig.json` å†…å¼€å¯è£…é¥°å™¨æ”¯æŒã€‚

```json
{
  // ...
  "compilerOptions": {
    // ...
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,
  }
}
```

æ¥ç€æˆ‘ä»¬è¿˜è¦å®‰è£…ä¸€ä¸ª `reflect-metadata` ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹ Reflect çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¯ä»¥è®©å¯¹è±¡å­˜å‚¨å…ƒæ•°æ®ï¼Œåœ¨å…¥å£å¤„ç›´æ¥å¯¼å…¥å³å¯ã€‚

```typescript
// electron/main.ts
import "reflect-metadata";

// ...
```

æ¥ç€æˆ‘ä»¬ç»™æ¨¡å—åŠ ä¸Š `@singleton` è£…é¥°å™¨

```typescript
import { singleton } from "tsyringe";

@singleton()
export class PathService {
  // ...
}
```

è¿™é‡Œä½¿ç”¨ `singleton` è€Œä¸æ˜¯ `injectable` çš„åŸå› æ˜¯ `injectable` æ¯æ¬¡æ³¨å…¥éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œ `singleton` åªä¼šæœ‰ä¸€ä¸ªå¯¹è±¡ã€‚

è¦æ³¨æ„è¿™æ ·åªæ˜¯æ³¨å†Œäº†è¿™ä¸ªç±»ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥è¿è¡Œå®¹å™¨å†…æ˜¯ä¸ä¼šæœ‰è¿™ä¸ªç±»çš„å®ä¾‹çš„ï¼Œå¦‚æœæƒ³è¦è®©ç±»åˆå§‹åŒ–å®ä¾‹ï¼Œåˆ™éœ€è¦è°ƒç”¨å¦ä¸€ä¸ª API ã€‚

```typescript
// electron/main.ts
import { container } from "tsyringe";
import { PathService } from "./modules/path";

// åˆå§‹åŒ–
const instance = container.resolve(PathService);
```

æ‰€ä»¥æ•´ä¸ª electron ä¾§çš„é€»è¾‘å°±æ˜¯åœ¨ `electron/modules` ä¸‹ç¼–å†™æ¨¡å—ï¼Œç„¶ååœ¨ `electron/main.ts` è°ƒç”¨ win æ¨¡å—æ¥åˆå§‹åŒ–æ•´ä¸ªåº”ç”¨ï¼Œä¸è¿‡è¿™é‡Œç›®å‰è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼Œå°±æ˜¯æŸäº›æ¨¡å—å¹¶ä¸ä¼šå’Œ win æ¨¡å—å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œé€šå¸¸åªä¼šé€šè¿‡ ipcMain æ¥ç›‘å¬ä¸€äº›äº‹ä»¶ç„¶åå¤„ç†ï¼Œè¿™é‡Œç”¨çš„ä¸€ä¸ªæ–¹æ³•æ˜¯æ³¨å…¥ä½†ä¸ä½¿ç”¨

```typescript
import { inject, singleton } from "tsyringe";
import { DbService } from "../db";

@singleton()
export class WinService {
  //...

  constructor(
    // @ts-expect-error inject dbService
    @inject(DbService) private dbService: DbService,
  ) {
    // ...
  }
}
```

è¿™é‡Œè¦åŠ è¿™ä¸ªæ³¨é‡Šï¼Œä¸ç„¶ TypeScript ä¼šæŠ¥é”™ã€‚

æˆ–è®¸è¿™é‡Œæ”¹æˆæ‰«æ `electron/modules` ä¸‹çš„æ¨¡å—å¹¶ä¸”ç›´æ¥ `container.resolve` ä¼šæ›´å¥½ï¼ŸğŸ¤”

### better-sqlite3

åœ¨ç¼–å†™ä¸‹è½½åŠŸèƒ½çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªè½»é‡çš„æ•°æ®åº“ï¼Œè¿™é‡Œé€‰ç”¨äº† sqlite ã€‚

è¿™é‡Œæä¸€å˜´è¿™ä¸ªæ˜¯å¯èƒ½åœ¨å¼€å‘æˆ–è€…æ‰“åŒ…ä¼šæŠ¥é”™ï¼Œæç¤º nodeï¼ˆæˆ–å…¶ä»–ï¼‰ ç‰ˆæœ¬ä¸æ­£ç¡®é—®é¢˜ã€‚

è¿™æ—¶éœ€è¦ä½¿ç”¨æ‰§è¡Œ `electron-builder install-app-deps` æ¥è®²ä¾èµ–é‡æ–°ç¼–è¯‘ä¸ºå½“å‰ç¯å¢ƒçš„ç‰ˆæœ¬

å¯ä»¥åœ¨ `package.json` æ·»åŠ  `postinstall` æ¥è®© `pnpm i` å®Œæˆåè§¦å‘

```json
{
  // ...
  "scripts": {
    // ...
    "postinstall": "electron-builder install-app-deps"
  },
}
```

### å¿«é€Ÿå¼•å…¥å­—ä½“

è¿™é‡Œå¯ä»¥ä½¿ç”¨ [Fontsource](https://github.com/fontsource/fontsource) ã€‚

è¿™ä¸ªä»“åº“æ”¶å½•äº†å¼€æºå¯å•†ç”¨çš„å­—ä½“ï¼Œå¯ä»¥åœ¨[æ­¤å¤„](https://fontsource.org/?query=roboto)æœç´¢ç›¸åº”çš„å­—ä½“ã€‚

å¯¼å…¥ä¹Ÿéå¸¸ç®€å•ï¼Œå®‰è£…å¯¹åº”çš„å­—ä½“æ–‡ä»¶ï¼Œç„¶åå¯¼å…¥å³å¯ã€‚

```bash
pnpm install @fontsource/roboto
```

å¼•å…¥ï¼š

```typescript
// src/main.ts

import "@fontsource/roboto";
```

ç„¶ååœ¨éœ€è¦çš„åœ°æ–¹ä½¿ç”¨å³å¯ã€‚

```css
body {
  font-family: 'Roboto', sans-serif;
}
```

### Express ä»£ç†æ¥å£

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œåº”ç”¨ä¼šåœ¨ä¸»è¿›ç¨‹å¯åŠ¨ä¸€ä¸ª Express å®ä¾‹ï¼Œæ¥ä»£ç†ç›¸å…³çš„æ¥å£ã€‚

```typescript
// æ ¸å¿ƒä»£ç 
const app = Express();

app.use(
  "/api",
  createProxyMiddleware({
    target: config.target,
    changeOrigin: true,
    secure: false,
    pathRewrite: {
      "^/api": "",
    },
  }),
);
```

ç”±äºæ¥å£åœ¨å¤§é™†å¹¶ä¸æ€»æ˜¯èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªä»£ç†å¯ç”¨ä¸€ä¸ªâ€œæ¢¯å­â€

åšæ³•å°±æ˜¯é…ç½®å®ƒçš„ `agnet` å±æ€§ã€‚

å…ˆå®‰è£… `https-proxy-agent` ï¼Œè¡¨æ˜æˆ‘ä»¬æƒ³ä»£ç†ä¸€ä¸ª https åŸŸåï¼ˆè¿™é‡Œè¦æ ¹æ®éœ€è¦é€‰æ‹© `http-proxy-agent` æˆ–è€… `https-proxy-agent` ï¼‰ã€‚

ä½¿ç”¨å¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š

```typescript
import { HttpsProxyAgent } from "https-proxy-agent";

// æ ¸å¿ƒä»£ç 
const app = Express();

app.use(
  "/api",
  createProxyMiddleware({
    target: config.target,
    agent: new HttpsProxyAgent("http://localhost:10809")
    changeOrigin: true,
    secure: false,
    pathRewrite: {
      "^/api": "",
    },
  }),
);
```

è¿™é‡Œçš„ `http://localhost:10809` å°±æ˜¯ä»£ç†æœåŠ¡çš„åŸŸåï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ [v2rayN](https://github.com/2dust/v2rayN) ï¼Œæ‰€ä»¥è¿™é‡Œé»˜è®¤å°±æ˜¯ `http://localhost:10809` ã€‚

è‡³äºä»£ç†çš„è¿™äº›ä¿¡æ¯ï¼Œå°±é€šè¿‡æ¸²æŸ“è¿›ç¨‹çš„ç”¨æˆ·å¡«å†™åæ‹¿åˆ°ã€‚

### æ¸²æŸ“è¿›ç¨‹ä½¿ç”¨ä»£ç†

é™¤äº† Express ï¼Œåœ¨æ¸²æŸ“è¿›ç¨‹ä¸­æˆ‘ä»¬éœ€è¦è®¿é—®ç¬¬ä¸‰æ–¹çš„å›¾ç‰‡ï¼Œåœ¨ç½‘ç»œä¸å¥½çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ä»£ç†è¿›è¡ŒåŠ é€Ÿï¼Œè¿™é‡Œéœ€è¦å¯¼å…¥ electron çš„ `session` ï¼Œç„¶åä½¿ç”¨ [setProxy](https://www.electronjs.org/docs/latest/api/structures/proxy-config) è¿™ä¸ªæ–¹æ³•ã€‚

```javascript
import {
  // ...
  session,
} from "electron";

session.defaultSession.setProxy({
  // é»˜è®¤å°±ä¸º fixed_servers 
  // éœ€è¦è®¾ç½® proxyRules æ‰èƒ½ç”Ÿæ•ˆ
  mode: "fixed_servers",
  proxyRules: "http://localhost:10809",
});
```

è¿™æ ·è®¾ç½®ä¹‹åæ¸²æŸ“è¿›ç¨‹çš„è¯·æ±‚å°±ä¼šèµ°è¿™ä¸ªä»£ç†ã€‚

### ç¼©æ”¾

electron æä¾›ç»™äº†æˆ‘ä»¬ä¸€ä¸ª `win.webContents.setZoomFactor(zoomFactor)` æ¥è®¾ç½®ç¼©æ”¾å› å­

ä½†æ˜¯è¦æ³¨æ„ï¼Œè¿™ä¸ªåŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ˜¯æ²¡æ³•æ”¹å˜çš„ï¼Œè¿™é‡Œéœ€è¦å…ˆè°ƒç”¨ `win.webContents.setVisualZoomLevelLimits(1, 3)` åå†è°ƒç”¨ `win.webContents.setZoomFactor(zoomFactor)` æ‰èƒ½æˆåŠŸç¼©æ”¾ï¼Œè¿™é‡Œå½“æ—¶å¡äº†å¾ˆä¹…...

```typescript
// å¿…é¡»å…ˆè°ƒç”¨ setVisualZoomLevelLimits è§£é™¤ç¼©æ”¾é™åˆ¶
win.webContents.setVisualZoomLevelLimits(1, 3).then(() => {
  win.webContents.setZoomFactor(zoomFactor);
});
```

### è®°å½•ç”¨æˆ·çª—å£ä½ç½®

æ ¸å¿ƒçš„ API æ˜¯ `win.getBounds()` å¯ä»¥è·å–çª—å£å½“å‰çš„ä½ç½®å’Œå¤§å°ï¼Œæˆ‘ä»¬åªéœ€åœ¨é€€å‡ºå‰å°†ä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°ï¼Œç„¶åä¸‹æ¬¡å¯åŠ¨å‰è¯»å–è¿™ä¸ªä¿¡æ¯è®¾ç½®ä½ç½®å’Œå¤§å°å³å¯ã€‚

```typescript
// ä¿å­˜
const rect = win.getBounds();
writeToLocal(rect);


// è¯»å–
const rect = getFromLocal('bounds');
const win = (this.win = new BrowserWindow({
  // ...
  x: rect.x,
  y: rect.y,
  width: rect.width,
  height: rect.height,
}));
```

### ä½¿ç”¨å·¥ä½œæµ

å› ä¸ºä»“åº“æ˜¯åœ¨ github ä¸Šå¼€æºçš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å·¥ä½œæµæ¥å¸®æˆ‘ä»¬æ‰“å¤šä¸ªç¯å¢ƒçš„åŒ…ã€‚

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæœ‰ä¸¤ä¸ªå·¥ä½œæµï¼Œä¸€ä¸ªæ˜¯ç›‘å¬ tag æ¨é€ç„¶åæ ¹æ® tag æ‰“åŒ…ï¼Œä¸€ä¸ªæ˜¯æ‰‹åŠ¨è§¦å‘çš„æœ€æ–°æ‰“åŒ…ã€‚

ç›‘å¬ tag åªéœ€è¦å¦‚ä¸‹é…ç½®ï¼š

```yml
on:
  push:
    tags:
      - 'v*.*.*'  # åªåœ¨ç‰ˆæœ¬æ ‡ç­¾æ¨é€æ—¶è§¦å‘
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `npm version major|minor|patch` å‘½ä»¤æ¥æ›´æ–°ç‰ˆæœ¬ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªæäº¤ï¼Œåœ¨è¿™ä¸ªæäº¤ä¸Šé¢æ ‡ä¸Šä¸€ä¸ª tag ã€‚

![](https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/11/12/20241112213139986.avif)

æ¥ç€æˆ‘ä»¬ `git push && git push origin v1.9.0` æ¥æŠŠè¿™ä¸ª tag æäº¤åˆ°è¿œç¨‹å°±å¯ä»¥è§¦å‘ä¸Šé¢çš„å·¥ä½œæµäº†ã€‚

æ‰‹åŠ¨è§¦å‘çš„åˆ™éœ€è¦ä½¿ç”¨å¦‚ä¸‹é…ç½®

```yml
on:
  workflow_dispatch:
```

è¿™æ ·åœ¨ Actions é¡µé¢å°±æœ‰ä¸€ä¸ªæŒ‰é’®å¯ä»¥å¯åŠ¨å·¥ä½œæµäº†ã€‚

![](https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/11/12/20241112213514897.avif)

ä¸€èˆ¬ä½¿ç”¨å·¥ä½œæµçš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šæ˜¯åœ¨ linux ä¸Šè·‘çš„ï¼Œä½†æ˜¯ electron çš„æ‰“åŒ…æ˜¯éœ€è¦åœ¨å¯¹åº”ç³»ç»Ÿä¸Šæ‰“å¯¹åº”ç³»ç»Ÿçš„åŒ…çš„ï¼Œå³ linux åªèƒ½æ‰“ linux çš„åŒ…ï¼Œè€Œ windows åªèƒ½æ‰“ windows çš„åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸‹ï¼Œè®©å·¥ä½œæµè·‘ä¸¤ä¸ªç¯å¢ƒï¼Œæ ¸å¿ƒå°±æ˜¯ä¸‹é¢è¿™ä¸ªé…ç½®ã€‚

```yml
jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
```

è¿™æ ·å­å°±ä¼šæœ‰ä¸¤ä¸ªä»»åŠ¡åœ¨è·‘ã€‚

![](https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/11/12/20241112213813927.avif)

ç„¶åæŸäº›æ­¥éª¤å¦‚æœéœ€è¦æŒ‡å®šåªåœ¨æŸä¸ªç¯å¢ƒè·‘ï¼Œå¯ä»¥åœ¨æ­¥éª¤ä¸Šç”¨ä¸€ä¸ª if è¯­æ³•ï¼Œæ¯”å¦‚å¦‚æœè¦ç¼“å­˜ pnpm çš„åŒ…çš„è¯ï¼Œåœ¨ window ä¸Šçš„è·¯å¾„å’Œ linux ä¸Šçš„è·¯å¾„ä¸ä¸€æ ·ï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ª step ã€‚

```yml
jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Cache Linux pnpm
        # åªåœ¨ linux ä¸Šæ‰§è¡Œè¿™ä¸ªæ­¥éª¤
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-
      
      - name: Cache Windows pnpm
        # åªåœ¨ windows ä¸Šæ‰§è¡Œè¿™ä¸ªæ­¥éª¤
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: D:\.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-
```

æœ€åï¼Œå¦‚æœæ˜¯åŸºäº tag çš„æ¨é€çš„ï¼Œå¯ä»¥å€ŸåŠ© electron-builder è‡ªåŠ¨æäº¤åˆ° release ä¸Šã€‚

```yml
jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      # ...
      - name: Build Electron App
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: pnpm run build
```

è¿™é‡Œè®°å¾—è¦æ³¨å…¥ `GH_TOKEN` ï¼Œè¿™æ ·æ‰èƒ½æ¨é€æˆåŠŸï¼Œ`pnpm run build` å®é™…ä¸Šè¿è¡Œäº† `vite build && electron-builder --publish always` è¿™é‡Œè‡ªåŠ¨æ¨é€å°±æ˜¯ `--publish always` èµ·ä½œç”¨ã€‚

è€Œå¦‚æœæ˜¯åŸºäºæœ€æ–°çš„æ‰“åŒ…ï¼Œåˆ™éœ€è¦æŒ‡å®š `--publish` ä¸º `never` ï¼Œç„¶åå€ŸåŠ©å·¥ä½œæµ Artifacts æš‚å­˜æ–‡ä»¶ï¼Œå°†æ‰“åŒ…åçš„æ–‡ä»¶ä¸Šä¼ åˆ°è¿™é‡Œå³å¯ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨ `actions/upload-artifact` ã€‚

```yml
jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      # ...
      - name: Upload Linux Artifacts
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          # é€šè¿‡ github.sha æ¥åŒºåˆ†æ–‡ä»¶
          name: linux-release-assets-${{ github.sha }}
          path: release/*/jm-desktop-Linux-*.zip
  
      - name: Upload Windows Artifacts
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          # é€šè¿‡ github.sha æ¥åŒºåˆ†æ–‡ä»¶
          name: windows-release-assets-${{ github.sha }}
          path: release/*/jm-desktop-Windows-*.zip
```

# åè®°

è™½ç„¶å¯åŠ¨æ…¢äº†ç‚¹ï¼Œä½†æ˜¯åŠŸèƒ½ä¸Šè¿˜æ˜¯ç›¸å½“å®Œæ•´çš„ï¼Œè‡ªå·±è¿˜æ˜¯éå¸¸å¼€å¿ƒèƒ½å¤Ÿå®Œæˆè¿™ä¸ªé¡¹ç›®ã€‚

~~è™½ç„¶åœ¨ä¸èµ·çœ¼çš„åœ°æ–¹æœ‰å¾ˆå¤š bug ã€‚~~

~~åœ¨ä¿®äº†åœ¨ä¿®äº†ï¼Œæ–°å»º fix åˆ†æ”¯ã€‚~~