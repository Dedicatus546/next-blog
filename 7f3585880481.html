<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RxJS æºç è§£è¯»ä¹‹ Scheduler</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-4gPi1Ho2.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-afYcuv6x.css"><link rel="modulepreload" crossorigin="" href="/assets/RxJS-æºç è§£è¯»ä¹‹-Scheduler-DiPjyeCk.js"><meta property="og:title" content="RxJS æºç è§£è¯»ä¹‹ Scheduler"><meta name="twitter:title" content="RxJS æºç è§£è¯»ä¹‹ Scheduler"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="æ‹ã®æ­Œçš„logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="è‡ªåŠ¨" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="æ—¥é—´" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="å¤œé—´" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">RxJS æºç è§£è¯»ä¹‹ Scheduler</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">å‘è¡¨äº</span><span pl-1="">2023-10-26 18:26</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">æ›´æ–°äº</span><span pl-1="">2023-11-04 01:12</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">åˆ†ç±»äº</span><!--[--><a pl-1="" href="/category/ç¼–ç¨‹">ç¼–ç¨‹</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">æ€»å­—æ•°</span><span pl-1="">7.4K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">é˜…è¯»æ—¶é•¿ â‰ˆ</span><span pl-1="">27 åˆ†é’Ÿ</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€">ğŸ”—</a></h1><p>RxJS æºç è§£è¯»ä¹‹ <code>Scheduler</code> ã€‚</p><p>åœ¨å‰é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è®²äº† RxJS æ ¸å¿ƒçš„å‡ ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸”åˆ†æäº†å®ƒä»¬æºç ä¸­çš„å®ç°ã€‚</p><p>æœ¬æ–‡æˆ‘ä»¬è®² RxJS ä¸­å¦ä¸€ä½ç»´åº¦çš„ä¸œè¥¿ï¼Œå®ƒç§°ä¹‹ä¸º Scheduler ã€‚</p><h1 id="æ­£æ–‡" tabindex="-1">æ­£æ–‡ <a class="header-anchor" href="#æ­£æ–‡">ğŸ”—</a></h1><h2 id="æ¦‚å¿µ" tabindex="-1">æ¦‚å¿µ <a class="header-anchor" href="#æ¦‚å¿µ">ğŸ”—</a></h2><p>Scheduler ï¼Œåœ¨è‹±æ–‡ä¸­çš„æ„æ€ä¸ºè°ƒåº¦å™¨ï¼Œä¸€å¬åˆ°è°ƒåº¦å™¨æˆ‘ä»¬å¯èƒ½å°±æœ‰ç‚¹å®³æ€•äº†ï¼Œè·Ÿè¿™ä¸œè¥¿æœ‰å…³çš„éƒ½æ˜¯è®©äººå¤´ç–¼çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ Linux å†…æ ¸ä¸­çš„è°ƒåº¦å™¨ï¼Œç”¨æ¥è°ƒåº¦è¿›ç¨‹ã€‚</p><p>åœ¨ RxJS ä¸­ï¼Œè°ƒåº¦å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µï¼Œä»–å…¶å®å®Œå…¨å¯ä»¥å•ç‹¬æ‹å‡ºæ¥ä½¿ç”¨ã€‚ RxJS çš„è°ƒåº¦å™¨ï¼Œæœ¬è´¨å°±æ˜¯å†³å®šå‡½æ•°æ‰§è¡Œçš„æ—¶æœºã€‚</p><p>å†ç®€å•ç‚¹è®²ï¼Œå®ƒå…¶å®å°±æ˜¯åŒ…è£…äº†è¯¸å¦‚ <code>setInterval</code> ã€ <code>Promise.then</code> ã€ <code>requestAnimateFrame</code> ç­‰çš„ API ã€‚</p><h2 id="æºç " tabindex="-1">æºç  <a class="header-anchor" href="#æºç ">ğŸ”—</a></h2><h3 id="scheduler-å’Œ-action" tabindex="-1">Scheduler å’Œ Action <a class="header-anchor" href="#scheduler-å’Œ-action">ğŸ”—</a></h3><p>åœ¨ RxJS ä¸­ï¼Œè°ƒåº¦å™¨æœ‰ä¸¤ä¸ªæ ¸å¿ƒçš„åŸºç±»ï¼Œä¸€ä¸ªæ˜¯ <code>Scheduler</code> ã€ ä¸€ä¸ªæ˜¯ <code>Action</code> ã€‚</p><p>è¿™ä¸¤ä¸ªåŸºç±»çš„å®ç°éƒ½éå¸¸çš„ç®€å•ï¼Œæºç å¦‚ä¸‹ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Scheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> implements</span><span style="--s-dark:#80A665;--s-light:#59873A"> SchedulerLike</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> static</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dateTimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">private</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> schedulerActionCtor</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Action</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> now</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ ¸å¿ƒå‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedulerActionCtor</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ ¸å¿ƒå‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ° <code>Action</code> å®ç°äº† <code>Subscription</code> ï¼Œä¹Ÿå°±æ˜¯ <code>Action</code> åº”è¯¥ä¹Ÿæœ‰ä¸€ä¸ªå–æ¶ˆè®¢é˜…çš„æ“ä½œï¼Œè¿™ä¸ªåé¢ä¼šè¯´åˆ°ï¼Œè€Œ <code>Scheduler</code> å®ç°äº† <code>SchedulerLike</code> æ¥å£ï¼Œè¿™ä¸ªæ¥å£æŠ½è±¡äº†ç±»è°ƒåº¦å™¨çš„ç±»å‹ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> SchedulerLike</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> TimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  now</span><span style="--s-dark:#666666;--s-light:#999999">():</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œçš„ <code>TimestampProvider</code> å¯ä»¥å…ˆå¿½ç•¥ï¼Œåœ¨ <code>Scheduler</code> çš„æºç ä¸­ï¼ŒåŸºæœ¬ç”¨ä¸åˆ°è¿™ä¸ªå±æ€§ã€‚</p><p>å›åˆ° <code>Scheduler</code> ç±»ï¼Œ<code>Scheduler</code> ä¼šé€šè¿‡æ„é€ å‡½æ•°æŒæœ‰ä¸€ä¸ª <code>Action</code> çš„ç±»ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ˜¯æŒæœ‰ä¸€ä¸ª <code>Action</code> ç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª <code>Action</code> ç±»çš„å®ä¾‹ï¼‰ï¼Œç„¶ååœ¨ <code>schedule</code> ä¸­å®ä¾‹åŒ–æŒæœ‰çš„ <code>Action</code> ç±»ï¼Œ å³ä»£ç ä¸­çš„ <code>new this.schedulerActionCtor&lt;T&gt;(this, work)</code> ï¼Œæ¥ç€è°ƒç”¨ <code>Action</code> çš„ <code>schedule</code> å¹¶è¿”å›è‡ªèº«ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ <code>Action</code> ç»§æ‰¿è‡ª <code>Subscription</code> ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨é€šè¿‡ <code>Scheduler.prototype.schedule</code> å¾—åˆ°çš„å¯¹è±¡å…¶å®å°±æ˜¯ä¸€ä¸ª <code>Action</code> å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç”¨ç®­å¤´æ¥æè¿°æ­¤æ—¶çš„è°ƒç”¨æµå‘ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-text"><span class="line"><span>Scheduler.schedule</span></span>
<span class="line"><span>-&gt; new Action</span></span>
<span class="line"><span>-&gt; Action.schedule</span></span></code></pre><p>éœ€è¦ç€é‡æ³¨æ„çš„æ˜¯ï¼šæˆ‘ä»¬çš„è°ƒåº¦å‡½æ•°ï¼ˆ <code>work</code> ï¼‰æ˜¯ä¿å­˜åœ¨ <code>Action</code> ä¸­çš„ï¼Œè¿™ç‚¹å¾ˆé‡è¦ã€‚</p><p>åœ¨ RxJS ä¸­ï¼Œæä¾›äº†å››ç§ä¸åŒçš„è°ƒåº¦å™¨ï¼Œåˆ†åˆ«æ˜¯ <code>asyncScheduler</code> ã€ <code>asapScheduler</code> ã€ <code>queueScheduler</code> ã€ <code>animationFrameScheduler</code> ï¼Œéœ€è¦æ³¨æ„ï¼Œè¿™äº›å¯¼å‡ºçš„å¯¹è±¡å·²ç»æ˜¯ç±»çš„å®ä¾‹äº†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¸èƒ½é€šè¿‡ <code>new</code> æ¥è°ƒç”¨ã€‚æ¯”å¦‚ <code>asyncScheduler</code> ï¼Œå®ƒçš„å¯¼å‡ºæ˜¯ä¸‹é¢è¿™æ ·å­çš„ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>å…¶ä¸­ <code>AsapScheduler</code> ã€ <code>QueueScheduler</code> å’Œ <code>AnimationFrameScheduler</code> éƒ½æ˜¯ä» <code>AsyncScheduler</code> æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>AsyncScheduler</code> çš„å®ç°ã€‚</p><h3 id="asyncscheduler-å’Œ-asyncaction" tabindex="-1">AsyncScheduler å’Œ AsyncAction <a class="header-anchor" href="#asyncscheduler-å’Œ-asyncaction">ğŸ”—</a></h3><p><code>AsyncScheduler</code> çš„å®ç°æœ¬è´¨å°±æ˜¯åŒ…è£…äº† <code>setInterval</code> ã€‚æˆ‘ä»¬å…ˆçœ‹ <code>AsyncScheduler</code> çš„æ•´ä½“å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æŒæœ‰çš„ Action å®ä¾‹ï¼Œå…ˆä¸ç®¡</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Array</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> [];</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦çš„è¿‡ç¨‹æ˜¯å¦åœ¨æ‰§è¡Œä¸­</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _active</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æœ€è¿‘ä¸€æ¬¡è°ƒåº¦å¯¹åº”çš„ id ï¼Œå¯èƒ½æ˜¯ setInterval ã€ setInterval æˆ–è€… requestAnimationFrame çš„è¿”å›å€¼</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _scheduled</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æŒæœ‰ Action ç±»</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Action</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> now</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ° <code>AsyncScheduler</code> å¹¶æ²¡æœ‰é‡å†™ <code>Scheduler</code> çš„ <code>schedule</code> ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨ <code>schedule</code> çš„æ—¶å€™è¿˜æ˜¯è°ƒç”¨çš„ <code>Scheduler</code> çš„ <code>schedule</code> å®ç°ã€‚ <code>AsyncScheduler</code> è¿˜å¤šäº†ä¸€ä¸ª <code>flush</code> æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸ç®¡ã€‚</p><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹ <code>AsyncAction</code> çš„å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦å¯¹åº”çš„ id ï¼Œåœ¨è¿™é‡ŒæŒ‡ setInterval è¿”å›çš„å€¼</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦çš„ä¸Šä¸‹æ–‡ï¼Œé€šä¿—ç‚¹è®²å°±æ˜¯å›è°ƒçš„å…¥å‚</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è°ƒåº¦å»¶è¿Ÿçš„æ—¶é—´ï¼Œå¯ä»¥ç†è§£ä¸ºä¼ é€’ç»™ setInterval çš„ç¬¬äºŒä¸ªå‚æ•°</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ˜¯å¦å¤„äºè°ƒåº¦è¿‡ç¨‹ä¸­</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> pending</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // scheduler ä¸ºè¯¥å®ä¾‹å¯¹åº”çš„ Scheduler å®ä¾‹</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // work ä¸ºæŒæœ‰çš„è°ƒåº¦å‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> _execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>çœ‹èµ·æ¥å¤šäº†å¥½å¤šæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»é‡å†™çš„ <code>Action</code> çš„ <code>schedule</code> æ–¹æ³•çš„ä½ç½®å¼€å§‹ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å·²ç»å–æ¶ˆè®¢é˜…äº†</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ›´æ–°å‚æ•°ï¼Œåé¢å…¥å‚ä¼šæ›¿æ¢</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¾—åˆ°è°ƒåº¦å¯¹åº”çš„ id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¯¥ Action å¯¹åº”çš„ Scheduler å®ä¾‹</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // éç¬¬ä¸€æ¬¡è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // é‡æ–°å¾—åˆ°ä¸€ä¸ªå®šæ—¶å™¨ id </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è¿™é‡Œå¯èƒ½ä¼šé‡æ–°è¯·æ±‚ä¸€ä¸ªæ–°çš„ id ï¼Œå³ç±»ä¼¼è°ƒç”¨ clearInterval ç„¶åå†è°ƒç”¨ setInterval</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æˆ–è€…å¤ç”¨åŸæœ¬çš„ id ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬åŒ…è£…çš„æ˜¯ setInterval</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è°ƒåº¦å³å°†å¼€å§‹ï¼Œè¿›å…¥è°ƒåº¦ç­‰å¾…çŠ¶æ€</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ›´æ–°è°ƒåº¦çš„å»¶è¿Ÿæ—¶é—´</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿™é‡Œçš„ delay æ”¾åœ¨åé¢æ›´æ–°æ˜¯å› ä¸ºä¸Šé¢çš„ recycleAsyncId ä¼šæ¯”è¾ƒæ–°æ—§çš„ delay å€¼æ¥åšä¸€äº›æ“ä½œ</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ²¡æœ‰è°ƒåº¦çš„è¯è°ƒç”¨ requestAsyncId æ¥å¼€å§‹è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ??</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿”å›è‡ªèº«ï¼Œå› ä¸ºè‡ªèº«å°±æ˜¯ä¸€ä¸ª Subscription</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œæœ‰å‡ ä¸ªé‡è¦çš„ç‚¹ï¼š</p><ul><li>é€šè¿‡ <code>Scheduler</code> çš„ <code>schedule</code> æ¥è°ƒç”¨ï¼Œæ¯ä¸ª <code>Action</code> åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœæƒ³è·å¾—ç±»ä¼¼ <code>setInterval</code> çš„æ•ˆæœï¼Œéœ€è¦æ‰‹åŠ¨åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ <code>this.schedule</code> æ¥é‡æ–°è°ƒç”¨ã€‚</li></ul><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// åªæ‰§è¡Œä¸€æ¬¡</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">hello world!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ç±»ä¼¼ setInterval </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">hello world!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ‰‹åŠ¨é‡æ–°è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}),</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><ul><li>åœ¨ <code>AsyncScheduler</code> å†…éƒ¨ä¸­ä½¿ç”¨çš„æ˜¯ <code>setInterval</code> è€Œé <code>setTimeout</code> ä½œä¸ºåº•å±‚å®ç°ï¼Œå¯¹æ­¤ RxJS å®˜æ–¹çš„è§£é‡Šæ˜¯ï¼š å•ä¸ª <code>setInterval</code> çš„æ‰§è¡Œé—´éš”æ¯”èµ·å¤šä¸ª <code>setTimeout</code> çš„é—´éš”æ›´ç²¾ç¡®ã€‚</li></ul><blockquote><p>However, JS runtimes and timers distinguish between intervals achieved by serial <code>setTimeout</code> calls vs. a single <code>setInterval</code> call. An interval of serial <code>setTimeout</code> calls can be individually delayed, which delays scheduling the next <code>setTimeout</code>, and so on. <code>setInterval</code> attempts to guarantee the interval callback will be invoked more precisely to the interval period, regardless of load.</p></blockquote><ul><li>æ‰€æœ‰çš„ <code>Scheduler</code> åœ¨å†…éƒ¨éƒ½ä¸ä¼šè‡ªåŠ¨è°ƒç”¨ <code>unsubscribe</code> æ¥å–æ¶ˆè‡ªèº«çš„è®¢é˜…ï¼Œè¿™æ˜¯å› ä¸ºå³ä½¿åœ¨å¤šæ¬¡çš„è°ƒåº¦ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€šè¿‡é¢å¤–çš„å®šæ—¶å™¨æ¥å¯åŠ¨è°ƒåº¦ï¼Œæ¯”å¦‚ï¼š</li></ul><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ä¸‹é¢çš„è°ƒåº¦åœ¨ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œä¸­</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // åŒæ­¥çš„ä»£ç æ— æ³•ç¡®è®¤â€œæœªæ¥â€æ˜¯å¦ä¼šè¢«é‡æ–°è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>æ‰€ä»¥å¦‚æœä½ åªæƒ³æ‰§è¡Œå•æ¬¡çš„è°ƒåº¦ï¼Œæœ€å¥½åœ¨è°ƒåº¦å‡½æ•°æ‰§è¡Œç»“æŸåè°ƒç”¨ <code>unsubscribe</code> ï¼Œæˆ–è€…å¯¹è¿”å›çš„å¯¹è±¡åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ <code>unsubscribe</code> ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscription</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function </span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ä¸‹é¢çš„è°ƒåº¦åœ¨ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œä¸­</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // åŒæ­¥çš„ä»£ç æ— æ³•ç¡®è®¤â€œæœªæ¥â€æ˜¯å¦ä¼šè¢«é‡æ–°è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ... ä¸€äº›æ“ä½œ</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å–æ¶ˆè®¢é˜…</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">  this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ... ä¸€äº›æ“ä½œ</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// åœ¨åˆé€‚çš„æ—¶æœºå–æ¶ˆè®¢é˜…</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">subscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span></code></pre><p>å›åˆ° <code>schedule</code> å®ç°ä¸­ï¼Œæˆ‘ä»¬å‘ç°å®ƒä¸»è¦å…³è”äº†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯ <code>requestAsyncId</code> ï¼Œä¸€ä¸ªæ˜¯ <code>recycleAsyncId</code> ï¼Œæ ¹æ®åå­—æˆ‘ä»¬å¤§è‡´å¯ä»¥çŸ¥é“ï¼Œ <code>requestAsyncId</code> åº”è¯¥å°±æ˜¯è¯·æ±‚è°ƒåº¦ï¼Œç„¶åè¿”å›ä¸€ä¸ªè¯¥è°ƒåº¦çš„ id ï¼Œè€Œ <code>recycleAsyncId</code> å¤§è‡´æ˜¯å›æ”¶ä¸€ä¸ªè°ƒåº¦ï¼Œè¿™é‡Œçš„å›æ”¶å¯ä»¥æ˜¯å–æ¶ˆè°ƒåº¦å™¨æˆ–è€…è®©è°ƒåº¦å™¨ç»§ç»­æ‰§è¡Œï¼ˆä»€ä¹ˆéƒ½ä¸åšï¼‰ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ <code>requestAsyncId</code> ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨çš„ä¸æ˜¯åŸç”Ÿçš„ <code>setInterval</code> ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ª <code>intervalProvider</code> å¯¹è±¡ä¸Šçš„ <code>setInterval</code> ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>intervalProvider</code> çš„å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">IntervalProvider</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">handler</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearInterval</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">)(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  delegate</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>å¯ä»¥å‘ç°é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯è°ƒç”¨çš„ <code>setInterval</code> ï¼Œä½†æ˜¯ RxJS æä¾›äº†ä¸€ä¸ª <code>delegate</code> å§”æ´¾å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ¥è¦†ç›–é»˜è®¤çš„å®ç°ï¼Œæ¯”å¦‚ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // åœ¨æ¯ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå†æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">((...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">handler</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">)), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å½“ç„¶å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸ä¼šå»è¦†ç›–é»˜è®¤çš„å®ç°ï¼Œæ‰€ä»¥ <code>requestAsyncId</code> å¯ä»¥ç®€å•é‡å†™ä¸ºï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°å®ƒçš„ç›®æ ‡è°ƒåº¦å‡½æ•°æ˜¯ <code>Scheduler</code> çš„ <code>flush</code> ï¼Œè¿™å¯èƒ½å°±æœ‰ç‚¹è®©äººä¸è§£äº†ï¼Œä¸æ˜¯è¯´éœ€è¦è°ƒåº¦çš„å‡½æ•°ä¿å­˜åœ¨äº† <code>Action</code> ä¸Šå—ï¼Œæ€ä¹ˆåˆè·‘å»è°ƒç”¨ <code>Scheduler</code> çš„æ–¹æ³•äº†ï¼Œåˆ«æ€¥ï¼Œæˆ‘ä»¬å…ˆçœ‹ <code>recycleAsyncId</code> æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¤ç”¨</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¸…é™¤æ‰</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™æ®µé€»è¾‘ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯å¤ç”¨å®šæ—¶å™¨ï¼Œå³ä¸æ¸…é™¤å®šæ—¶å™¨ï¼Œå¦ä¸€ä¸ªå°±æ˜¯æ¸…é™¤å®šæ—¶å™¨äº†ï¼Œåœ¨å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ <code>Action</code> ä¸­è°ƒç”¨ <code>work</code> æ˜¯å•æ¬¡çš„ï¼Œå¦‚æœéœ€è¦é‡å¤è°ƒåº¦ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨çš„åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ <code>this.schedule</code> æ¥é‡æ–°è°ƒåº¦ã€‚åœ¨åˆ¤æ–­ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåªè¦å»¶è¿Ÿæ—¶é—´ç›¸åŒï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ¸…é™¤æ‰å®šæ—¶å™¨ï¼Œå³ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule before.</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¤ç”¨è°ƒåº¦å™¨</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">  this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>ç†è§£äº†è¿™ä¸¤ä¸ªå‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å†å›åˆ° <code>Scheduler</code> çœ‹å®ƒçš„ <code>flush</code> å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å½“å‰æ­£åœ¨æ‰§è¡Œè°ƒåº¦å‡½æ•°ä¸­ï¼Œåªéœ€æ”¾å…¥å¾…æ‰§è¡Œé˜Ÿåˆ—å³å¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è°ƒåº¦å®Œæˆï¼Œå¼€å§‹æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå·²è¿›å…¥æ‰§è¡Œè¿‡ç¨‹</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // éå†æ‰€æœ‰ actions å±æ€§ä¸­ä¿å­˜çš„æ‰€æœ‰ Action </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    do</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ ¸å¿ƒï¼Œæˆ‘ä»¬å®é™…è°ƒç”¨çš„æ˜¯ Action çš„ execute æ–¹æ³•</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">)))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // å‡ºé”™ç«‹å³é€€å‡º</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ‰§è¡Œè¿‡ç¨‹ç»“æŸ</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æŸä¸ª Action æŠ¥é”™ï¼Œå®ƒåé¢æ‰€æœ‰çš„ Action ç›´æ¥å–æ¶ˆæ‰</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æŠ›å‡ºé”™è¯¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      throw</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œéœ€è¦ææ¸…ä¸€ä¸ªç‚¹ï¼Œä¸ºä»€ä¹ˆéœ€è¦ç”¨ <code>actions</code> æ¥ä¿å­˜åŒä¸ª <code>Action</code> çš„å¤šä¸ªå®ä¾‹ï¼Ÿ</p><p>åœ¨éœ€è¦è°ƒåº¦çš„å‡½æ•°çš„å†…éƒ¨ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€šè¿‡ <code>this.schedule</code> æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è°ƒåº¦ï¼Œåœ¨ <code>AsyncScheduler</code> ä¸­ï¼Œè¿™ä¸ª <code>actions</code> å®é™…ä¸Šå¹¶ä¸ä¼šæœ‰å€¼ï¼Œå› ä¸ºæ¯æ¬¡æˆ‘ä»¬é€šè¿‡ <code>this.schedule</code>åˆ›å»ºä¸€ä¸ªæ–°çš„è°ƒåº¦çš„æ—¶å€™ï¼Œå®ƒä¼šæœ‰ä¸¤ç§æƒ…å†µï¼Œå¤ç”¨åŸæ¥çš„è°ƒåº¦å™¨æˆ–è€…å–æ¶ˆåŸæ¥çš„è°ƒåº¦å™¨ç„¶åå†åˆ›å»ºä¸€ä¸ªï¼Œè¿™ä¸¤ç§éƒ½æ˜¯å»¶è¿Ÿåˆ°æ¥ä¸‹æ¥çš„å®ä»»åŠ¡ä¸­æ‰§è¡Œï¼Œè€Œ <code>flush</code> æœ¬èº«æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨ <code>AsyncScheduler</code> ä¸‹ï¼Œ <code>actions</code> ä¸ä¼šæœ‰å€¼ï¼Œ å³ä¸‹é¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œåˆ°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ä¸ä¼šæ‰§è¡Œåˆ°ä¸‹é¢è¿™ä¸ª if å†…</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>åœ¨ <code>AsyncScheduler</code> ä¸­ï¼Œ <code>actions</code> å±æ€§ç”¨ä¸åˆ°ï¼Œä½†æ˜¯åœ¨ <code>AsyncScheduler</code> æ´¾ç”Ÿå‡ºçš„å‡ ç§è°ƒåº¦å™¨ä¸­ï¼Œ <code>actions</code> å±æ€§å°±å‘æŒ¥äº†ä½œç”¨ï¼Œå®ƒä¸ºå¤šä¸ªä»»åŠ¡åœ¨<strong>åŒä¸€ä¸ªè°ƒåº¦ä¸­</strong>è¿›è¡Œç»Ÿä¸€å¤„ç†æä¾›äº†ä»£ç ä¸Šçš„èƒ½åŠ›ã€‚</p><p>å›åˆ° <code>flush</code> å®ç°ï¼Œåœ¨ä¸Šé¢æˆ‘ä»¬æ ‡æ³¨äº†æ ¸å¿ƒä¸ºæ‰§è¡Œ <code>Action</code> çš„ <code>execute</code> æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">executing a cancelled action</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è°ƒåº¦å·²ç»ç»“æŸï¼Œæ¥ä¸‹æ¥è¦å¼€å§‹æ‰§è¡Œ</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ ¸å¿ƒï¼Œæ‰§è¡Œè¿‡ç¨‹</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">_execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å­˜åœ¨é”™è¯¯çš„è¯è¿”å›é”™è¯¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¸…é™¤æ‰å®šæ—¶å™¨</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿™é‡Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„ï¼Œè°ƒåº¦å™¨çš„å®ç°æ˜¯å•æ¬¡éå¾ªç¯çš„</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™æ®µä»£ç è¿˜æ²¡æœ‰æ¥è§¦åˆ°æ‰§è¡Œ <code>work</code> çš„æ ¸å¿ƒï¼Œ <code>work</code> å®é™…ä¸Šæ˜¯åœ¨ <code>_execute</code> ä¸­æ‰§è¡Œçš„ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> _execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">errored</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">errorValue</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ‰§è¡Œäº†è°ƒåº¦çš„å‡½æ•°</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> catch</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      errored</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      errorValue</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Scheduled action threw falsy error</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // é”™è¯¯å–æ¶ˆè®¢é˜…</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">errored</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> errorValue</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>RxJS å¾ˆå¤šè¿™ç§ <code>execute</code> å’Œ <code>_execute</code> çš„è®¾è®¡ï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†è§£è€¦ä¸€äº›æ“ä½œï¼Œæ–¹ä¾¿åç»­çš„å­ç±»è¿›è¡Œé‡å†™çš„æ—¶å€™èƒ½å¤Ÿåœ¨æœ€å°çš„èŒƒå›´å†…è¿›è¡Œã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±æŠŠ <code>AsyncScheduler</code> çš„æµç¨‹èµ°å®Œäº†ï¼Œå¯èƒ½ä½ ä¼šè§‰å¾—å¾ˆä¹±ï¼Œæˆ‘ä»¬å¯ä»¥æ¢³ç†ä¸€ä¸‹å®ƒçš„è°ƒç”¨æµç¨‹ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-text"><span class="line"><span>AsyncScheduler.schedule</span></span>
<span class="line"><span>-&gt; new AsyncAction</span></span>
<span class="line"><span>-&gt; AsyncAction.schedule</span></span>
<span class="line"><span>-&gt; AsyncAction.requestAsyncId ï¼ˆå¼€å§‹è°ƒåº¦ï¼Œç›®æ ‡æ‰§è¡Œå‡½æ•°ä¸º flush ï¼Œæ­¤æ—¶ pending ç½®ä¸º true ï¼‰</span></span>
<span class="line"><span>-&gt; AsyncScheduler.flush ï¼ˆè°ƒåº¦ï¼ˆç­‰å¾…ï¼‰ç»“æŸï¼Œå¼€å§‹æ‰§è¡Œ flush ï¼Œæ­¤æ—¶ pending ç½®ä¸º false ï¼‰</span></span>
<span class="line"><span>-&gt; AsyncAction.execute</span></span>
<span class="line"><span>-&gt; AsyncAction._execute ï¼ˆæ‰§è¡Œå®é™… work å‡½æ•°çš„åœ°æ–¹ï¼‰</span></span></code></pre><p>åœ¨ Chrome çš„ debug ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ¸…æ™°çš„çœ‹åˆ°å¯¹åº”çš„è°ƒç”¨æ ˆï¼š</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/27/202310271142144.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/27/202310271142144.avif" alt=""></a></p><p>å¦å¤–ä½œä¸ºä¸€ä¸ª <code>Subscription</code> ï¼Œå®ƒçš„ <code>unsubscribe</code> å…¶å®å¹¶ä¸å¤æ‚ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ²¡å…³é—­è¿‡æ‰æ‰§è¡Œä¸€æ¬¡å…³é—­</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ¸…ç†çŠ¶æ€</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è°ƒåº¦çš„çŠ¶æ€ç½®ä¸º false ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†æ‰§è¡Œè¿™ä¸ªå‡½æ•°äº†</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ ¸å¿ƒï¼Œä» actions ä¸­åˆ é™¤è‡ªå·±</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å¯¹äº AsyncAction è‡ªèº«ï¼Œä¸‹é¢è¿™æ®µä»£ç ä¸ä¼šæ‰§è¡Œåˆ°ï¼Œå‰é¢æˆ‘ä»¬è¯´è¿‡ AsyncAction å¹¶ä¸ä¼šå­˜å‚¨åˆ° actions ä¸­ã€‚</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      arrRemove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å–æ¶ˆæ‰å®šæ—¶å™¨</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">        this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è·Ÿä¹‹å‰ schedule ä¸€æ ·ï¼Œç”±äº recycleAsyncId éœ€è¦åˆ¤æ–­æ–°æ—§ delay ï¼Œæ‰€ä»¥æ”¾åˆ° recycleAsyncId åæ¸…ç†çŠ¶æ€</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // çˆ¶ç±»çš„å®ç°</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯¹äº <code>AsyncAction</code> æ¥è¯´ï¼Œå¦‚æœå·²ç»åœ¨è°ƒåº¦çŠ¶æ€äº†ï¼Œé‚£ä¹ˆæ ¸å¿ƒå°±æ˜¯å–æ¶ˆæ‰å®šæ—¶å™¨ã€‚</p><h3 id="asapscheduler-å’Œ-asapaction" tabindex="-1">AsapScheduler å’Œ AsapAction <a class="header-anchor" href="#asapscheduler-å’Œ-asapaction">ğŸ”—</a></h3><p>å¯èƒ½å¾ˆå¤šäººå’Œæˆ‘ä¸€æ ·ï¼Œåœ¨ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªçš„å®ç°çš„æ—¶å€™ï¼Œä¸€å¤´æ±¡æ°´ï¼Œ Asap ï¼Œä»€ä¹ˆæ„æ€ï¼Ÿ</p><p>åœ¨è‹±æ–‡ä¸­ï¼Œå®ƒæ˜¯ as soon as possible çš„ç¼©å†™ï¼Œæ„æ€æ˜¯â€œå°½å¯èƒ½å¿«çš„â€ã€‚</p><p>æ¯”å¦‚æœ€è¿‘ cs2 è½¬ä¼šæœŸé—´çŒªçŒªå¯¹å®è“è¢«ä¸‹æ”¾ä¸€äº‹å‘å‡ºå»ºè®®ï¼Œå¸Œæœ›æœ‰é˜Ÿä¼èƒ½å°½å¿«ç­¾ä¸‹ä»–ï¼š</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/30/202310300947615.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/30/202310300947615.avif" alt="Someone sign him ASAP"></a></p><p>ï¼ˆPSï¼š NIP ç»ˆäºä¸å†æ‰§ç€ 60 ä¸‡äº†ï¼ŒçŒªçŒªä½ ä¹Ÿä¸çœ‹çœ‹å®è“æœ€è¿‘æ‰“çš„ä»€ä¹ˆé¬¼æ ·å­ï¼Œè¢« bench å®Œå…¨ä¸æ„å¤–ï¼Œæ„å¤–çš„æ˜¯ç«Ÿç„¶è¿™ä¹ˆä¹…æ‰ bench â€¦ï¼‰</p><p>ä¸è¦è¢«å®ƒçš„åå­—å“åˆ°ï¼Œåœ¨å†…éƒ¨ä¸­å®ƒå…¶å®å°±æ˜¯åŒ…è£…äº† <code>Promise.then</code> è€Œå·²ã€‚</p><p>å¦‚æœä½ æ‡‚ä¸€ç‚¹æµè§ˆå™¨å®ä»»åŠ¡å¾®ä»»åŠ¡çš„å…«è‚¡æ–‡çš„è¯ï¼Œåº”è¯¥å°±èƒ½ç†è§£ <code>Promise.then</code> æ¯” <code>setTimeout</code> æˆ–è€… <code>setInterval</code> å¿«çš„åŸå› äº†ã€‚</p><p><code>AsapScheduler</code> å’Œ <code>AsapAction</code> åˆ†åˆ«ç»§æ‰¿äº† <code>AsyncScheduler</code> å’Œ <code>AsyncAction</code> ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´å®ƒä»¬çš„æ‰§è¡Œæµç¨‹å¤§ä½“æ˜¯ç›¸ä¼¼çš„ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹ <code>AsapScheduler</code> å¦‚ä½•ç»§æ‰¿ <code>AsyncScheduler</code> ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œæˆ‘ä»¬å…ˆä¸ç®¡å®ƒæ˜¯å¦‚ä½•é‡å†™ <code>flush</code> æ–¹æ³•çš„ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹ <code>AsapAction</code> æ˜¯å¦‚ä½•ç»§æ‰¿çš„ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯ä»¥çœ‹åˆ°é‡å†™äº† <code>requestAsyncId</code> å’Œ <code>recycleAsyncId</code> æ–¹æ³•ã€‚</p><p>ä» <code>AsyncScheduler</code> æ‰§è¡Œçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆçœ‹ <code>requestAsyncId</code> çš„å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœè®¾å®šäº†å»¶è¿Ÿæ—¶é—´ï¼Œé‚£ä¹ˆå›é€€åˆ° AsyncAction</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿™é‡Œå°±å’Œ AsyncAction æ˜¾è‘—ä¸åŒäº†</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // AsyncAction ç›´æ¥è°ƒç”¨ flush ï¼Œè€Œè¿™é‡Œæ˜¯æ‰‹åŠ¨ push è¿› actions ä¸­ï¼Œå†è¿›è¡Œ setImmediateï¼ˆé»˜è®¤ä¸‹ä¸º Promise.then ï¼‰ è°ƒåº¦ </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // åœ¨æœªå¤„äºè°ƒåº¦è¿‡ç¨‹æ—¶ï¼Œå¯åŠ¨è°ƒåº¦ï¼Œå¹¶æŠŠè°ƒåº¦çš„ id æŒ‚è½½åˆ° Scheduler çš„ _scheduled å±æ€§ä¸Š</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœå¤„äºè°ƒåº¦è¿‡ç¨‹ä¸­ï¼Œåˆ™å¤ç”¨å·²æœ‰çš„è°ƒåº¦å™¨ id</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">)));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ª <code>setImmediate</code> çš„å‡½æ•°ï¼Œå’Œ <code>setInterval</code> ä¸€æ ·ï¼Œ RxJS å°è£…äº†å®ƒä»¬ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿèƒ½é€šè¿‡ <code>delegate</code> å¯¹è±¡æ¥è¦†ç›–ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// immediateProvider.ts</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> type</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">./timerHandle</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Immediate</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ImmediateProvider</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // When accessing the delegate, use the variable rather than `this` so that</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // the functions can be called without being bound to the provider.</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">setImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">)(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">)(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  delegate</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Immediate.ts</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Immediate</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> nextHandle</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">] = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      resolved</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">&amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> cb</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handle</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>åœ¨å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ <code>AsapScheduler</code> å®é™…ä¸Šå°±æ˜¯å°è£…äº† <code>Promise.then</code> ï¼Œ <code>Promise.then</code> å’Œ <code>setInterval</code> çš„åŒºåˆ«è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œé™¤äº†æ‰§è¡Œæ—¶æœºçš„ä¸åŒä¹‹å¤–ï¼Œ <code>setInterval</code> è°ƒç”¨ä¹‹åä¼šè¿”å›ä¸€ä¸ª id ï¼Œåé¢æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>clearInterval</code> æ¥å–æ¶ˆæ‰è¿™ä¸ªå®šæ—¶å™¨ï¼Œè€Œ <code>Promise.then</code> æ˜¯æ²¡æœ‰è¿™ä¸ªåŸç”Ÿçš„åŠŸèƒ½çš„ï¼Œåœ¨ RxJS ä¸­ï¼Œé€šè¿‡è®¡æ•°å™¨ä»¥åŠä¸€ä¸ªç”¨æ¥æ ‡è®°çš„å­—é¢å¯¹è±¡æ¥å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// æ¯ä¸ª Promise.then å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ id</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// æ¯è°ƒç”¨ Promise.then å°±è‡ªå¢ nextHandleï¼Œç¡®ä¿ id å”¯ä¸€</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">nextHandle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ä¸€ä¸ª Promise å¯¹è±¡ï¼Œç”¨æ¥è°ƒç”¨ then ç”Ÿæˆä¸€ä¸ªå¾®ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// è¦æ³¨æ„è¿™é‡Œæ˜¯æ‡’åŠ è½½çš„ï¼Œä¸ç„¶ zone.js å¯èƒ½æ— æ³•ä»£ç†è¿™ä¸ª Promise å¯¹è±¡</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ç”¨æ¥ä¿å­˜å½“å‰æ­£åœ¨è°ƒåº¦çš„ id çš„çŠ¶æ€ï¼Œå¦‚æœ activeHandles[id] = true åˆ™æ­¤æ—¶è°ƒåº¦ä¾ç„¶å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è°ƒåº¦åº”è¯¥è¢«å–æ¶ˆï¼Œä¹Ÿå°±æ˜¯ä¸æ‰§è¡Œ Promise.then çš„å›è°ƒ</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">: { [</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">]: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999"> } =</span><span style="--s-dark:#666666;--s-light:#999999"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// å–æ¶ˆä¸€ä¸ªå¾®ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> boolean</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> in</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// å°è£…</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Immediate</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> nextHandle</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ ‡è®°ä¸ºéœ€è¦è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">] = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // åˆå§‹åŒ–å…¨å±€çš„ Promise å¯¹è±¡</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      resolved</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¼€å§‹è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ ¸å¿ƒï¼Œå¦‚æœ findAndClearHandle è¿”å›äº† true ï¼Œé‚£ä¹ˆæ‰æ‰§è¡Œ cb</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">&amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> cb</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿”å› id</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handle</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¸…é™¤è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>åŸç”Ÿçš„ <code>Promise</code> å¹¶æ²¡æœ‰å–æ¶ˆè¿™ä¸€è¯´æ³•ï¼Œ <code>Promise</code> æ˜¯å¯¹â€œæœªæ¥â€çš„ä¸€ç§æ‰¿è¯ºï¼Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œ RxJS é€šè¿‡ä¸€ä¸ªå”¯ä¸€çš„ id æ¥æ ‡è®°ä¸€ä¸ª <code>Promise.then</code> çš„å›è°ƒï¼Œå®ƒçš„ç®€åŒ–ä»£ç ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#B8A965;--s-light:#998418"> Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    cb</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// æ‰§è¡Œä¸€äº›æ“ä½œ</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// è®© cb è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">]</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// æ‰§è¡Œä¸€äº›æ“ä½œ</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ä¸æƒ³è®© cb è°ƒåº¦äº†</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span></code></pre><p>å®é™…ä¸Šï¼Œ <code>Promise.then</code> ç¡®å®æ‰§è¡Œäº†ï¼Œä½†æ˜¯é€šè¿‡åŒ…æ‹¬ä¸€æ®µå¯¹æ ‡è®°çš„åˆ¤æ–­æ¥å®ç°â€œå–æ¶ˆâ€è°ƒåº¦ï¼Œå®é™…ä¸Šæ˜¯æ²¡æ‰§è¡Œåˆ°è°ƒåº¦ï¼ˆ <code>&amp;&amp;</code> æ“ä½œç¬¦çŸ­è·¯äº†ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>recycleAsyncId</code> çš„å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœè®¾å®šäº†å»¶è¿Ÿæ—¶é—´ï¼Œé‚£ä¹ˆå›é€€åˆ° AsyncAction</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœå·²ç»æ²¡æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œäº†çš„è¯ï¼Œæ¸…æ‰è°ƒåº¦å™¨çš„ id</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿™æ ·ä¸‹ä¸€æ¬¡çš„è°ƒåº¦æ‰èƒ½æ­£ç¡®è·å–æ–°çš„è°ƒåº¦å™¨ id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">]?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // é‡è¦åˆ¤æ–­ï¼Œç”±äºæˆ‘ä»¬ä¼šåµŒå¥—è°ƒç”¨ schedule ï¼Œæ­¤æ—¶åœ¨æ‰§è¡Œå¤–å±‚ schedule ç»“æŸåæˆ‘ä»¬ä¼šè°ƒç”¨æœ¬æ–¹æ³•æ¥å¤ç”¨æˆ–è€…å–æ¶ˆè°ƒåº¦å™¨ï¼Œä½†æ˜¯åœ¨å†…éƒ¨æ‰§è¡Œçš„æ—¶å€™ _scheduled å°±ä¼šæ›´æ–°æˆæ–°çš„è°ƒåº¦å™¨ id çš„å€¼äº†ï¼Œæ‰€ä»¥è¦åˆ¤æ–­ä¸¤è€…æ˜¯å¦ä¸€è‡´ï¼Œä¸ç„¶ä¼šå¯¼è‡´åµŒå¥—çš„è°ƒåº¦è°ƒç”¨ä¸å…¨ï¼Œå…·ä½“å¯ä»¥çœ‹ https://github.com/ReactiveX/rxjs/issues/6747</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œå¯èƒ½éœ€å¯¹ä¸¤ä¸ªé‡å†™çš„å‡½æ•°é…åˆèµ·æ¥ç†è§£ã€‚</p><p>åœ¨ <code>AsapScheduler</code> ä¸­ï¼Œåœ¨ä¸€æ¬¡åŒæ­¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„è°ƒåº¦éƒ½ä¼šå…±ç”¨ä¸€ä¸ªè°ƒåº¦å™¨çš„ id ï¼Œè€Œè¿™ä¸ª id æŒ‚è½½åœ¨çˆ¶ç±» <code>AsyncScheduler</code> çš„ <code>_schedule</code> å±æ€§ä¸Šã€‚</p><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ <code>AsyncScheduler</code> ä¸­æš‚æ—¶ä½¿ç”¨ä¸åˆ° <code>_schedule</code> å±æ€§ï¼Œå› ä¸ºå¯¹äº <code>AsyncScheduler</code> ï¼Œæ¯æ¬¡è°ƒåº¦éƒ½ä¼šäº§ç”Ÿæ–°çš„è°ƒåº¦å™¨ id ï¼Œè€Œ <code>AsapScheduler</code> åˆ™æ˜¯å…±ç”¨ä¸€ä¸ªè°ƒåº¦å™¨ id ï¼Œåœ¨ä¸€æ¬¡è°ƒåº¦ä¸­å¯¹äºæ‰€æœ‰åµŒå¥—çš„è°ƒåº¦ç»Ÿä¸€æ‰¹å¤„ç†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä¾‹å­æ¥è§£é‡Šï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// å¯åŠ¨ä¸€ä¸ªè°ƒåº¦ï¼Œå¾—åˆ°ä¸€ä¸ª id = 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// æ”¾åˆ° actions ä¸­</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¯åŠ¨ä¸€ä¸ªè°ƒåº¦ï¼Œå¾—åˆ°ä¸€ä¸ª id = 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ”¾åˆ° actions ä¸­</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ”¾åˆ° actions ä¸­</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¤ç”¨å‰é¢çš„è°ƒåº¦ id = 2</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span></code></pre><p>ä¸Šé¢çš„ä»£ç ä¼šè¾“å‡º 1 2 3 4 ï¼Œå³æœ€å¤–å±‚çš„ <code>schedule</code> ä½¿ç”¨ä¸€æ¬¡ <code>Promise.then</code> è°ƒåº¦ï¼Œå†…éƒ¨ä¸¤ä¸ª <code>schedule</code> ä½¿ç”¨ä¸€æ¬¡ <code>Promise.then</code> ï¼Œå³åˆå¹¶æ‰§è¡Œã€‚</p><p>è¿™ä¹Ÿç¬¦åˆåŸç”Ÿ <code>Promise.then</code> çš„æ‰§è¡Œé¡ºåºï¼Œå¦‚æœåœ¨ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ç»§ç»­å¯åŠ¨ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œé‚£ä¹ˆæ–°çš„å¾®ä»»åŠ¡å°†ä¼šæ”¾åˆ°å½“å‰å¾®ä»»åŠ¡çš„åé¢ï¼Œåœ¨å½“å‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œæˆåç«‹å³æ‰§è¡Œæ–°çš„å¾®ä»»åŠ¡ï¼Œä¸Šé¢çš„å†™æ³•å°±ç±»ä¼¼å¦‚ä¸‹ <code>Promise.then</code> çš„å†™æ³•ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// è¾“å‡º 1 2 3 4</span></span></code></pre><p>æ¥ç€æˆ‘ä»¬å›åˆ° <code>AsapScheduler</code> ä¸­ï¼Œçœ‹çœ‹ <code>flush</code> æ˜¯å¦‚ä½•é‡å†™çš„ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å½“å‰çš„ Asap è°ƒåº¦å™¨ id ï¼Œå¯èƒ½ä¸å­˜åœ¨</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å¦‚æœæŠŠ AsapScheduler å½“ä½œ AsyncScheduler ä½¿ç”¨çš„è¯ï¼Œè¿™é‡Œçš„ _scheduled å°±ä¸ä¼šæœ‰å€¼</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å› ä¸ºæˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œ AsyncScheduler çš„è°ƒåº¦å™¨ id ä½äºæ¯ä¸ª Action å®ä¾‹ä¸­</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">flushId</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¸…é™¤è°ƒåº¦å™¨ id ï¼Œå¦‚æœè°ƒåº¦å™¨ id å­˜åœ¨ï¼Œï¼ˆè¿™ä¸ªè°ƒåº¦å™¨ id ä¸€å®šæ˜¯åŸºäº Promise.then çš„ï¼‰é‚£ä¹ˆæœ¬æ¬¡çš„æ‰§è¡Œå°±ä¼šæ‰§è¡Œå…¨éƒ¨çš„ä»»åŠ¡</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ¸…é™¤æ‰ï¼Œå…¶ä»–è°ƒåº¦æ‰èƒ½æ­£ç¡®åœ°é€šè¿‡ requestAsyncId è·å–ä¸€ä¸ªæ–°çš„è°ƒåº¦ id</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    do</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ‰¹å¤„ç†ï¼ŒæŠŠæ‰€æœ‰è°ƒåº¦å™¨ id ç›¸åŒçš„ Action éƒ½æ‰§è¡Œæ‰</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">)))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å¦‚æœå½“å‰å¤„ç†çš„æ˜¯ AsyncAction ï¼Œé‚£ä¹ˆ while åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬åœ¨ä¸€ä¸ª AsyncAction ä¸­è¯·æ±‚ AsapAction çš„è¯ï¼Œ action.id === flushId ä¸æˆç«‹ï¼Œ flushId æ­¤æ—¶ä¸€å®šæ˜¯ undefined ã€‚</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è€Œå¦‚æœå¤„ç†çš„æ˜¯ AsapAction åˆ™æ­¤æ—¶åˆ™ä¼šä¸€æ¬¡æ€§æ‰§è¡Œæ‰æ‰€æœ‰å­˜åœ¨çš„ä»»åŠ¡ã€‚ç›´åˆ°æŸä¸ª action çš„ id ä¸ä¸ºå½“å‰æ‰¹å¤„ç†çš„ id ï¼ˆæ¯”å¦‚åµŒå¥—è°ƒç”¨çš„æƒ…å†µï¼‰ã€‚</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> flushId</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // é”™è¯¯æƒ…å†µ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> flushId</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">())</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      throw</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯èƒ½ä½ åœ¨çœ‹è¿™ä¸ªå®ç°çš„æ—¶å€™æœ‰ç‚¹æ™•ï¼Œå…¶å®åªè¦æ˜ç™½ä»¥ä¸‹çš„ä¸¤ç‚¹</p><ul><li>åœ¨ä¼ å…¥çš„ <code>Action</code> æ˜¯ <code>AsyncAction</code> æ—¶ï¼Œæ­¤æ—¶ <code>actions</code> æ•°ç»„å¯èƒ½ä¸ºç©ºä¹Ÿå¯èƒ½ä¸ä¸ºç©ºï¼Œè¿™å–å†³äºä½ åœ¨ä¼ å…¥çš„ <code>AsyncAction</code> ä¸­æ‰€è¿›è¡Œçš„åŠ¨ä½œï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œè¿™ä¸ª <code>AsyncAction</code> å‰é¢ä¸€å®šä¸ä¼šæœ‰ <code>AsapAction</code> äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¤„åœ¨ä¸€ä¸ªå®ä»»åŠ¡ä¸­ï¼Œå¦‚æœæ­¤æ—¶å®ƒçš„å‰é¢å­˜åœ¨æœªæ‰§è¡Œçš„ <code>AsapAction</code> ï¼Œé‚£ä¹ˆè¿™æ˜¯çŸ›ç›¾çš„ï¼Œå› ä¸ºè¿™äº› <code>AsapAction</code> åº”è¯¥åœ¨ä¸Šä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—å°±è¢«æ¸…ç©ºäº†ã€‚</li><li>åœ¨ä¼ å…¥çš„ <code>Action</code> æ˜¯ <code>AsapAction</code> æ—¶ï¼Œæ­¤æ—¶ <code>actions</code> å¯èƒ½ä¸ºç©ºä¹Ÿå¯èƒ½ä¸ä¸ºç©ºï¼Œè¿™å–å†³äºä½ åœ¨ä¼ å…¥çš„ <code>AsapAction</code> ä¸­æ‰€è¿›è¡Œçš„åŠ¨ä½œã€‚ä½†æ˜¯ <code>actions</code> ä¸€å®šä¸ä¼šæœ‰ <code>AsyncAction</code> å®ä¾‹ï¼Œè¿™æ˜¯å› ä¸º <code>AsyncAction</code> åªä¼šåœ¨ <code>flush</code> çš„æ—¶å€™ä¼ å…¥ï¼Œå¹¶ä¸ä¼šæ‰‹åŠ¨åŠ å…¥åˆ° <code>actions</code> ä¸­ã€‚</li></ul><p>è¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯å…¼å®¹äº† <code>AsyncScheduler</code> çš„ <code>flush</code> å®ç°ï¼Œå¹¶ä¸”é¢å¤–å®ç°äº†æ‰¹å¤„ç†æœ¬æ¬¡å¾®ä»»åŠ¡çš„å…¨éƒ¨ <code>Action</code> çš„åŠŸèƒ½ã€‚</p><h3 id="animationframescheduler-å’Œ-animationframeaction" tabindex="-1">AnimationFrameScheduler å’Œ AnimationFrameAction <a class="header-anchor" href="#animationframescheduler-å’Œ-animationframeaction">ğŸ”—</a></h3><p>è¿™ä¸¤è€…çš„å®ç°å’Œ <code>AsapScheduler</code> å’Œ <code>AsapAction</code> å‡ ä¹ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ä» <code>Promise.then</code> åˆ‡æ¢åˆ°äº† <code>requestAnimateFrame</code> ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸è®²äº†ã€‚</p><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ <code>AnimationFrameScheduler</code> ä¼¼ä¹æœ‰ä¸ªé—ç•™çš„ bug ï¼Œåœ¨ä¹‹å‰ä¿®å¤ <code>AsapScheduler</code> çš„æ—¶å€™æ²¡æœ‰é¡ºé“ä¿®å¥½åƒï¼Ÿ</p><p>ä¸è¿‡è¿™ä¹Ÿåªæ˜¯æˆ‘çš„çŒœæµ‹ï¼Œè´´ä¸Šç›¸å…³çš„ <a href="https://github.com/ReactiveX/rxjs/issues/7196" target="_blank" rel="noopener">asapScheduler: Scheduling inside of an executing action only works once</a></p><p>å¯¹äº <code>AnimationFrameScheduler</code> ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯å¦‚æœåµŒå¥—ä½¿ç”¨çš„è¯ä¼šå¯¼è‡´åªæ‰§è¡Œä¸€æ¬¡åµŒå¥—çš„è°ƒåº¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><a data-fancybox="doc-gallery" href="https://user-images.githubusercontent.com/48575405/279329977-5427887c-3aab-4594-aee3-b6e709336b8d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/48575405/279329977-5427887c-3aab-4594-aee3-b6e709336b8d.png" alt=""></a></p><p>è€Œå¦‚æœä½¿ç”¨åŸç”Ÿçš„ <code>requestAnimateFrame</code> åˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><a data-fancybox="doc-gallery" href="https://user-images.githubusercontent.com/48575405/279330102-0745fb8d-be07-44c3-a452-2699e161630d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/48575405/279330102-0745fb8d-be07-44c3-a452-2699e161630d.png" alt=""></a></p><p>æˆ‘ä¹Ÿåœ¨ä¸Šé¢çš„ issue ä¸­è¯¢é—®äº†ç»´æŠ¤è€…ï¼Œçœ‹ä»–æ˜¯æ€ä¹ˆå›å¤çš„å§ã€‚</p><h3 id="queuescheduler-å’Œ-queueaction" tabindex="-1">QueueScheduler å’Œ QueueAction <a class="header-anchor" href="#queuescheduler-å’Œ-queueaction">ğŸ”—</a></h3><p><code>QueueScheduler</code> æ˜¯ä¸€ç§â€œåŒæ­¥â€çš„ <code>AsapScheduler</code> ï¼Œå¯èƒ½è¿™å¥è¯ä¼šè®©ä½ è§‰å¾—å¾ˆæ‡µé€¼ã€‚</p><p>åœ¨ <code>AsapScheduler</code> ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠä»»åŠ¡å»¶è¿Ÿåˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œï¼Œå¦‚æœåœ¨å¾®ä»»åŠ¡ä¸­ç»§ç»­å¯åŠ¨ <code>AsapScheduler</code> çš„è¯ï¼Œé‚£ä¹ˆè¿™äº›ä»»åŠ¡ä¼šè¢«æ”¾åˆ° <code>actions</code> å±æ€§ä¸­ï¼Œç„¶ååœ¨å½“å‰ Action æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œç»§ç»­æ‰§è¡Œ <code>actions</code> ä¸­çš„å‰©ä½™ Action ã€‚</p><p>è€Œ <code>QueueScheduler</code> åˆ™æ˜¯ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœåœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¸­ç»§ç»­è°ƒç”¨ <code>QueueScheduler</code> ï¼Œé‚£ä¹ˆä¼šæ”¾åˆ° <code>actions</code> å±æ€§ä¸­ï¼Œåœ¨å½“å‰ Action æ‰§è¡Œå®Œæ¯•ä¹‹åç»§ç»­æ‰§è¡Œ <code>actions</code> ä¸­çš„å‰©ä½™ Action ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¥è¡¨ç¤ºä¸¤è€…çš„åŒºåˆ«ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">before</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ä¸Šé¢ä¾‹å­è¾“å‡ºï¼š</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// before</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// after</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 4</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 3</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">before</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ä¸Šé¢ä¾‹å­è¾“å‡ºï¼š</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// before</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 4</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 3</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// after</span></span></code></pre><p><code>QueueScheduler</code> åªæ˜¯ç»§æ‰¿äº† <code>AsyncScheduler</code> è€Œå·²ï¼Œå¹¶æ²¡æœ‰é‡å†™ä»€ä¹ˆï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> QueueScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œæˆ‘ä»¬çš„é‡ç‚¹ä¸»è¦æ˜¯ <code>QueueAction</code> ï¼Œå®ƒç»§æ‰¿äº† <code>AsyncAction</code> ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> QueueAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">QueueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // å›é€€åˆ° AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ ¸å¿ƒï¼Œæ”¾åˆ° actions å±æ€§ä¸­</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // å›é€€åˆ° AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      ?</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      :</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">_execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">QueueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // å›é€€åˆ° AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // æ”¾åˆ° actions ä¸­</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // è¿”å› 0 ï¼Œå¹¶ä¸æ˜¯æ„å‘³ç€ä¸€ä¸ªè°ƒåº¦å™¨çš„ id ä¸º 0ï¼Œ è€Œæ˜¯è¡¨ç¤ºè°ƒåº¦å™¨å·²è¢«æ¸…é™¤ï¼Œè¿™é‡Œè¿”å› 0 åªæ˜¯ç±»å‹éœ€è¦ã€‚</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>é€šè¿‡ä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬é€šè¿‡ <code>queueScheduler.schedule</code> è¿›è¡Œè°ƒåº¦çš„æ—¶å€™ï¼Œå®ƒä¼šåŒæ­¥æ‰§è¡Œåˆ° <code>requestAsyncId</code> æ–¹æ³•ï¼Œæ­¤æ—¶ç›´æ¥æ‰§è¡Œäº† <code>scheduler.flush</code> ï¼Œæ­¤æ—¶ä¼šç›´æ¥å¼€å§‹è°ƒåº¦ï¼Œè€ŒåµŒå¥—çš„ <code>queueScheduler.schedule</code> è°ƒç”¨ï¼Œä¹Ÿä¼šèµ°åˆ° <code>scheduler.flush</code> ï¼Œä½†æ˜¯æ­¤æ—¶ <code>_active</code> æ­¤æ—¶ä¸º <code>true</code> ï¼Œåªä¼šæŠŠå®ƒæ¨å…¥åˆ° <code>actions</code> ä¸­ï¼Œç„¶åå½“ç¬¬ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå‰©ä½™ <code>actions</code> å†…çš„ <code>Action</code> å°±ä¼šè¢«ä¾æ¬¡æ‰§è¡Œã€‚</p><h2 id="scheduler-å’Œ-observable" tabindex="-1">Scheduler å’Œ Observable <a class="header-anchor" href="#scheduler-å’Œ-observable">ğŸ”—</a></h2><p>å¯¹äºä¸€ä¸ª <code>Observable</code> ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹æˆ‘ä»¬å¯ä»¥è®© <code>Scheduler</code> ç»‡å…¥ï¼Œä¸€ä¸ªæ˜¯ <code>subscribe</code> çš„æ—¶å€™ï¼Œä¸€ä¸ªæ˜¯ <code>next</code> ï¼ˆæˆ–è€… <code>complete</code> æˆ–è€… <code>error</code> ï¼‰ çš„æ—¶å€™ã€‚</p><p>RxJS æä¾›äº†ä¸¤ä¸ªç®¡é“ <code>subscribeOn</code> å’Œ <code>observeOn</code> æ¥å¯¹åº”è¿™ä¸¤ç§æƒ…å†µã€‚</p><h3 id="subscribeon" tabindex="-1">subscribeOn <a class="header-anchor" href="#subscribeon">ğŸ”—</a></h3><p><code>subscribeOn</code> å†³å®šçš„æ˜¯è®¢é˜…æ“ä½œçš„æ—¶æœºã€‚</p><p>å®ƒçš„å®ç°å¾ˆç®€å•ï¼Œé€šè¿‡ä¼ å…¥çš„ <code>Scheduler</code> æ¥å¯åŠ¨ä¸€ä¸ªè°ƒåº¦ï¼Œåœ¨è°ƒåº¦å‡½æ•°çš„å†…éƒ¨æ‰§è¡Œ <code>subscribe</code> æ“ä½œï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> subscribeOn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">){</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">source</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Observable</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscriber</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // .schedule è¿”å›äº†ä¸€ä¸ª Subscription </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      subscriber</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> source</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">subscribe</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscriber</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    });</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h3 id="observeon" tabindex="-1">ObserveOn <a class="header-anchor" href="#observeon">ğŸ”—</a></h3><p><code>observeOn</code> å†³å®šçš„æ˜¯è®¢é˜…äº†ä¹‹åå‘å‡ºå€¼çš„æ—¶æœºã€‚</p><p>å®ƒçš„å®ç°åŒæ ·ä¸éš¾ï¼Œé€šè¿‡ä»£ç†åŸæ¥çš„ <code>subscriber</code> ï¼Œé‡å†™å¯¹åº”çš„ä¸‰ä¸ªæ–¹æ³•æ¥å®ç°ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> observeOn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">source</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Observable</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      source</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">subscribe</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // ä¹‹å‰æˆ‘ä»¬å†™è¿‡çš„ operate æ“ä½œç¬¦ï¼Œå¯ä»¥ä»£ç† subscriber ï¼Œé‡å†™æ–¹æ³•ã€‚</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        operate</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">          destination</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          next</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">next</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          error</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">err</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">err</span><span style="--s-dark:#666666;--s-light:#999999">), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          complete</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">complete</span><span style="--s-dark:#666666;--s-light:#999999">(), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      );</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    });</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œä½¿ç”¨äº† <code>executeSchedule</code> ï¼Œå®ƒçš„å†…éƒ¨å®ç°å°±æ˜¯é€šè¿‡è°ƒåº¦å™¨æ¥å¯åŠ¨ç›¸åº”çš„ <code>work</code> ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  work</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  repeat</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">){</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¯åŠ¨è°ƒåº¦</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function </span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    work</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">repeat</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è¿™é‡Œå¦‚æœæ˜¯åŒæ­¥çš„è°ƒåº¦å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // è¿™é‡Œçš„ observeOn åªä¼šèµ°åˆ°è¿™é‡Œ</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // æ‰§è¡Œä¸€æ¬¡ä¹‹åä¸å†æ‰§è¡Œï¼Œéœ€è¦æ‰‹åŠ¨å–æ¶ˆè®¢é˜…</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // æ·»åŠ ï¼Œå³ä½¿é‡å¤æ·»åŠ ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå› ä¸º Subscription æ˜¯é€šè¿‡ Set æ¥ä¿å­˜è¿™äº› Subscription çš„</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // è¿™ä¸ªè¿”å›æˆ‘ä»¬åœ¨ observeOn ä¸ä¼šç”¨åˆ°æ‰€ä»¥ä¸ç®¡ã€‚</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">repeat</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h3 id="å…¶ä»–æ“ä½œç¬¦å’Œç®¡é“" tabindex="-1">å…¶ä»–æ“ä½œç¬¦å’Œç®¡é“ <a class="header-anchor" href="#å…¶ä»–æ“ä½œç¬¦å’Œç®¡é“">ğŸ”—</a></h3><p>åœ¨ RxJS ä¸­ï¼Œè™½ç„¶å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¸ä¼šæ˜æ˜¾çš„ä½¿ç”¨åˆ° <code>Scheduler</code> ï¼Œä½†æ˜¯æŸäº›æ“ä½œç¬¦æˆ–è€…ç®¡é“é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥é€šè¿‡æœ€åä¸€ä¸ªå…¥å‚æ¥æ§åˆ¶ï¼Œæ¯”å¦‚ <code>delay</code> ç®¡é“ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹å®ƒä¼šä½¿ç”¨ <code>asyncScheduler</code> ä½œä¸ºè°ƒåº¦å™¨ï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> delay</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  due</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Date</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // é»˜è®¤è°ƒåº¦å™¨</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerLike</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> asyncScheduler</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> MonoTypeOperatorFunction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">duration</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> timer</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">due</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#80A665;--s-light:#59873A"> delayWhen</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> duration</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h1 id="åè®°" tabindex="-1">åè®° <a class="header-anchor" href="#åè®°">ğŸ”—</a></h1><p>åœ¨é€› issue çš„æ—¶å€™ï¼Œå‘ç°äº†ä½œè€…è¯´åœ¨ 8.0 å¯èƒ½ä¼šå‘å¸ƒä¸€ä¸ªæ›´åŠ è½»å·§çš„è°ƒåº¦å™¨ï¼Œè¯´å®è¯ï¼Œä½œä¸ºä¸€ä¸ªåˆ‡å›¾ä»”ï¼Œæˆ‘è¿˜æ˜¯ä¸æ˜¯å¾ˆå–œæ¬¢ç»§æ‰¿ï¼Œè¿™ä¸œè¥¿å¯¹è„‘çš„ç®—åŠ›æœ‰ç‚¹é«˜ï¼Œæ°å¥½æˆ‘çš„ğŸ§ åˆå¾ˆä¸€èˆ¬ï¼Œæ–¹æ³•è·³æ¥è·³å»ï¼Œå¾ˆå®¹æ˜“å°±é˜…è¯»ç–²åŠ³ï¼Œæ¯æ¬¡è°ƒç”¨æ–¹æ³•éƒ½å¾—æ€è€ƒå®ƒçš„å­ç±»æ˜¯ä¸æ˜¯é‡å†™äº†ï¼Œä»–è¿™æ®µé€»è¾‘æ˜¯ä¸æ˜¯åªå¯¹å­ç±»æœ‰ä½œç”¨çš„ï¼Ÿ</p><p>è€Œä¸”æˆ‘æ€»è§‰å¾—è¿™ä¸ªè°ƒåº¦å™¨çš„ç»§æ‰¿å…³ç³»æœ‰ç‚¹è®©äººæ‡µé€¼ï¼Œä½œä¸ºåŸºç±»çš„ <code>AsyncScheduler</code> ç«Ÿç„¶ä¼šæœ‰ <code>_schedule</code> è¿™ç§å­ç±»æ‰è¦ç”¨åˆ°çš„å±æ€§â€¦ å½“ç„¶ï¼Œè¿™é‡Œåªæ˜¯å°å°çš„åæ§½ï¼Œå’±ä¹Ÿä¸æ˜¯ä»€ä¹ˆ OOP é«˜æ‰‹ï¼Œè€Œä¸”å†™ä»£ç æœ‰æ—¶å€™çœŸçš„ä¸æ˜¯é‚£æ ·ä¸€å®šå¯¹è¿™æ ·ä¸€å®šé”™ï¼Œæœ‰å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹å¿…é¡»å†™æˆé”™çš„æ–¹å¼æ‰èƒ½å¥½å¤„ç†ï¼Œæ‰€ä»¥ä¿æŒè°¦è™šï¼Œä¸è¦å¦„è‡ªè²è–„ã€‚</p><p>åœ¨é€› issue çš„æ—¶å€™ï¼Œå‘ç°æœ‰äººæŠ±æ€¨ä½œè€…ç»´æŠ¤çš„å¤ªæ…¢äº†ï¼Œä½œè€…å›äº†å¥ï¼š</p><blockquote><p>A friendly reminder to some of the snark in here: This is free software maintained by unpaid volunteers. I understand youâ€™re frustrated, but Iâ€™m quite literally not paid to deal with you.</p></blockquote><p>å¤§æ„å°±æ˜¯â€œå…è´¹è½¯ä»¶ï¼Œæˆ‘æ²¡ç©ºä¿®ä½ å¾—ç­‰ç€ï¼ŒæŠ±æ€¨æ˜¯æ²¡ç”¨çš„â€ã€‚ æˆ‘è¿˜æ˜¯å¾ˆæ”¯æŒä½œè€…çš„ï¼Œé€‰æ‹©å¼€æºè½¯ä»¶ï¼Œä½ å°±åº”è¯¥æ˜ç™½ï¼Œå…è´¹çš„å¾€å¾€å°±æ˜¯æœ€è´µçš„ï¼Œå¤§å®¶å¯ä»¥ä¸ºçˆ±å‘ç”µï¼Œä¹Ÿå¯ä»¥ç«‹é©¬å´©æ’¤å–æºœã€‚ä¸è¿‡ RxJS ä½œä¸º Angular çš„ä¸€ä¸ªé‡è¦çš„ä¾èµ–åº“ï¼ˆå¦ä¸€ä¸ªåº”è¯¥æ˜¯ zone.js ï¼‰ï¼Œå®ƒçš„ç¨³å®šè¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œè™½ç„¶å›½å†… Angular å¼€å‘è€…å¯èƒ½å¹¶ä¸å¤šã€‚</p><p>RxJS çš„æºç éƒ¨åˆ†åº”è¯¥å°±åˆ°è¿™é‡Œäº†ï¼Œåœ¨å¤§åŠå¹´å‰ï¼Œæˆ‘å‘äº†å‡ ç¯‡å…³äº RxJS ä½¿ç”¨çš„å¸–å­ï¼Œè€Œç°åœ¨ï¼Œæˆ‘å‘äº†å…³äº RxJS çš„å‡ ç¯‡æºç è§£æçš„æ–‡ç« ã€‚å½“ç„¶æˆ‘å†™çš„å¯èƒ½ä¼šæœ‰é”™è¯¯ï¼Œå¯èƒ½å†™çš„ä¸èƒ½è®©æ‰€æœ‰å¯¹ RxJS æ„Ÿå…´è¶£çš„äººæ˜ç™½å®ƒçš„å†…éƒ¨å®ç°ï¼Œä½†å¦‚æœæœ‰æŸä¸ªäººäº†è§£äº†ï¼Œé¢†æ‚Ÿäº†ï¼Œé‚£ä¹ˆæˆ‘çš„ä»·å€¼å°±å®ç°äº†ã€‚å¦‚æœä½ å‘ç°å¸–å­ä¸­æœ‰ä»»ä½•ä»£ç é”™è¯¯ï¼Œé€»è¾‘é”™è¯¯ï¼Œä¹¦å†™é”™è¯¯çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è¯„è®ºæ¥åé¦ˆï¼Œéå¸¸æ„Ÿè°¢ï¼</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#RxJS</div><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/d8804bf6ed5f" class="" truncate="" title="TypeScript 5.3ï¼ˆè¯‘ï¼‰"><i class="i-mi:chevron-left" mr-1=""></i><span>TypeScript 5.3ï¼ˆè¯‘ï¼‰</span></a><a href="/58091f9cefdf" class="" ml-auto="" truncate="" title="RxJS æºç è§£è¯»ä¹‹æ´¾ç”Ÿ Subject"><span>RxJS æºç è§£è¯»ä¹‹æ´¾ç”Ÿ Subject</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-93b0ae89="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-93b0ae89=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-93b0ae89=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-93b0ae89=""></i></div><div flex="~ col grow" gap-4="" data-v-93b0ae89=""><textarea disabled="" placeholder="ä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼Œç•™ä¸‹è¯„è®ºè¡Œä¸è¡Œ" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-93b0ae89=""></textarea><div flex="" items-start="" justify-between="" data-v-93b0ae89=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-93b0ae89="">æ”¯æŒ Markdown è¯­æ³• </a><button class="mujika-git-talk-button" cursor-pointer="" data-v-93b0ae89="">ç‚¹å‡»ç™»å½•</button></div></div></div><!--]--></div></div><!----><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">æ–‡ç« ç›®å½•</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT Â© Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">å¦‚æœæˆ‘å’Œç‹—ä¸€æ ·æœ‰å°¾å·´çš„è¯ï¼Œä¸€å®šä¼šè—ä¸ä½è¿™ä»½å–œæ‚¦ï¼Œè€Œå°¾å·´ä¸€ç›´æ‘‡ä¸ªä¸åœå§ã€‚</div></footer></div></div></body></html>