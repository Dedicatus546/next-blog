<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RxJS 源码解读之 Scheduler</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-4gPi1Ho2.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-afYcuv6x.css"><link rel="modulepreload" crossorigin="" href="/assets/RxJS-源码解读之-Scheduler-DiPjyeCk.js"><meta property="og:title" content="RxJS 源码解读之 Scheduler"><meta name="twitter:title" content="RxJS 源码解读之 Scheduler"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">RxJS 源码解读之 Scheduler</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2023-10-26 18:26</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2023-11-04 01:12</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/编程">编程</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">7.4K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">27 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言">🔗</a></h1><p>RxJS 源码解读之 <code>Scheduler</code> 。</p><p>在前面的文章中，我们讲了 RxJS 核心的几个概念，并且分析了它们源码中的实现。</p><p>本文我们讲 RxJS 中另一位维度的东西，它称之为 Scheduler 。</p><h1 id="正文" tabindex="-1">正文 <a class="header-anchor" href="#正文">🔗</a></h1><h2 id="概念" tabindex="-1">概念 <a class="header-anchor" href="#概念">🔗</a></h2><p>Scheduler ，在英文中的意思为调度器，一听到调度器我们可能就有点害怕了，跟这东西有关的都是让人头疼的东西，比如 Linux 内核中的调度器，用来调度进程。</p><p>在 RxJS 中，调度器是一个独立的概念，他其实完全可以单独拎出来使用。 RxJS 的调度器，本质就是决定函数执行的时机。</p><p>再简单点讲，它其实就是包装了诸如 <code>setInterval</code> 、 <code>Promise.then</code> 、 <code>requestAnimateFrame</code> 等的 API 。</p><h2 id="源码" tabindex="-1">源码 <a class="header-anchor" href="#源码">🔗</a></h2><h3 id="scheduler-和-action" tabindex="-1">Scheduler 和 Action <a class="header-anchor" href="#scheduler-和-action">🔗</a></h3><p>在 RxJS 中，调度器有两个核心的基类，一个是 <code>Scheduler</code> 、 一个是 <code>Action</code> 。</p><p>这两个基类的实现都非常的简单，源码如下：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Scheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> implements</span><span style="--s-dark:#80A665;--s-light:#59873A"> SchedulerLike</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> static</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> dateTimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">private</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> schedulerActionCtor</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Action</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> now</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 核心函数</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedulerActionCtor</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 核心函数</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里可以看到 <code>Action</code> 实现了 <code>Subscription</code> ，也就是 <code>Action</code> 应该也有一个取消订阅的操作，这个后面会说到，而 <code>Scheduler</code> 实现了 <code>SchedulerLike</code> 接口，这个接口抽象了类调度器的类型：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> SchedulerLike</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> TimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> interface</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimestampProvider</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  now</span><span style="--s-dark:#666666;--s-light:#999999">():</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里的 <code>TimestampProvider</code> 可以先忽略，在 <code>Scheduler</code> 的源码中，基本用不到这个属性。</p><p>回到 <code>Scheduler</code> 类，<code>Scheduler</code> 会通过构造函数持有一个 <code>Action</code> 的类（注意，这里是持有一个 <code>Action</code> 类，而不是一个 <code>Action</code> 类的实例），然后在 <code>schedule</code> 中实例化持有的 <code>Action</code> 类， 即代码中的 <code>new this.schedulerActionCtor&lt;T&gt;(this, work)</code> ，接着调用 <code>Action</code> 的 <code>schedule</code> 并返回自身，前面我们说过 <code>Action</code> 继承自 <code>Subscription</code> 。所以我们在通过 <code>Scheduler.prototype.schedule</code> 得到的对象其实就是一个 <code>Action</code> 对象。</p><p>我们可以简单地用箭头来描述此时的调用流向：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-text"><span class="line"><span>Scheduler.schedule</span></span>
<span class="line"><span>-&gt; new Action</span></span>
<span class="line"><span>-&gt; Action.schedule</span></span></code></pre><p>需要着重注意的是：我们的调度函数（ <code>work</code> ）是保存在 <code>Action</code> 中的，这点很重要。</p><p>在 RxJS 中，提供了四种不同的调度器，分别是 <code>asyncScheduler</code> 、 <code>asapScheduler</code> 、 <code>queueScheduler</code> 、 <code>animationFrameScheduler</code> ，需要注意，这些导出的对象已经是类的实例了，可以直接使用，不能通过 <code>new</code> 来调用。比如 <code>asyncScheduler</code> ，它的导出是下面这样子的：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>其中 <code>AsapScheduler</code> 、 <code>QueueScheduler</code> 和 <code>AnimationFrameScheduler</code> 都是从 <code>AsyncScheduler</code> 派生出来的，所以我们先看一下 <code>AsyncScheduler</code> 的实现。</p><h3 id="asyncscheduler-和-asyncaction" tabindex="-1">AsyncScheduler 和 AsyncAction <a class="header-anchor" href="#asyncscheduler-和-asyncaction">🔗</a></h3><p><code>AsyncScheduler</code> 的实现本质就是包装了 <code>setInterval</code> 。我们先看 <code>AsyncScheduler</code> 的整体实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 持有的 Action 实例，先不管</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Array</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> [];</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 调度的过程是否在执行中</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _active</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 最近一次调度对应的 id ，可能是 setInterval 、 setInterval 或者 requestAnimationFrame 的返回值</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _scheduled</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 持有 Action 类</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Action</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#80A665;--s-light:#59873A"> now</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">now</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> now</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>可以看到 <code>AsyncScheduler</code> 并没有重写 <code>Scheduler</code> 的 <code>schedule</code> ，所以当我们使用 <code>schedule</code> 的时候还是调用的 <code>Scheduler</code> 的 <code>schedule</code> 实现。 <code>AsyncScheduler</code> 还多了一个 <code>flush</code> 方法，这里我们先不管。</p><p>接着我们来看 <code>AsyncAction</code> 的实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 调度对应的 id ，在这里指 setInterval 返回的值</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 调度的上下文，通俗点讲就是回调的入参</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 调度延迟的时间，可以理解为传递给 setInterval 的第二个参数</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 是否处于调度过程中</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> pending</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // scheduler 为该实例对应的 Scheduler 实例</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // work 为持有的调度函数</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> _execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>看起来多了好多方法，我们可以先从重写的 <code>Action</code> 的 <code>schedule</code> 方法的位置开始：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 已经取消订阅了</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 更新参数，后面入参会替换</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 得到调度对应的 id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 该 Action 对应的 Scheduler 实例</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 非第一次调度</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 重新得到一个定时器 id </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 这里可能会重新请求一个新的 id ，即类似调用 clearInterval 然后再调用 setInterval</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 或者复用原本的 id ，因为这里我们包装的是 setInterval</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 调度即将开始，进入调度等待状态</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 更新调度的延迟时间</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 这里的 delay 放在后面更新是因为上面的 recycleAsyncId 会比较新旧的 delay 值来做一些操作</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 没有调度的话调用 requestAsyncId 来开始调度</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ??</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 返回自身，因为自身就是一个 Subscription</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里有几个重要的点：</p><ul><li>通过 <code>Scheduler</code> 的 <code>schedule</code> 来调用，每个 <code>Action</code> 只会执行一次，如果想获得类似 <code>setInterval</code> 的效果，需要手动在函数内部使用 <code>this.schedule</code> 来重新调用。</li></ul><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 只执行一次</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">hello world!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 类似 setInterval </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">hello world!</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 手动重新调度</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}),</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><ul><li>在 <code>AsyncScheduler</code> 内部中使用的是 <code>setInterval</code> 而非 <code>setTimeout</code> 作为底层实现，对此 RxJS 官方的解释是： 单个 <code>setInterval</code> 的执行间隔比起多个 <code>setTimeout</code> 的间隔更精确。</li></ul><blockquote><p>However, JS runtimes and timers distinguish between intervals achieved by serial <code>setTimeout</code> calls vs. a single <code>setInterval</code> call. An interval of serial <code>setTimeout</code> calls can be individually delayed, which delays scheduling the next <code>setTimeout</code>, and so on. <code>setInterval</code> attempts to guarantee the interval callback will be invoked more precisely to the interval period, regardless of load.</p></blockquote><ul><li>所有的 <code>Scheduler</code> 在内部都不会自动调用 <code>unsubscribe</code> 来取消自身的订阅，这是因为即使在多次的调度中，我们可能会通过额外的定时器来启动调度，比如：</li></ul><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 下面的调度在一个异步的操作中</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 同步的代码无法确认“未来”是否会被重新调度</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setTimeout</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>所以如果你只想执行单次的调度，最好在调度函数执行结束后调用 <code>unsubscribe</code> ，或者对返回的对象在合适的时机调用 <code>unsubscribe</code> ：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscription</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function </span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 下面的调度在一个异步的操作中</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 同步的代码无法确认“未来”是否会被重新调度</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ... 一些操作</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 取消订阅</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">  this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 2000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// ... 一些操作</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 在合适的时机取消订阅</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">subscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span></code></pre><p>回到 <code>schedule</code> 实现中，我们发现它主要关联了两个函数，一个是 <code>requestAsyncId</code> ，一个是 <code>recycleAsyncId</code> ，根据名字我们大致可以知道， <code>requestAsyncId</code> 应该就是请求调度，然后返回一个该调度的 id ，而 <code>recycleAsyncId</code> 大致是回收一个调度，这里的回收可以是取消调度器或者让调度器继续执行（什么都不做）。</p><p>我们先看 <code>requestAsyncId</code> ：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>可以看到它调用的不是原生的 <code>setInterval</code> ，而是在一个 <code>intervalProvider</code> 对象上的 <code>setInterval</code> ，我们看一下 <code>intervalProvider</code> 的实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">IntervalProvider</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">handler</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearInterval</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">)(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  delegate</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>可以发现默认情况下就是调用的 <code>setInterval</code> ，但是 RxJS 提供了一个 <code>delegate</code> 委派对象，我们可以通过它来覆盖默认的实现，比如：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999"> = {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 在每个宏任务执行完毕后再执行</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">((...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">handler</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">)), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">timeout</span><span style="--s-dark:#666666;--s-light:#999999">, ...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handler</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>当然很多时候我们并不会去覆盖默认的实现，所以 <code>requestAsyncId</code> 可以简单重写为：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> setInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>可以看到它的目标调度函数是 <code>Scheduler</code> 的 <code>flush</code> ，这可能就有点让人不解了，不是说需要调度的函数保存在了 <code>Action</code> 上吗，怎么又跑去调用 <code>Scheduler</code> 的方法了，别急，我们先看 <code>recycleAsyncId</code> 是如何实现的：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 复用</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 清除掉</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      intervalProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">clearInterval</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这段逻辑主要包括两个部分，一个是复用定时器，即不清除定时器，另一个就是清除定时器了，在前面我们说过， <code>Action</code> 中调用 <code>work</code> 是单次的，如果需要重复调度，我们需要手动的在函数内部使用 <code>this.schedule</code> 来重新调度。在判断中我们可以知道，只要延迟时间相同，那么就不会清除掉定时器，即：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule before.</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 复用调度器</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">  this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 3000</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">schedule after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span></code></pre><p>理解了这两个函数之后，我们再回到 <code>Scheduler</code> 看它的 <code>flush</code> 实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 当前正在执行调度函数中，只需放入待执行队列即可</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 调度完成，开始执行</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 标志位，表示已进入执行过程</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 遍历所有 actions 属性中保存的所有 Action </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    do</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 核心，我们实际调用的是 Action 的 execute 方法</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">)))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // 出错立即退出</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 执行过程结束</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 某个 Action 报错，它后面所有的 Action 直接取消掉</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 抛出错误</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      throw</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里需要搞清一个点，为什么需要用 <code>actions</code> 来保存同个 <code>Action</code> 的多个实例？</p><p>在需要调度的函数的内部，我们可能会通过 <code>this.schedule</code> 来创建一个新的调度，在 <code>AsyncScheduler</code> 中，这个 <code>actions</code> 实际上并不会有值，因为每次我们通过 <code>this.schedule</code>创建一个新的调度的时候，它会有两种情况，复用原来的调度器或者取消原来的调度器然后再创建一个，这两种都是延迟到接下来的宏任务中执行，而 <code>flush</code> 本身是同步执行的，所以在 <code>AsyncScheduler</code> 下， <code>actions</code> 不会有值， 即下面的代码不会执行到：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 不会执行到下面这个 if 内</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>在 <code>AsyncScheduler</code> 中， <code>actions</code> 属性用不到，但是在 <code>AsyncScheduler</code> 派生出的几种调度器中， <code>actions</code> 属性就发挥了作用，它为多个任务在<strong>同一个调度中</strong>进行统一处理提供了代码上的能力。</p><p>回到 <code>flush</code> 实现，在上面我们标注了核心为执行 <code>Action</code> 的 <code>execute</code> 方法，我们看一下它的实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">executing a cancelled action</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 调度已经结束，接下来要开始执行</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 核心，执行过程</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">_execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 存在错误的话返回错误</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 清除掉定时器</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 这里就是我们前面说过的，调度器的实现是单次非循环的</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这段代码还没有接触到执行 <code>work</code> 的核心， <code>work</code> 实际上是在 <code>_execute</code> 中执行的：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> _execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> _delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">errored</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">errorValue</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 执行了调度的函数</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">work</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> catch</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      errored</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      errorValue</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Scheduled action threw falsy error</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 错误取消订阅</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">errored</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> errorValue</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>RxJS 很多这种 <code>execute</code> 和 <code>_execute</code> 的设计，目的都是为了解耦一些操作，方便后续的子类进行重写的时候能够在最小的范围内进行。</p><p>到这里，我们就把 <code>AsyncScheduler</code> 的流程走完了，可能你会觉得很乱，我们可以梳理一下它的调用流程：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-text"><span class="line"><span>AsyncScheduler.schedule</span></span>
<span class="line"><span>-&gt; new AsyncAction</span></span>
<span class="line"><span>-&gt; AsyncAction.schedule</span></span>
<span class="line"><span>-&gt; AsyncAction.requestAsyncId （开始调度，目标执行函数为 flush ，此时 pending 置为 true ）</span></span>
<span class="line"><span>-&gt; AsyncScheduler.flush （调度（等待）结束，开始执行 flush ，此时 pending 置为 false ）</span></span>
<span class="line"><span>-&gt; AsyncAction.execute</span></span>
<span class="line"><span>-&gt; AsyncAction._execute （执行实际 work 函数的地方）</span></span></code></pre><p>在 Chrome 的 debug 中，我们也能清晰的看到对应的调用栈：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/27/202310271142144.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/27/202310271142144.avif" alt=""></a></p><p>另外作为一个 <code>Subscription</code> ，它的 <code>unsubscribe</code> 其实并不复杂：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> Action</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 没关闭过才执行一次关闭</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 清理状态</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">work</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 调度的状态置为 false ，因为我们不再执行这个函数了</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pending</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 核心，从 actions 中删除自己</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 对于 AsyncAction 自身，下面这段代码不会执行到，前面我们说过 AsyncAction 并不会存储到 actions 中。</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      arrRemove</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 取消掉定时器</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">        this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 跟之前 schedule 一样，由于 recycleAsyncId 需要判断新旧 delay ，所以放到 recycleAsyncId 后清理状态</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">      </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 父类的实现</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>对于 <code>AsyncAction</code> 来说，如果已经在调度状态了，那么核心就是取消掉定时器。</p><h3 id="asapscheduler-和-asapaction" tabindex="-1">AsapScheduler 和 AsapAction <a class="header-anchor" href="#asapscheduler-和-asapaction">🔗</a></h3><p>可能很多人和我一样，在第一次看到这个的实现的时候，一头污水， Asap ，什么意思？</p><p>在英文中，它是 as soon as possible 的缩写，意思是“尽可能快的”。</p><p>比如最近 cs2 转会期间猪猪对宝蓝被下放一事发出建议，希望有队伍能尽快签下他：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/30/202310300947615.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2023/10/30/202310300947615.avif" alt="Someone sign him ASAP"></a></p><p>（PS： NIP 终于不再执着 60 万了，猪猪你也不看看宝蓝最近打的什么鬼样子，被 bench 完全不意外，意外的是竟然这么久才 bench …）</p><p>不要被它的名字吓到，在内部中它其实就是包装了 <code>Promise.then</code> 而已。</p><p>如果你懂一点浏览器宏任务微任务的八股文的话，应该就能理解 <code>Promise.then</code> 比 <code>setTimeout</code> 或者 <code>setInterval</code> 快的原因了。</p><p><code>AsapScheduler</code> 和 <code>AsapAction</code> 分别继承了 <code>AsyncScheduler</code> 和 <code>AsyncAction</code> ，也就是是说它们的执行流程大体是相似的。</p><p>我们先看下 <code>AsapScheduler</code> 如何继承 <code>AsyncScheduler</code> ：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里我们先不管它是如何重写 <code>flush</code> 方法的，我们再看下 <code>AsapAction</code> 是如何继承的：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>可以看到重写了 <code>requestAsyncId</code> 和 <code>recycleAsyncId</code> 方法。</p><p>从 <code>AsyncScheduler</code> 执行的过程，我们先看 <code>requestAsyncId</code> 的实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 如果设定了延迟时间，那么回退到 AsyncAction</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 这里就和 AsyncAction 显著不同了</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // AsyncAction 直接调用 flush ，而这里是手动 push 进 actions 中，再进行 setImmediate（默认下为 Promise.then ） 调度 </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 在未处于调度过程时，启动调度，并把调度的 id 挂载到 Scheduler 的 _scheduled 属性上</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 如果处于调度过程中，则复用已有的调度器 id</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">flush</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">bind</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">)));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里使用的是一个 <code>setImmediate</code> 的函数，和 <code>setInterval</code> 一样， RxJS 封装了它们，并且我们也能通过 <code>delegate</code> 对象来覆盖。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// immediateProvider.ts</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> type</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">./timerHandle</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Immediate</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ImmediateProvider</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // When accessing the delegate, use the variable rather than `this` so that</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // the functions can be called without being bound to the provider.</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">setImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">)(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delegate</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delegate</span><span style="--s-dark:#666666;--s-light:#999999">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearImmediate</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">)(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  delegate</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// Immediate.ts</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Immediate</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> nextHandle</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">] = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      resolved</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">&amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> cb</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handle</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>在前面我们说过， <code>AsapScheduler</code> 实际上就是封装了 <code>Promise.then</code> ， <code>Promise.then</code> 和 <code>setInterval</code> 的区别还是很大的，除了执行时机的不同之外， <code>setInterval</code> 调用之后会返回一个 id ，后面我们可以通过 <code>clearInterval</code> 来取消掉这个定时器，而 <code>Promise.then</code> 是没有这个原生的功能的，在 RxJS 中，通过计数器以及一个用来标记的字面对象来实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 每个 Promise.then 对应一个唯一的 id</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 每调用 Promise.then 就自增 nextHandle，确保 id 唯一</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">nextHandle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 一个 Promise 对象，用来调用 then 生成一个微任务</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 要注意这里是懒加载的，不然 zone.js 可能无法代理这个 Promise 对象</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Promise</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 用来保存当前正在调度的 id 的状态，如果 activeHandles[id] = true 则此时调度依然存在，如果不存在则调度应该被取消，也就是不执行 Promise.then 的回调</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">: { [</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">]: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999"> } =</span><span style="--s-dark:#666666;--s-light:#999999"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 取消一个微任务</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> boolean</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> in</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 封装</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">Immediate</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  setImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 生成一个唯一 id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> nextHandle</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 标记为需要调度</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeHandles</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">] = </span><span style="--s-dark:#4D9375;--s-light:#1E754F">true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 初始化全局的 Promise 对象</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">) {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      resolved</span><span style="--s-dark:#666666;--s-light:#999999"> = </span><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 开始调度</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 核心，如果 findAndClearHandle 返回了 true ，那么才执行 cb</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(() =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">) </span><span style="--s-dark:#CB7676;--s-light:#AB5959">&amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> cb</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 返回 id</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handle</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">): </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 清除调度</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    findAndClearHandle</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">handle</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">};</span></span></code></pre><p>原生的 <code>Promise</code> 并没有取消这一说法， <code>Promise</code> 是对“未来”的一种承诺，要么成功，要么失败， RxJS 通过一个唯一的 id 来标记一个 <code>Promise.then</code> 的回调，它的简化代码类似下面这样：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#B8A965;--s-light:#998418"> Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">cb</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">resolved</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    cb</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 执行一些操作</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 让 cb 调度</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">]</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 执行一些操作</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 不想让 cb 调度了</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">delete</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> map</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">pId</span><span style="--s-dark:#666666;--s-light:#999999">];</span></span></code></pre><p>实际上， <code>Promise.then</code> 确实执行了，但是通过包括一段对标记的判断来实现“取消”调度，实际上是没执行到调度（ <code>&amp;&amp;</code> 操作符短路了）。</p><p>接下来我们看一下 <code>recycleAsyncId</code> 的实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> |</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 如果设定了延迟时间，那么回退到 AsyncAction</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">recycleAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 如果已经没有任务需要执行了的话，清掉调度器的 id</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 这样下一次的调度才能正确获取新的调度器 id</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> -</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 1</span><span style="--s-dark:#666666;--s-light:#999999">]?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      immediateProvider</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">clearImmediate</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 重要判断，由于我们会嵌套调用 schedule ，此时在执行外层 schedule 结束后我们会调用本方法来复用或者取消调度器，但是在内部执行的时候 _scheduled 就会更新成新的调度器 id 的值了，所以要判断两者是否一致，不然会导致嵌套的调度调用不全，具体可以看 https://github.com/ReactiveX/rxjs/issues/6747</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里可能需对两个重写的函数配合起来理解。</p><p>在 <code>AsapScheduler</code> 中，在一次同步执行的过程中产生的新的调度都会共用一个调度器的 id ，而这个 id 挂载在父类 <code>AsyncScheduler</code> 的 <code>_schedule</code> 属性上。</p><p>之前我们说过 <code>AsyncScheduler</code> 中暂时使用不到 <code>_schedule</code> 属性，因为对于 <code>AsyncScheduler</code> ，每次调度都会产生新的调度器 id ，而 <code>AsapScheduler</code> 则是共用一个调度器 id ，在一次调度中对于所有嵌套的调度统一批处理。我们可以用下面的例子来解释：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 启动一个调度，得到一个 id = 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 放到 actions 中</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 启动一个调度，得到一个 id = 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 放到 actions 中</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 放到 actions 中</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 复用前面的调度 id = 2</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span></code></pre><p>上面的代码会输出 1 2 3 4 ，即最外层的 <code>schedule</code> 使用一次 <code>Promise.then</code> 调度，内部两个 <code>schedule</code> 使用一次 <code>Promise.then</code> ，即合并执行。</p><p>这也符合原生 <code>Promise.then</code> 的执行顺序，如果在一个微任务中继续启动一个微任务，那么新的微任务将会放到当前微任务的后面，在当前微任务执行完成后立即执行新的微任务，上面的写法就类似如下 <code>Promise.then</code> 的写法：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  Promise</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">resolve</span><span style="--s-dark:#666666;--s-light:#999999">().</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 输出 1 2 3 4</span></span></code></pre><p>接着我们回到 <code>AsapScheduler</code> 中，看看 <code>flush</code> 是如何重写的：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> AsapScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> void</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 当前的 Asap 调度器 id ，可能不存在</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 如果把 AsapScheduler 当作 AsyncScheduler 使用的话，这里的 _scheduled 就不会有值</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 因为我们前面说过， AsyncScheduler 的调度器 id 位于每个 Action 实例中</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">flushId</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 清除调度器 id ，如果调度器 id 存在，（这个调度器 id 一定是基于 Promise.then 的）那么本次的执行就会执行全部的任务</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 清除掉，其他调度才能正确地通过 requestAsyncId 获取一个新的调度 id</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_scheduled</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#666666;--s-light:#999999">{</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">()</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    do</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 批处理，把所有调度器 id 相同的 Action 都执行掉</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">)))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        break</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 如果当前处理的是 AsyncAction ，那么 while 只会执行一次，因为如果我们在一个 AsyncAction 中请求 AsapAction 的话， action.id === flushId 不成立， flushId 此时一定是 undefined 。</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 而如果处理的是 AsapAction 则此时则会一次性执行掉所有存在的任务。直到某个 action 的 id 不为当前批处理的 id （比如嵌套调用的情况）。</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> flushId</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 错误情况</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">error</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      while</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">action</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span><span style="--s-dark:#666666;--s-light:#999999">])</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> flushId</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> actions</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">shift</span><span style="--s-dark:#666666;--s-light:#999999">())</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        action</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      throw</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> error</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>可能你在看这个实现的时候有点晕，其实只要明白以下的两点</p><ul><li>在传入的 <code>Action</code> 是 <code>AsyncAction</code> 时，此时 <code>actions</code> 数组可能为空也可能不为空，这取决于你在传入的 <code>AsyncAction</code> 中所进行的动作，但是可以肯定的是，这个 <code>AsyncAction</code> 前面一定不会有 <code>AsapAction</code> 了，因为我们处在一个宏任务中，如果此时它的前面存在未执行的 <code>AsapAction</code> ，那么这是矛盾的，因为这些 <code>AsapAction</code> 应该在上一个微任务队列就被清空了。</li><li>在传入的 <code>Action</code> 是 <code>AsapAction</code> 时，此时 <code>actions</code> 可能为空也可能不为空，这取决于你在传入的 <code>AsapAction</code> 中所进行的动作。但是 <code>actions</code> 一定不会有 <code>AsyncAction</code> 实例，这是因为 <code>AsyncAction</code> 只会在 <code>flush</code> 的时候传入，并不会手动加入到 <code>actions</code> 中。</li></ul><p>这个方法其实就是兼容了 <code>AsyncScheduler</code> 的 <code>flush</code> 实现，并且额外实现了批处理本次微任务的全部 <code>Action</code> 的功能。</p><h3 id="animationframescheduler-和-animationframeaction" tabindex="-1">AnimationFrameScheduler 和 AnimationFrameAction <a class="header-anchor" href="#animationframescheduler-和-animationframeaction">🔗</a></h3><p>这两者的实现和 <code>AsapScheduler</code> 和 <code>AsapAction</code> 几乎一样，唯一的区别就是从 <code>Promise.then</code> 切换到了 <code>requestAnimateFrame</code> ，所以这里就不讲了。</p><p>需要注意的一点是， <code>AnimationFrameScheduler</code> 似乎有个遗留的 bug ，在之前修复 <code>AsapScheduler</code> 的时候没有顺道修好像？</p><p>不过这也只是我的猜测，贴上相关的 <a href="https://github.com/ReactiveX/rxjs/issues/7196" target="_blank" rel="noopener">asapScheduler: Scheduling inside of an executing action only works once</a></p><p>对于 <code>AnimationFrameScheduler</code> ，现在的问题是如果嵌套使用的话会导致只执行一次嵌套的调度，如下图所示：</p><p><a data-fancybox="doc-gallery" href="https://user-images.githubusercontent.com/48575405/279329977-5427887c-3aab-4594-aee3-b6e709336b8d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/48575405/279329977-5427887c-3aab-4594-aee3-b6e709336b8d.png" alt=""></a></p><p>而如果使用原生的 <code>requestAnimateFrame</code> 则没有这个问题，如下图：</p><p><a data-fancybox="doc-gallery" href="https://user-images.githubusercontent.com/48575405/279330102-0745fb8d-be07-44c3-a452-2699e161630d.png" target="_blank" rel="noopener noreferrer"><img src="https://user-images.githubusercontent.com/48575405/279330102-0745fb8d-be07-44c3-a452-2699e161630d.png" alt=""></a></p><p>我也在上面的 issue 中询问了维护者，看他是怎么回复的吧。</p><h3 id="queuescheduler-和-queueaction" tabindex="-1">QueueScheduler 和 QueueAction <a class="header-anchor" href="#queuescheduler-和-queueaction">🔗</a></h3><p><code>QueueScheduler</code> 是一种“同步”的 <code>AsapScheduler</code> ，可能这句话会让你觉得很懵逼。</p><p>在 <code>AsapScheduler</code> 中，我们会把任务延迟到微任务队列中执行，如果在微任务中继续启动 <code>AsapScheduler</code> 的话，那么这些任务会被放到 <code>actions</code> 属性中，然后在当前 Action 执行完毕之后，继续执行 <code>actions</code> 中的剩余 Action 。</p><p>而 <code>QueueScheduler</code> 则是立即执行任务，如果在执行的任务中继续调用 <code>QueueScheduler</code> ，那么会放到 <code>actions</code> 属性中，在当前 Action 执行完毕之后继续执行 <code>actions</code> 中的剩余 Action 。</p><p>我们可以用下面的代码来表示两者的区别：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">before</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  asapScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 上面例子输出：</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// before</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// after</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 4</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 3</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">before</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  queueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">3</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  });</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">4</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">after</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 上面例子输出：</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// before</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 1</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 4</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 2</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// 3</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// after</span></span></code></pre><p><code>QueueScheduler</code> 只是继承了 <code>AsyncScheduler</code> 而已，并没有重写什么：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> QueueScheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncScheduler</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里我们的重点主要是 <code>QueueAction</code> ，它继承了 <code>AsyncAction</code> ：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> class</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> QueueAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> extends</span><span style="--s-dark:#80A665;--s-light:#59873A"> AsyncAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  constructor</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">protected</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">QueueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> work</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">void</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    super</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> work</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Subscription</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 回退到 AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 核心，放到 actions 属性中</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">    this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  public</span><span style="--s-dark:#80A665;--s-light:#59873A"> execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">closed</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // 回退到 AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      ?</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      :</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">_execute</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  protected</span><span style="--s-dark:#80A665;--s-light:#59873A"> requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">QueueScheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> TimerHandle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 回退到 AsyncScheduler</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> ((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !=</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> null</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> super</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">requestAsyncId</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> id</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 放到 actions 中</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">flush</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">    </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 返回 0 ，并不是意味着一个调度器的 id 为 0， 而是表示调度器已被清除，这里返回 0 只是类型需要。</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>通过代码我们可以知道，当我们通过 <code>queueScheduler.schedule</code> 进行调度的时候，它会同步执行到 <code>requestAsyncId</code> 方法，此时直接执行了 <code>scheduler.flush</code> ，此时会直接开始调度，而嵌套的 <code>queueScheduler.schedule</code> 调用，也会走到 <code>scheduler.flush</code> ，但是此时 <code>_active</code> 此时为 <code>true</code> ，只会把它推入到 <code>actions</code> 中，然后当第一个执行完毕之后，剩余 <code>actions</code> 内的 <code>Action</code> 就会被依次执行。</p><h2 id="scheduler-和-observable" tabindex="-1">Scheduler 和 Observable <a class="header-anchor" href="#scheduler-和-observable">🔗</a></h2><p>对于一个 <code>Observable</code> ，有两个地方我们可以让 <code>Scheduler</code> 织入，一个是 <code>subscribe</code> 的时候，一个是 <code>next</code> （或者 <code>complete</code> 或者 <code>error</code> ） 的时候。</p><p>RxJS 提供了两个管道 <code>subscribeOn</code> 和 <code>observeOn</code> 来对应这两种情况。</p><h3 id="subscribeon" tabindex="-1">subscribeOn <a class="header-anchor" href="#subscribeon">🔗</a></h3><p><code>subscribeOn</code> 决定的是订阅操作的时机。</p><p>它的实现很简单，通过传入的 <code>Scheduler</code> 来启动一个调度，在调度函数的内部执行 <code>subscribe</code> 操作：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> subscribeOn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">){</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">source</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Observable</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscriber</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // .schedule 返回了一个 Subscription </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      subscriber</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> source</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">subscribe</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">subscriber</span><span style="--s-dark:#666666;--s-light:#999999">),</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    });</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h3 id="observeon" tabindex="-1">ObserveOn <a class="header-anchor" href="#observeon">🔗</a></h3><p><code>observeOn</code> 决定的是订阅了之后发出值的时机。</p><p>它的实现同样不难，通过代理原来的 <code>subscriber</code> ，重写对应的三个方法来实现：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> observeOn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">source</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Observable</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      source</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">subscribe</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // 之前我们写过的 operate 操作符，可以代理 subscriber ，重写方法。</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        operate</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">          destination</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          next</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">next</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          error</span><span style="--s-dark:#666666;--s-light:#999999">: (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">err</span><span style="--s-dark:#666666;--s-light:#999999">) =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">error</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">err</span><span style="--s-dark:#666666;--s-light:#999999">), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          complete</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#80A665;--s-light:#59873A">executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">, () =&gt; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">destination</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">complete</span><span style="--s-dark:#666666;--s-light:#999999">(), </span><span style="--s-dark:#BD976A;--s-light:#B07D48">delay</span><span style="--s-dark:#666666;--s-light:#999999">),</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      );</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    });</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>这里使用了 <code>executeSchedule</code> ，它的内部实现就是通过调度器来启动相应的 <code>work</code> 。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> executeSchedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  scheduler</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  work</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  delay</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  repeat</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">){</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 启动调度</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">function </span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerAction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    work</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">repeat</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 这里如果是同步的调度器，那么我们需要手动添加</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C99076;--s-light:#A65E2B">this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">schedule</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959">null</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">));</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 这里的 observeOn 只会走到这里</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // 执行一次之后不再执行，需要手动取消订阅</span></span>
<span class="line"><span style="--s-dark:#C99076;--s-light:#A65E2B">      this</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">unsubscribe</span><span style="--s-dark:#666666;--s-light:#999999">();</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  },</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> delay</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 添加，即使重复添加也没有关系，因为 Subscription 是通过 Set 来保存这些 Subscription 的</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  parentSubscription</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 这个返回我们在 observeOn 不会用到所以不管。</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">repeat</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduleSubscription</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h3 id="其他操作符和管道" tabindex="-1">其他操作符和管道 <a class="header-anchor" href="#其他操作符和管道">🔗</a></h3><p>在 RxJS 中，虽然很多时候我们不会明显的使用到 <code>Scheduler</code> ，但是某些操作符或者管道默认情况下都是可以通过最后一个入参来控制，比如 <code>delay</code> 管道，在默认情况下它会使用 <code>asyncScheduler</code> 作为调度器：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> delay</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  due</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">number</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Date</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 默认调度器</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  scheduler</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">SchedulerLike</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> asyncScheduler</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> MonoTypeOperatorFunction</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">duration</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> timer</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">due</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> scheduler</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#80A665;--s-light:#59873A"> delayWhen</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> duration</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h1 id="后记" tabindex="-1">后记 <a class="header-anchor" href="#后记">🔗</a></h1><p>在逛 issue 的时候，发现了作者说在 8.0 可能会发布一个更加轻巧的调度器，说实话，作为一个切图仔，我还是不是很喜欢继承，这东西对脑的算力有点高，恰好我的🧠又很一般，方法跳来跳去，很容易就阅读疲劳，每次调用方法都得思考它的子类是不是重写了，他这段逻辑是不是只对子类有作用的？</p><p>而且我总觉得这个调度器的继承关系有点让人懵逼，作为基类的 <code>AsyncScheduler</code> 竟然会有 <code>_schedule</code> 这种子类才要用到的属性… 当然，这里只是小小的吐槽，咱也不是什么 OOP 高手，而且写代码有时候真的不是那样一定对这样一定错，有可能在某些情况下必须写成错的方式才能好处理，所以保持谦虚，不要妄自菲薄。</p><p>在逛 issue 的时候，发现有人抱怨作者维护的太慢了，作者回了句：</p><blockquote><p>A friendly reminder to some of the snark in here: This is free software maintained by unpaid volunteers. I understand you’re frustrated, but I’m quite literally not paid to deal with you.</p></blockquote><p>大意就是“免费软件，我没空修你得等着，抱怨是没用的”。 我还是很支持作者的，选择开源软件，你就应该明白，免费的往往就是最贵的，大家可以为爱发电，也可以立马崩撤卖溜。不过 RxJS 作为 Angular 的一个重要的依赖库（另一个应该是 zone.js ），它的稳定还是很重要的，虽然国内 Angular 开发者可能并不多。</p><p>RxJS 的源码部分应该就到这里了，在大半年前，我发了几篇关于 RxJS 使用的帖子，而现在，我发了关于 RxJS 的几篇源码解析的文章。当然我写的可能会有错误，可能写的不能让所有对 RxJS 感兴趣的人明白它的内部实现，但如果有某个人了解了，领悟了，那么我的价值就实现了。如果你发现帖子中有任何代码错误，逻辑错误，书写错误的问题，可以通过下面的评论来反馈，非常感谢！</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#RxJS</div><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/d8804bf6ed5f" class="" truncate="" title="TypeScript 5.3（译）"><i class="i-mi:chevron-left" mr-1=""></i><span>TypeScript 5.3（译）</span></a><a href="/58091f9cefdf" class="" ml-auto="" truncate="" title="RxJS 源码解读之派生 Subject"><span>RxJS 源码解读之派生 Subject</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-93b0ae89="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-93b0ae89=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-93b0ae89=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-93b0ae89=""></i></div><div flex="~ col grow" gap-4="" data-v-93b0ae89=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-93b0ae89=""></textarea><div flex="" items-start="" justify-between="" data-v-93b0ae89=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-93b0ae89="">支持 Markdown 语法 </a><button class="mujika-git-talk-button" cursor-pointer="" data-v-93b0ae89="">点击登录</button></div></div></div><!--]--></div></div><!----><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT © Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。</div></footer></div></div></body></html>