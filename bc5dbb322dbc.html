<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>记录 uniapp 微信小程序登录流程</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-4gPi1Ho2.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-afYcuv6x.css"><link rel="modulepreload" crossorigin="" href="/assets/记录-uniapp-微信小程序登录流程-87etNWYK.js"><meta property="og:title" content="记录 uniapp 微信小程序登录流程"><meta name="twitter:title" content="记录 uniapp 微信小程序登录流程"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">记录 uniapp 微信小程序登录流程</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2024-12-06 00:04</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2024-12-06 00:04</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/编程">编程</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">978</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">4 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言">🔗</a></h1><p>记录 uniapp 微信小程序登录流程。</p><h1 id="正文" tabindex="-1">正文 <a class="header-anchor" href="#正文">🔗</a></h1><p>之前做过一个基于 uniapp 的小程序，当时需要通过微信绑定的手机号来串联登录流程，在此做一个记录。</p><p>本文基于微信绑定的手机号来做唯一 ID ，非 <code>openid</code> 。</p><p>首先，每个微信小程序都会有一个 <code>appid</code> 和 <code>appsecret</code> 。登录微信公众平台，选择小程序登录后即可看到，比如我微信账号的小程序测试号：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/05/20241205224625331.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/05/20241205224625331.avif" alt=""></a></p><p>这两个东西都不放在前端代码中，特别是 <code>appsecret</code> ，后面的接口是要根据该字段来验证权限的。</p><h2 id="前端获取-code" tabindex="-1">前端获取 code <a class="header-anchor" href="#前端获取-code">🔗</a></h2><p>前端首先通过 <code>uni.login</code> 来获取 code ，这个 API 在微信平台上的接口为 <code>wx.login</code> 。这个 code 后面要用到。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#80A665;--s-light:#59873A"> getCode</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> async</span><span style="--s-dark:#666666;--s-light:#999999"> ()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> code</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> uni</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">login</span><span style="--s-dark:#666666;--s-light:#999999">({});</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> code</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h2 id="后端获取-openid" tabindex="-1">后端获取 openid <a class="header-anchor" href="#后端获取-openid">🔗</a></h2><p>这一步要用到上一步的 <code>code</code> 。</p><p>后端调用微信的接口：<a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html" target="_blank" rel="noopener">GET https://api.weixin.qq.com/sns/jscode2session</a>，这个接口需要 <code>appid</code> 和 <code>appsecret</code> 和上一步的 <code>code</code> 。</p><p>然后我们可以得到 <code>openid</code> ，还有 <code>unionid</code> 等信息。这里我们只要 <code>openid</code> 。</p><h2 id="后端获取-accesstoken" tabindex="-1">后端获取 accessToken <a class="header-anchor" href="#后端获取-accesstoken">🔗</a></h2><p>这一步获取 <code>accessToken</code> ，后面的流程需要用到。</p><p>后端调用微信的接口：<a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/mp-access-token/getAccessToken.html" target="_blank" rel="noopener">GET https://api.weixin.qq.com/cgi-bin/token</a>，这个接口需要 <code>appid</code> 和 <code>appsecret</code> 。</p><h2 id="前端获取-phonecode" tabindex="-1">前端获取 phoneCode <a class="header-anchor" href="#前端获取-phonecode">🔗</a></h2><p>这一步也是获取一个 <code>code</code> ，不过这个 <code>code</code> 是来获取手机信息的，这里就叫成 <code>phoneCode</code> 。</p><p>在微信的文档中，有两种获取该 <code>phoneCode</code> 的方式，区别为得到的手机号是否实时验证。</p><ul><li><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html" target="_blank" rel="noopener">手机号快速验证组件</a></li><li><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getRealtimePhoneNumber.html" target="_blank" rel="noopener">手机号实时验证组件</a></li></ul><p>在之前的项目中，我们用的是第一个。在文档中我们需要按如下来触发获取 <code>phoneCode</code> 。</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-html"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  open-type</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">getPhoneNumber</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34"> </span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  bindgetphonenumber</span><span style="--s-dark:#666666;--s-light:#999999">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">getPhoneNumber</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">  获取手机号</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F">button</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span></code></pre><p>点击这个按钮就会弹出一个手机号码选择框：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/06/20241206000223469.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/06/20241206000223469.avif" alt=""></a></p><p>这里可以根据 UI 来改为不同的触发形式，不一定是点击文字，你也可以在内部显示一个图片等等，把这里的 <code>button</code> 当成一个 <code>view</code> 就行，不过注意要清除 <code>button</code> 的默认样式：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-css"><span class="line"><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearButtonStyle</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  padding</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  margin</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  border</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> none</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  appearance</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> none</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">/* 去掉 button 的边框 */</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">clearButtonStyle</span><span style="--s-dark:#666666;--s-light:#999999">::</span><span style="--s-dark:#BD976A;--s-light:#B07D48">after</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  border</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C99076;--s-light:#A65E2B"> none</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>然后我们在 <code>getPhoneNumber</code> 函数的内部就可以获取到 <code>phoneCode</code> ：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#80A665;--s-light:#59873A"> getPhoneNumber</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">detail</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">errMsg</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">getPhoneNumber:ok</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 这里就获取到了 phoneCode 了。</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phoneCode</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">detail</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">code</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 可以做提示</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><h2 id="后端获取手机号" tabindex="-1">后端获取手机号 <a class="header-anchor" href="#后端获取手机号">🔗</a></h2><p>根据前面获取的参数，在这一步我们就可以获取用户选择的手机号。</p><p>后端调用微信的接口：<a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html" target="_blank" rel="noopener">POST https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=ACCESS_TOKEN</a>，这个接口需要 <code>openid</code> ， <code>accessToken</code> 和上一步的 <code>phoneCode</code> 。</p><p>在返回的参数中就能得到明文手机号：</p><p><a data-fancybox="doc-gallery" href="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/05/20241205234222302.avif" target="_blank" rel="noopener noreferrer"><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2024/12/05/20241205234222302.avif" alt=""></a></p><p>接着就是用这个手机号验证用户是否存在，存在就下发一个 token ，不存在就用这个手机号创建一个用户，然后一样下发 token 。</p><h1 id="后记" tabindex="-1">后记 <a class="header-anchor" href="#后记">🔗</a></h1><p>最后总结一下流程，起点为通过 <code>button</code> 的 <code>getPhoneNumber</code> 方法：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#80A665;--s-light:#59873A"> getPhoneNumber</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> async</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">detail</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">errMsg</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">getPhoneNumber:ok</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> code</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> uni</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">login</span><span style="--s-dark:#666666;--s-light:#999999">({});</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phoneCode</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> e</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">detail</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">code</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // loginByWXApi 这个为后端的接口，非微信接口。</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> token</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> userInfo</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> loginByWXApi</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">code</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phoneCode</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // 可以做提示</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>然后后端的流程（这里以 js 代码为例）：</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> appid</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">xxx</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> appsecret</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">xxx</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#80A665;--s-light:#59873A"> loginByWXApi</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> async</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">code</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phoneCode</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 获取 openid</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> openid</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> fetch</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">https://api.weixin.qq.com/sns/jscode2session?grant_type=authorization_code&amp;appid=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">appid</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">&amp;secret=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">appsecret</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">&amp;js_code=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">code</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resp</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> resp</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">json</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 获取 accessToken </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> access_token</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> fetch</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">appid</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D;--s-light:#B56959">&amp;secret=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">appsecret</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#666666;--s-light:#999999">).</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resp</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> resp</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">json</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 获取手机号</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phone_info</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> await</span><span style="--s-dark:#80A665;--s-light:#59873A"> fetch</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=</span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">access_token</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    methods</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">POST</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    body</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> JSON</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">stringify</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">      code</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phoneCode</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      openid</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }).</span><span style="--s-dark:#80A665;--s-light:#59873A">then</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">resp</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> resp</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">json</span><span style="--s-dark:#666666;--s-light:#999999">());</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> purePhoneNumber</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> phone_info</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // 获取手机号后的流程...</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">    token</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> "</span><span style="--s-dark:#C98A7D;--s-light:#B56959">xxx</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    userInfo</span><span style="--s-dark:#DBD7CAEE;--s-light:#393A34">: </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span><span style="--s-dark:#C98A7D;--s-light:#B56959">xxx</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">"</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#uniapp</div><div>#微信</div><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/b685130a8579" class="" truncate="" title="记录 uniapp 微信小程序获取定位流程"><i class="i-mi:chevron-left" mr-1=""></i><span>记录 uniapp 微信小程序获取定位流程</span></a><a href="/3dba217ce9f2" class="" ml-auto="" truncate="" title="记录一次在 windows 上安装 Rocky Linux"><span>记录一次在 windows 上安装 Rocky Linux</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-93b0ae89="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-93b0ae89=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-93b0ae89=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-93b0ae89=""></i></div><div flex="~ col grow" gap-4="" data-v-93b0ae89=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-93b0ae89=""></textarea><div flex="" items-start="" justify-between="" data-v-93b0ae89=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-93b0ae89="">支持 Markdown 语法 </a><button class="mujika-git-talk-button" cursor-pointer="" data-v-93b0ae89="">点击登录</button></div></div></div><!--]--></div></div><!----><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT © Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。</div></footer></div></div></body></html>