import{createElementBlock as t,openBlock as a,createStaticVNode as n}from"vue";const o={class:"kan-doc"},c="JavaScriptä¸­çš„Tasks, microtasks, queues and schedulesï¼ˆè¯‘ï¼‰",h=1591928364,d="2020-06-12T10:19:24.000Z",k="2023-02-13T18:28:44.000Z",u=["JavaScript"],g=["è¯‘æ–‡"],b=18978,m={__name:"JavaScriptä¸­çš„Tasks-microtasks-queues-and-schedulesï¼ˆè¯‘ï¼‰",setup(l,{expose:e}){return e({frontmatter:{title:"JavaScriptä¸­çš„Tasks, microtasks, queues and schedulesï¼ˆè¯‘ï¼‰",key:1591928364,date:"2020-06-12T10:19:24.000Z",updated:"2023-02-13T18:28:44.000Z",tags:["JavaScript"],categories:["è¯‘æ–‡"],wordCount:18978}}),(r,s)=>(a(),t("div",o,s[0]||(s[0]=[n(`<h1 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€">ğŸ”—</a></h1><p>ç½‘ä¸Šçœ‹åˆ°çš„ï¼Œå…³äºJavaScriptçš„æ–‡ç« ï¼Œæ„Ÿè§‰æŒºä¸é”™çš„ï¼Œè°·æ­Œçš„ä¸€ä¸ªå·¥ç¨‹å¸ˆå†™çš„ï¼ˆåº”è¯¥ï¼‰ï¼Œè¯•ç€ç¿»è¯‘å­¦ä¹ ä¸‹</p><h1 id="è¯‘æ–‡" tabindex="-1">è¯‘æ–‡ <a class="header-anchor" href="#è¯‘æ–‡">ğŸ”—</a></h1><h2 id="tasks-microtasks-queues-and-schedules" tabindex="-1">Tasks, microtasks, queues and schedules <a class="header-anchor" href="#tasks-microtasks-queues-and-schedules">ğŸ”—</a></h2><blockquote><p>åŸæ–‡åœ°å€ <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener">Tasks, microtasks, queues and schedules</a> When I told my colleague <a href="https://twitter.com/gauntface" target="_blank" rel="noopener">Matt Gaunt</a> I was thinking of writing a piece on microtask queueing and execution within the browserâ€™s event loop, he said â€œIâ€™ll be honest with you Jake, Iâ€™m not going to read thatâ€. Well, Iâ€™ve written it anyway, so weâ€™re all going to sit here and enjoy it, ok?</p></blockquote><p>è¯‘ï¼šå½“æˆ‘å‘Šè¯‰æˆ‘çš„åŒäº‹Matt Gauntæˆ‘æƒ³å†™ä¸€ç¯‡å…³äºå¾®ä»»åŠ¡åœ¨æµè§ˆå™¨äº‹ä»¶å¾ªç¯å†…çš„é˜Ÿåˆ—å’Œæ‰§è¡Œçš„æ–‡ç« æ—¶ï¼Œä»–å’Œæˆ‘è¯´ï¼šâ€œè€å®è®²ï¼Œæˆ‘ä¸ä¼šå»è¯»è¿™ç¯‡æ–‡ç« çš„â€ã€‚emmmï¼Œåæ­£æˆ‘éƒ½å†™äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åä¸‹æ¥ï¼ˆæ³¡ä¸ªèŒ¶ï¼‰äº«å—ï¼ˆ<del>æŠ˜ç£¨è‡ªå·±</del>ï¼‰ä¸‹å§ã€‚</p><p>ä¸Šæ¥å°±æ˜¯ä¸€æ®µåæ§½ï¼Œå¯ä»¥çš„ï¼Œæ˜¯æˆ‘å–œæ¬¢çš„ç¨‹åºå‘˜<del>ç”·äºº</del>ã€‚</p><blockquote><p>Actually, if videoâ€™s more your thing, <a href="https://twitter.com/philip_roberts" target="_blank" rel="noopener">Philip Roberts</a> gave a great talk at <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ" target="_blank" rel="noopener">JSConf on the event loop</a> - microtasks arenâ€™t covered, but itâ€™s a great introduction to the rest. Anyway, on with the showâ€¦</p></blockquote><p>è¯‘ï¼šäº‹å®ä¸Šï¼Œå¦‚æœï¼ˆä½ è§‰å¾—ï¼‰è§†é¢‘å¯ä»¥å­¦åˆ°æ›´å¤šä¸œè¥¿çš„è¯ï¼ŒPhilip Rpbertsæä¾›äº†ä¸€æ®µå…³äº<strong>JSConf on event loop</strong>çš„å¾ˆæ£’çš„æ¼”è®²ï¼Œè™½ç„¶æ²¡æœ‰è¦†ç›–å¾®ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥ä½œä¸ºåœ¨ä¼‘æ¯æ—¶çš„ä¸€ç¯‡å¾ˆå¥½çš„è¯»ç‰©ã€‚okï¼Œæ¥ä¸‹æ¥å¼€å§‹æ˜¯æ­£æ–‡â€¦</p><blockquote><p>Take this little bit of JavaScript:</p></blockquote><p>è¯‘ï¼šè§‚å¯Ÿè¿™ä¸€å°å—çš„JavaScriptä»£ç </p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">script start</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A;">setTimeout</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">setTimeout</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">},</span><span style="--s-dark:#4C9A91;--s-light:#2F798A;"> 0</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418;">Promise</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">resolve</span><span style="--s-dark:#666666;--s-light:#999999;">().</span><span style="--s-dark:#80A665;--s-light:#59873A;">then</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">promise1</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">}).</span><span style="--s-dark:#80A665;--s-light:#59873A;">then</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">promise2</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">script end</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span></code></pre><blockquote><p>In what order should the logs appear?</p></blockquote><p>è¯‘ï¼šæ‰“å°çš„æ–‡æœ¬å°†ä¼šä»¥ä»€ä¹ˆé¡ºåºå±•ç°å‘¢ï¼Ÿ</p><blockquote><p>The correct answer: <code>script start</code>, <code>script end</code>, <code>promise1</code>, <code>promise2</code>, <code>setTimeout</code>, but itâ€™s pretty wild out there in terms of browser support.</p></blockquote><p>è¯‘ï¼šæ­£ç¡®çš„ç­”æ¡ˆä¸º<code>script start</code>ï¼Œ<code>script end</code>ï¼Œ<code>promise1</code>ï¼Œ<code>promise2</code>ï¼Œ<code>setTimeout</code> ï¼Œä½†æ˜¯åœ¨æµè§ˆå™¨æ”¯æŒçš„æ–¹é¢æ¥è¯´ï¼Œè¿™æ˜¯ç›¸å½“æ”¾è¡çš„ï¼ˆåº”è¯¥æ˜¯æŒ‡è¿™ä¸ªç»“æœä¸å—æ§åˆ¶ï¼Œåœ¨ä¸åŒæµè§ˆå™¨ä¸­æœ‰ä¸åŒçš„è¡¨ç°ï¼‰ã€‚</p><blockquote><p>Microsoft Edge, Firefox 40, iOS Safari and desktop Safari 8.0.8 log <code>setTimeout</code> before <code>promise1</code> and <code>promise2</code> - although it appears to be a race condition. This is really weird, as Firefox 39 and Safari 8.0.7 get it consistently right.</p></blockquote><p>è¯‘ï¼šåœ¨Edgeï¼Œç«ç‹40å’Œæ¡Œé¢çš„Safari8.0.8çš„ç‰ˆæœ¬ä¸‹ï¼Œ<code>setTimeout</code>ä¼šåœ¨<code>promise1</code>å’Œ<code>promise2</code> ä¹‹å‰æ‰“å°ï¼Œè™½ç„¶ä¼¼ä¹æ˜¯ä¸€ç§ç«Ÿæ€çŠ¶å†µã€‚è¿™æ˜¯ç›¸å½“å¥‡æ€ªçš„ï¼Œå› ä¸ºç«ç‹39å’ŒSafari8.0.7çš„ç‰ˆæœ¬ä¸‹ï¼Œå¯¹äºè¿™ç§è¡Œä¸ºå´æ˜¯ä¸€è‡´æ­£ç¡®çš„ã€‚</p><h2 id="why-this-happens-ï¼ˆä¸ºä»€ä¹ˆä¼šå‘ç”Ÿå‘¢ï¼‰" tabindex="-1">Why this happens ï¼ˆä¸ºä»€ä¹ˆä¼šå‘ç”Ÿå‘¢ï¼‰ <a class="header-anchor" href="#why-this-happens-ï¼ˆä¸ºä»€ä¹ˆä¼šå‘ç”Ÿå‘¢ï¼‰">ğŸ”—</a></h2><blockquote><p>To understand this you need to know how the event loop handles tasks and microtasks. This can be a lot to get your head around the first time you encounter it. Deep breathâ€¦</p></blockquote><p>è¯‘ï¼šä¸ºäº†ç†è§£è¿™ä¸ªä½ éœ€è¦çŸ¥é“eventloopï¼ˆäº‹ä»¶å¾ªç¯æœºåˆ¶ï¼‰å¦‚ä½•å¤„ç†tasksï¼ˆä»»åŠ¡ï¼‰å’Œmicroitasksï¼ˆå¾®ä»»åŠ¡ï¼‰ã€‚ç¬¬ä¸€æ¬¡å¬åˆ°è¿™ä¸ªæ¦‚å¿µå¯èƒ½ä¼šè®©ä½ å¤´çš®å‘éº»ï¼Œæ·±å‘¼å¸ï¼ˆ<del>æˆ‘å‘¼å¸å•¦ï¼Œè¿˜æ˜¯çœ‹ä¸æ‡‚ï¼Œæœ‰ä»€ä¹ˆå¥½è¯´å“’</del>ï¼‰ã€‚</p><blockquote><p>Each â€˜threadâ€™ gets its own event loop, so each web worker gets its own, so it can execute independently, whereas all windows on the same origin share an event loop as they can synchronously communicate. The event loop runs continually, executing any tasks queued. An event loop has multiple task sources which guarantees execution order within that source (specs <a href="https://w3c.github.io/IndexedDB/#database-access-task-source" target="_blank" rel="noopener">such as IndexedDB</a> define their own), but the browser gets to pick which source to take a task from on each turn of the loop. This allows the browser to give preference to performance sensitive tasks such as user-input. Ok ok, stay with meâ€¦</p></blockquote><p>è¯‘ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„äº‹ä»¶å¾ªç¯ç³»ç»Ÿï¼Œæ‰€ä»¥æ¯ä¸ªweb workerï¼ˆJavaScriptä¸‹å¤šçº¿ç¨‹çš„å­çº¿ç¨‹ï¼‰æœ‰è‡ªå·±çš„äº‹ä»¶å¾ªç¯ç³»ç»Ÿï¼Œä»–èƒ½ç‹¬ç«‹åœ°æ‰§è¡Œï¼Œé‰´äºæ‰€æœ‰çš„åŒæºçª—å£å…±äº«ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥åŒæ­¥åœ°é€šä¿¡ã€‚äº‹ä»¶å¾ªç¯ç³»ç»Ÿä¸æ–­åœ°è¿è¡Œï¼Œæ‰§è¡Œä»»ä½•æ’è¿›æ¥çš„ä»»åŠ¡ï¼Œä¸€ä¸ªäº‹ä»¶å¾ªç¯æœ‰å¤šä¸ªä»»åŠ¡æºï¼Œè¿™äº›ä»»åŠ¡æºä¿è¯äº†åœ¨è¯¥æºä¸­çš„æ‰§è¡Œé¡ºåºï¼ˆå°±åƒIndexDBå®šä¹‰ä»–ä»¬è‡ªå·±çš„ï¼ˆäº‹ä»¶å¾ªç¯ç³»ç»Ÿï¼‰è§„èŒƒï¼‰ï¼Œä½†æ˜¯æµè§ˆå™¨è¦å»åœ¨æ¯è½®å¾ªç¯ä¸­é€‰æ‹©å“ªä¸€ä¸ªæºæ¥è·å–ä»»åŠ¡ã€‚è¿™å…è®¸äº†æµè§ˆå™¨ä¼˜å…ˆè€ƒè™‘è¡¨ç°æ•æ„Ÿçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç”¨æˆ·çš„è¾“å…¥ã€‚</p><blockquote><p><strong>Tasks</strong> are scheduled so the browser can get from its internals into JavaScript/DOM land and ensures these actions happen sequentially. Between tasks, the browser may render updates. Getting from a mouse click to an event callback requires scheduling a task, as does parsing HTML, and in the above example, <code>setTimeout</code>.</p></blockquote><p>è¯‘ï¼šä»»åŠ¡è¢«å®‰æ’è¿›æ¥ï¼Œæµè§ˆå™¨ä¾¿å¯ä»¥ä»å®ƒçš„å†…éƒ¨è¿›å…¥JavaScript/DOM å¹¶ä¸”ç¡®ä¿è¿™äº›è¡Œä¸ºå¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œã€‚åœ¨ä»»åŠ¡ä¹‹é—´ï¼Œæµè§ˆå™¨å¯èƒ½è¿›è¡Œæ¸²æŸ“æ›´æ–°ã€‚ä»ä¸€ä¸ªé¼ æ ‡çš„ç‚¹å‡»åˆ°ä¸€ä¸ªäº‹ä»¶çš„å›è°ƒéœ€è¦å®‰æ’ä¸€ä¸ªä»»åŠ¡ï¼Œå°±åƒè§£æhtmlä¸€æ ·ï¼Œå¯¹äºä»¥ä¸Šçš„ä¾‹å­ï¼Œå¯¹åº”<code>setTimeout</code>ã€‚</p><blockquote><p><code>setTimeout</code> waits for a given delay then schedules a new task for its callback. This is why <code>setTimeout</code> is logged after <code>script end</code>, as logging <code>script end</code> is part of the first task, and <code>setTimeout</code> is logged in a separate task. Right, weâ€™re almost through this, but I need you to stay strong for this next bitâ€¦</p></blockquote><p>è¯‘ï¼š<code>setTimeout</code>å‡½æ•°ç­‰å¾…ä¸€ä¸ªæŒ‡å®šçš„å»¶è¿Ÿåå®‰æ’ä¸€ä¸ªå›è°ƒå‡½æ•°ä»»åŠ¡ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ<code>setTimeout</code>æ‰“å°åœ¨<code>script end</code>ä¹‹åï¼Œå› ä¸ºæ‰“å°<code>script end</code>æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ‰“å°<code>setTimeout</code> åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ä¸­ã€‚okï¼Œæˆ‘ä»¬åŸºæœ¬ç†è§£äº†è¿™ä¸ªTaskè¿™ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯æˆ‘å»ºè®®ä½ å¯¹æ¥ä¸‹æ¥çš„å†…å®¹ä¿æŒä¸“æ³¨ã€‚</p><blockquote><p><strong>Microtasks</strong> are usually scheduled for things that should happen straight after the currently executing script, such as reacting to a batch of actions, or to make something async without taking the penalty of a whole new task. The microtask queue is processed after callbacks as long as no other JavaScript is mid-execution, and at the end of each task. Any additional microtasks queued during microtasks are added to the end of the queue and also processed. Microtasks include mutation observer callbacks, and as in the above example, promise callbacks.</p></blockquote><p>è¯‘ï¼šå¾®ä»»åŠ¡é€šå¸¸ç”¨æ¥å®‰æ’é‚£äº›åº”è¯¥åœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬ä¹‹åç›´æ¥å‘ç”Ÿçš„äº‹æƒ…ï¼Œæ¯”å¦‚å¯¹ä¸€æ‰¹æ“ä½œä½œå‡ºååº”ï¼Œæˆ–è€…ä½¿å¾—æŸäº›æ“ä½œä¸ä»¥ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼ˆä¹Ÿå°±æ˜¯ä¸Šä¸€æ®µè¯´åˆ°çš„æƒ…å†µï¼‰ä¸ºä»£ä»·å¼‚æ­¥æ‰§è¡Œã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—åœ¨æ¯ä¸ªä»»åŠ¡çš„ç»“æŸé˜¶æ®µè§¦å‘å›è°ƒåè¢«å¤„ç†ï¼Œåªè¦æ²¡æœ‰å…¶ä»–çš„JavaScriptè„šæœ¬åœ¨æ‰§è¡Œä¸­ã€‚ä»»ä½•é¢å¤–çš„å¾®ä»»åŠ¡åœ¨è¢«æ·»åŠ è¿›é˜Ÿåˆ—å°¾ç«¯æ’é˜Ÿå¤„ç†ã€‚å¾®ä»»åŠ¡åŒ…æ‹¬å˜åŠ¨è§‚å¯Ÿè€…å›è°ƒï¼Œå¯¹äºä»¥ä¸Šçš„ä¾‹å­ï¼Œå¯¹åº”promiseçš„å›è°ƒã€‚</p><blockquote><p>Once a promise settles, or if it has already settled, it queues a microtask for its reactionary callbacks. This ensures promise callbacks are async even if the promise has already settled. So calling <code>.then(yey, nay)</code> against a settled promise immediately queues a microtask. This is why <code>promise1</code>and <code>promise2</code> are logged after script end, as the currently running script must finish before microtasks are handled. promise1 and promise2 are logged before setTimeout, as microtasks always happen before the next task.</p></blockquote><p>è¯‘ï¼šä¸€æ—¦ä¸€ä¸ªpromiseè§£å†³ï¼Œæˆ–è€…å¦‚æœå®ƒæ—©å·²è§£å†³ï¼Œå®ƒä¼šä»¥å®ƒçš„ååº”å‡½æ•°ä¸ºä¸€ä¸ªå¾®ä»»åŠ¡æ’è¿›é˜Ÿåˆ—ï¼Œè¿™ç¡®ä¿äº†promiseçš„å›è°ƒæ˜¯å¼‚æ­¥ï¼Œå³ä½¿å®ƒæ˜¯æ—©å·²è§£å†³çš„ã€‚æ‰€ä»¥å¯¹ä¸€ä¸ªå·²ç»è§£å†³çš„promiseè°ƒç”¨<code>.then(yey, nay)</code> ä¼šç«‹å³åœ°æ’ä¸€ä¸ªå¾®ä»»åŠ¡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>promise1</code>å’Œ<code>promise2</code>æ‰“å°åœ¨<code>script end</code>ä¹‹åï¼Œå› ä¸ºå½“å‰æ­£åœ¨æ‰§è¡Œåœ°è„šæœ¬å¿…é¡»åœ¨å¾®ä»»åŠ¡è¢«å¤„ç†ä¹‹å‰å®Œæˆã€‚<code>promise1</code>å’Œ<code>promise2</code>æ‰“å°åœ¨<code>setTimeout</code> ä¹‹åï¼Œå› ä¸ºå¾®ä»»åŠ¡å‘ç”Ÿåœ¨ä¸‹ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ã€‚</p><h3 id="what-are-some-browsers-doing-differently-ï¼ˆä¸ºä»€ä¹ˆæµè§ˆå™¨ä¼šæœ‰ä¸åŒçš„ååº”ï¼‰" tabindex="-1">What are some browsers doing differently?ï¼ˆä¸ºä»€ä¹ˆæµè§ˆå™¨ä¼šæœ‰ä¸åŒçš„ååº”ï¼‰ <a class="header-anchor" href="#what-are-some-browsers-doing-differently-ï¼ˆä¸ºä»€ä¹ˆæµè§ˆå™¨ä¼šæœ‰ä¸åŒçš„ååº”ï¼‰">ğŸ”—</a></h3><blockquote><p>Some browsers log <code>script start</code>, <code>script end</code>, <code>setTimeout</code>, <code>promise1</code>, <code>promise2</code>. Theyâ€™re running promise callbacks after <code>setTimeout</code>. Itâ€™s likely that theyâ€™re calling promise callbacks as part of a new task rather than as a microtask.</p></blockquote><p>è¯‘ï¼šä¸€äº›æµè§ˆå™¨æ‰“å°<code>script start</code>, <code>script end</code>, <code>setTimeout</code>, <code>promise1</code>, <code>promise2</code>ã€‚å®ƒä»¬åœ¨<code>setTimeout</code> ä¹‹åæ‰§è¡Œpromiseçš„å›è°ƒï¼Œè¿™æˆ–è®¸æ˜¯ä»¥ä¸€ä¸ªæ–°çš„ä»»åŠ¡è€Œä¸æ˜¯ä»¥ä¸€ä¸ªå¾®ä»»åŠ¡æ¥æ‰§è¡Œpromiseçš„å›è°ƒã€‚</p><blockquote><p>This is sort-of excusable, as promises come from ECMAScript rather than HTML. ECMAScript has the concept of â€œjobsâ€ which are similar to microtasks, but the relationship isnâ€™t explicit aside from <a href="https://esdiscuss.org/topic/the-initialization-steps-for-web-browsers#content-16" target="_blank" rel="noopener">vague mailing list discussions</a>. However, the general consensus is that promises should be part of the microtask queue, and for good reason.</p></blockquote><p>è¯‘ï¼šè¿™æ˜¯å¯ä»¥è§£é‡Šçš„ï¼Œå› ä¸ºpromiseæ¥è‡ªäºecmaè€Œä¸æ˜¯htmlã€‚ECMAä¸­â€jobâ€çš„æ¦‚å¿µç±»ä¼¼å¾®ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨vague mailing list discussionsçš„è®¨è®ºä¸­å®ƒä»¬çš„å…³ç³»æ˜¯ä¸æ˜¯æ˜ç¡®çš„åœ¨ä¸€è¾¹çš„ã€‚ç„¶è€Œï¼Œä¸€èˆ¬çš„å…±è¯†æ˜¯promiseæ˜¯å¾®ä»»åŠ¡é˜Ÿåˆ—çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”æœ‰å……åˆ†çš„ç†ç”±è¯´æ˜å®ƒã€‚</p><blockquote><p>Treating promises as tasks leads to performance problems, as callbacks may be unnecessarily delayed by task-related things such as rendering. It also causes non-determinism due to interaction with other task sources, and can break interactions with other APIs, but more on that later.</p></blockquote><p>è¯‘ï¼šå°†promiseè§†ä¸ºä»»åŠ¡ä¼šå¯¼è‡´è¡¨ç°çš„é—®é¢˜ï¼Œå› ä¸ºå›è°ƒä¼šè¢«å’Œä»»åŠ¡æœ‰å…³çš„äº‹æƒ…æ¯”å¦‚æ¸²æŸ“é€ æˆä¸å¿…è¦çš„å»¶è¿Ÿã€‚ç”±äºå’Œå…¶ä»–çš„ä»»åŠ¡æºæœ‰ç›¸äº’ä½œç”¨ï¼Œå¹¶ä¸”å¯ä»¥ä¸­æ–­å’Œå…¶ä»–apiçš„ç›¸äº’ä½œç”¨ï¼Œä¹Ÿé€ æˆäº†ä¸ç¡®å®šæ€§ã€‚ä¹‹åä¼šä»‹ç»æ›´å¤šã€‚</p><blockquote><p>Hereâ€™s <a href="https://connect.microsoft.com/IE/feedback/details/1658365" target="_blank" rel="noopener">an Edge ticket</a> for making promises use microtasks. WebKit nightly is doing the right thing, so I assume Safari will pick up the fix eventually, and it appears to be fixed in Firefox 43.</p></blockquote><p>è¯‘ï¼šè¿™æ˜¯ä¸€ä¸ªå…³äºedgeæµè§ˆå™¨çš„ticketï¼Œå…³äºè®©promiseä½¿ç”¨å¾®ä»»åŠ¡çš„å½¢å¼ï¼ŒWebKitä¸ä¹…ä¾¿ä¿®å¤äº†å®ƒï¼Œæ‰€ä»¥æˆ‘çŒœæƒ³Safariæœ€ç»ˆä¼šä¿®å¤ï¼ˆè¿™ä¸ªbugï¼‰ï¼Œå®ƒå°†åœ¨Firefox43è¢«ä¿®å¤ã€‚</p><blockquote><p>Really interesting that both Safari and Firefox suffered a regression here thatâ€™s since been fixed. I wonder if itâ€™s just a coincidence.</p></blockquote><p>è¯‘ï¼šæœ‰è¶£çš„æ˜¯ï¼ŒSafariå’ŒFirefoxéƒ½é­é‡è¿‡è¿™ä¸ªbugå¹¶ä¸”å·²ç»ä¿®å¤äº†ï¼Œæˆ‘æ€€ç–‘è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå·§åˆã€‚</p><h2 id="how-to-tell-if-something-uses-tasks-or-microtasksï¼ˆå¦‚ä½•çŸ¥é“æ˜¯ä½¿ç”¨äº†ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼‰" tabindex="-1">How to tell if something uses tasks or microtasksï¼ˆå¦‚ä½•çŸ¥é“æ˜¯ä½¿ç”¨äº†ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼‰ <a class="header-anchor" href="#how-to-tell-if-something-uses-tasks-or-microtasksï¼ˆå¦‚ä½•çŸ¥é“æ˜¯ä½¿ç”¨äº†ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼‰">ğŸ”—</a></h2><blockquote><p>Testing is one way. See when logs appear relative to promises &amp; <code>setTimeout</code>, although youâ€™re relying on the implementation to be correct.</p></blockquote><p>è¯‘ï¼šæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æµ‹è¯•ï¼Œè§‚å¯Ÿæ‰“å°çš„æ—¥å¿—å¯¹äºpromiseså’Œ<code>setTimeout</code>çš„ç›¸å¯¹ä½ç½®ï¼Œä¸è¿‡åº”è¯¥ä¾èµ–å®ç°æ¥åˆ¤æ–­æ‰æ˜¯æ­£ç¡®çš„ã€‚</p><blockquote><p>The certain way, is to look up the spec. For instance, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#timer-initialisation-steps" target="_blank" rel="noopener">step 14 of setTimeout</a> queues a task, whereas <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record" target="_blank" rel="noopener">step 5 of queuing a mutation record</a> queues a microtask.</p></blockquote><p>è¯‘ï¼šå¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å»æŸ¥é˜…æ–‡æ¡£ï¼Œæ¯”å¦‚ï¼ŒsetTimeoutåœ¨ç¬¬14æ­¥æ’é˜Ÿè¿›ä¸€ä¸ªä»»åŠ¡ã€‚è€Œæ’é˜Ÿä¸€ä¸ªå˜åŒ–çš„è®°å½•çš„ç¬¬5æ­¥ä¸ºæ’é˜Ÿè¿›ä¸€ä¸ªå¾®ä»»åŠ¡ã€‚</p><blockquote><p>As mentioned, in ECMAScript land, they call microtasks â€œjobsâ€. In <a href="https://www.ecma-international.org/ecma-262/6.0/#sec-performpromisethen" target="_blank" rel="noopener">step 8.a of <code>PerformPromiseThen</code></a>, <code>EnqueueJob</code> is called to queue a microtask.</p></blockquote><p>è¯‘ï¼šå°±è·ŸæåŠåˆ°çš„ä¸€æ ·ï¼Œåœ¨ecmaçš„ä¸–ç•Œä¸­ï¼Œå®ƒä»¬æŠŠå¾®ä»»åŠ¡ç§°ä¸ºâ€jobsâ€ã€‚åœ¨<code>PerformPromiseThen</code>çš„ç¬¬8.aæ­¥ï¼Œ<code>EnqueueJob</code>è¢«ç§°ä¸ºæ’é˜Ÿä¸€ä¸ªå¾®ä»»åŠ¡ã€‚</p><blockquote><p>Now, letâ€™s look at a more complicated example. Cut to a concerned apprentice â€œNo, theyâ€™re not ready!â€. Ignore him, youâ€™re ready. Letâ€™s do thisâ€¦</p></blockquote><p>è¯‘ï¼šç°åœ¨ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ã€‚ä½ å¯èƒ½ä¼šè¯´ï¼šâ€œæˆ‘å‰é¢çš„è¿˜æ²¡ç†è§£ï¼Œæˆ‘è¿˜æ²¡æœ‰å‡†å¤‡å¥½â€ï¼Œå¿˜å´ä»–ï¼Œä½ å·²ç»å‡†å¤‡å¥½äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹â€¦</p><h2 id="level-1-bossfightï¼ˆè¯‘ä¸å‡ºæ¥â€¦ï¼‰" tabindex="-1">Level 1 bossfightï¼ˆè¯‘ä¸å‡ºæ¥â€¦ï¼‰ <a class="header-anchor" href="#level-1-bossfightï¼ˆè¯‘ä¸å‡ºæ¥â€¦ï¼‰">ğŸ”—</a></h2><blockquote><p>Before writing this post Iâ€™d have gotten this wrong. Hereâ€™s a bit of html:</p></blockquote><p>è¯‘ï¼šåœ¨å†™è¿™ç¯‡æ–‡ç« ä¹‹å‰ï¼Œæˆ‘å¼„é”™äº†ä¸€ä»¶äº‹ã€‚è¿™æ˜¯ä¸€æ®µhtmlä»£ç ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-html"><span class="line"></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F;">div</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> class</span><span style="--s-dark:#666666;--s-light:#999999;">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&quot;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">outer</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&quot;</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">  &lt;</span><span style="--s-dark:#4D9375;--s-light:#1E754F;">div</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> class</span><span style="--s-dark:#666666;--s-light:#999999;">=</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&quot;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">inner</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&quot;</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F;">div</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">&lt;/</span><span style="--s-dark:#4D9375;--s-light:#1E754F;">div</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;</span></span></code></pre><blockquote><p>Given the following JS, what will be logged if I click <code>div.inner</code>?</p></blockquote><p>è¯‘ï¼šåœ¨ä¸‹é¢è¿™æ®µjsä»£ç çš„æ‰§è¡Œä¸‹ï¼Œå½“æˆ‘ç‚¹å‡»<code>div.inner</code>çš„æ—¶å€™ä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// Let&#39;s get hold of those elements</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// å…ˆè·å–è¿™äº›å…ƒç´ </span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">var</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> outer</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> document</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">querySelector</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">.outer</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">var</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> inner</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> document</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">querySelector</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">.inner</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// Let&#39;s listen for attribute changes on the</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// outer element</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// ç›‘å¬outer elementçš„å±æ€§å€¼å˜åŒ–ã€‚</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">new</span><span style="--s-dark:#80A665;--s-light:#59873A;"> MutationObserver</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">mutate</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">}).</span><span style="--s-dark:#80A665;--s-light:#59873A;">observe</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">outer</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418;">    attributes</span><span style="--s-dark:#666666;--s-light:#999999;">:</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> true</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// Here&#39;s a click listenerâ€¦</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// ç‚¹å‡»äº‹ä»¶</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> onClick</span><span style="--s-dark:#666666;--s-light:#999999;">()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">click</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A;">    setTimeout</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">        console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">timeout</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">    },</span><span style="--s-dark:#4C9A91;--s-light:#2F798A;"> 0</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418;">    Promise</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">resolve</span><span style="--s-dark:#666666;--s-light:#999999;">().</span><span style="--s-dark:#80A665;--s-light:#59873A;">then</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#666666;--s-light:#999999;"> ()</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">        console</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">log</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">promise</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    outer</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">setAttribute</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">data-random</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> Math</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">random</span><span style="--s-dark:#666666;--s-light:#999999;">());</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// â€¦which we&#39;ll attach to both elements</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// å°†ç‚¹å‡»äº‹ä»¶åº”ç”¨åˆ°è¿™ä¸¤ä¸ªå…ƒç´ ä¸Šã€‚</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">inner</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">click</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> onClick</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">outer</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">addEventListener</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">click</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">&#39;</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> onClick</span><span style="--s-dark:#666666;--s-light:#999999;">);</span></span></code></pre><p>PS: æˆ‘è‡ªå·±çŒœçš„é¡ºåºæ˜¯</p><p>click<br> mutate<br> promise<br> timeout<br> click<br> mutate<br> promise<br> timeout</p><p>åŸæ–‡è¿™é‡Œæœ‰ä¸ªå¯ä»¥åœ¨çº¿è¿è¡ŒæŸ¥çœ‹çš„æ¡†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å»æµ‹è¯•ã€‚</p><p>æˆ‘åœ¨chrome81ä¸‹æµ‹è¯•çš„ç»“æœæ˜¯</p><p>click<br> promise<br> mutate<br> click<br> promise<br> mutate<br> timeout<br> timeout</p><blockquote><p>Was your guess different? If so, you may still be right. Unfortunately the browsers donâ€™t really agree here:</p></blockquote><p>è¯‘ï¼šå’Œä½ æƒ³è±¡çš„ä¸åŒï¼Ÿå¦‚æœæ˜¯ï¼Œä½ å¯èƒ½æ˜¯å¯¹çš„ã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¼—å¤šçš„æµè§ˆå™¨å¯èƒ½ä¸åŒæ„è¿™ç§ç»“æœã€‚</p><table><thead><tr><th>Chrome</th><th>Firefox</th><th>Safari</th><th>EDGE</th></tr></thead><tbody><tr><td>click <br> promise <br> mutate <br> click <br> promise <br> mutate <br> timeout <br> timeout</td><td>click <br> mutate <br> click <br> mutate <br> timeout <br> promise <br> promise <br>timeout</td><td>click <br> mutate <br> click <br> mutate <br> promise <br> promise <br> timeout <br> timeout</td><td>click <br> click <br> mutate <br> timeout <br> promise <br> timeout <br> promise</td></tr></tbody></table><h2 id="whoâ€™s-right-ï¼ˆè°æ˜¯æ­£ç¡®çš„ï¼Ÿï¼‰" tabindex="-1"><a href="#Who%E2%80%99s-right-%EF%BC%88%E8%B0%81%E6%98%AF%E6%AD%A3%E7%A1%AE%E7%9A%84%EF%BC%9F%EF%BC%89" title="Whoâ€™s right?ï¼ˆè°æ˜¯æ­£ç¡®çš„ï¼Ÿï¼‰"></a>Whoâ€™s right?ï¼ˆè°æ˜¯æ­£ç¡®çš„ï¼Ÿï¼‰ <a class="header-anchor" href="#whoâ€™s-right-ï¼ˆè°æ˜¯æ­£ç¡®çš„ï¼Ÿï¼‰">ğŸ”—</a></h2><blockquote><p>Dispatching the â€˜clickâ€™ event is a task. Mutation observer and promise callbacks are queued as microtasks. The <code>setTimeout</code> callback is queued as a task. So hereâ€™s how it goes:</p></blockquote><p>è¯‘ï¼šåˆ†å‘ç‚¹å‡»äº‹ä»¶æ˜¯ä»»åŠ¡ã€‚Mutation observerå’Œpromiseå›è°ƒæ˜¯æ’è¿›å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚<code>setTimeout</code>å›è°ƒæ’è¿›ä»»åŠ¡é˜Ÿåˆ—ã€‚æ‰€ä»¥å®ƒçš„å·¥ä½œåº”è¯¥æ˜¯è¿™æ ·çš„ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªåŠ¨ç”»ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»è§‚çœ‹ã€‚ç»“æœä¸ºchromeçš„æ‰§è¡Œé¡ºåºã€‚</p><blockquote><p>So itâ€™s Chrome that gets it right. The bit that was â€˜news to meâ€™ is that microtasks are processed after callbacks (as long as no other JavaScript is mid-execution), I thought it was limited to end-of-task. This rule comes from the HTML spec for calling a callback:</p></blockquote><p>è¯‘ï¼šæ‰€ä»¥æ˜¯chromeçš„ç»“æœæ˜¯æ­£ç¡®çš„ã€‚è¿™ä¸€æ®µå¯¹äºæˆ‘æ¥è¯´æ–°çš„ä¸œè¥¿ä¸ºå¾®ä»»åŠ¡å¯ä»¥åœ¨å›è°ƒä¹‹åè¢«å¤„ç†ï¼ˆåªè¦æ²¡æœ‰å…¶ä»–çš„JavaScriptä»£ç åœ¨æ‰§è¡Œä¸­ï¼‰ï¼Œæˆ‘è®¤ä¸ºè¿™ç§æƒ…å†µä»…é™äºä»»åŠ¡é˜Ÿåˆ—çš„æœ«å°¾ã€‚è¿™ä¸ªè§„åˆ™æ¥è‡ªhtmlè§„èŒƒä¸­çš„è°ƒç”¨ä¸€ä¸ªå›è°ƒã€‚</p><blockquote><blockquote><p>If <a href="https://html.spec.whatwg.org/multipage/webappapis.html#stack-of-script-settings-objects" target="_blank" rel="noopener">the stack of script settings objects</a> is now empty, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint" target="_blank" rel="noopener">perform a microtask checkpoint</a> â€” <a href="https://html.spec.whatwg.org/multipage/webappapis.html#clean-up-after-running-a-callback" target="_blank" rel="noopener">HTML: Cleaning up after a callback</a> step 3</p></blockquote></blockquote><p>è¯‘ï¼šå¦‚æœè„šæœ¬è®¾ç½®å¯¹è±¡çš„å †æ ˆå·²ç»ä¸ºç©ºæ—¶ï¼Œæ‰§è¡Œå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹ - HTMLï¼šåœ¨ä¼šè°ƒç”¨å›è°ƒåè¿›è¡Œæ¸…ç†çš„æ­¥éª¤3.</p><blockquote><p>â€¦and a microtask checkpoint involves going through the microtask queue, unless weâ€™re already processing the microtask queue. Similarly, ECMAScript says this of jobs:</p></blockquote><p>è¯‘ï¼šä¸€ä¸ªå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹éœ€è¦é€šè¿‡å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œé™¤éæˆ‘ä»¬æ—©å·²å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚ä¸ä¹‹ç±»ä¼¼åœ°ï¼ŒECMAScriptä¸­æŠŠè¿™ä¸ªè¯´æˆjobsï¼š</p><blockquote><p>Execution of a Job can be initiated only when there is no running execution context and the execution context stack is emptyâ€¦ â€” <a href="https://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues" target="_blank" rel="noopener">ECMAScript: Jobs and Job Queues</a></p></blockquote><p>è¯‘ï¼šä¸€ä¸ªjobçš„æ‰§è¡Œå¯ä»¥è¢«å‘èµ·ï¼Œåªæœ‰å½“æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä¸Šä¸‹æ–‡å¹¶ä¸”æ‰§è¡Œä¸Šä¸‹æ–‡çš„å †æ ˆä¸ºç©ºâ€¦ - ECMAScriptï¼šJobs and Job Queues</p><blockquote><p>â€¦although the â€œcan beâ€ becomes â€œmust beâ€ when in an HTML context.</p></blockquote><p>è¯‘ï¼šâ€¦å°½ç®¡åœ¨HTMLçš„ä¸Šä¸‹æ–‡ä¸­â€œcan beâ€å˜æˆäº†â€œmust beâ€ã€‚</p><h2 id="what-did-browsers-get-wrong-ï¼ˆæµè§ˆå™¨å‡ºäº†ä»€ä¹ˆé”™è¯¯ï¼Ÿï¼‰" tabindex="-1">What did browsers get wrong?ï¼ˆæµè§ˆå™¨å‡ºäº†ä»€ä¹ˆé”™è¯¯ï¼Ÿï¼‰ <a class="header-anchor" href="#what-did-browsers-get-wrong-ï¼ˆæµè§ˆå™¨å‡ºäº†ä»€ä¹ˆé”™è¯¯ï¼Ÿï¼‰">ğŸ”—</a></h2><blockquote><p>Firefox and Safari are correctly exhausting the microtask queue between click listeners, as shown by the mutation callbacks, but promises appear to be queued differently. This is sort-of excusable given that the link between jobs &amp; microtasks is vague, but Iâ€™d still expect them to execute between listener callbacks. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1193394" target="_blank" rel="noopener">Firefox ticket</a>. <a href="https://bugs.webkit.org/show_bug.cgi?id=147933" target="_blank" rel="noopener">Safari ticket</a>.</p></blockquote><p>è¯‘ï¼šFirefoxå’ŒSafariæ­£ç¡®åœ°åœ¨ç‚¹å‡»äº‹ä»¶ç”¨å°½äº†å¾®ä»»åŠ¡çš„é˜Ÿåˆ—ï¼Œå°±è·Ÿmutationçš„å›è°ƒä¸€æ ·ï¼Œä½†æ˜¯promiseä¼¼ä¹æœ‰ä¸åŒçš„æ’é˜Ÿé¡ºåºã€‚è¿™æ˜¯ç¨å¾®æƒ…æœ‰å¯åŸçš„ï¼Œå› ä¸ºåœ¨jobsçš„å®šä¹‰å’Œmircrotasksçš„å®šä¹‰ä¹‹é—´çš„è”ç³»æ˜¯æ¨¡ç³Šçš„ï¼Œä½†æˆ‘ä»ç„¶æœŸæœ›åœ¨ç›‘å¬çš„å›è°ƒä¹‹é—´æ‰§è¡Œã€‚</p><blockquote><p>With Edge weâ€™ve already seen it queue promises incorrectly, but it also fails to exhaust the microtask queue between click listeners, instead it does so after calling all listeners, which accounts for the single mutate log after both click logs. Bug ticket.</p></blockquote><p>è¯‘ï¼šå¯¹äºEdgeæˆ‘ä»¬æ—©å·²å‘ç°å®ƒå¯¹promiseçš„æ’é˜Ÿä¸æ­£ç¡®ï¼Œä½†å®ƒæ˜¯æœªèƒ½åœ¨ç‚¹å‡»äº‹ä»¶ä¹‹é—´å¤„ç†å®Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨å®Œæ‰€æœ‰çš„ç›‘å¬ä¹‹ååœ¨å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå³åœ¨æ‰“å°å®Œä¸¤ä¸ªç‚¹å‡»çš„logä¹‹åæ¥ç€ä¸€ä¸ªmutateçš„logã€‚</p><h2 id="level-1-bossâ€™s-angry-older-brotherï¼ˆä¸çŸ¥é“ä»€ä¹ˆæ„æ€â€¦ï¼‰" tabindex="-1">Level 1 bossâ€™s angry older brotherï¼ˆä¸çŸ¥é“ä»€ä¹ˆæ„æ€â€¦ï¼‰ <a class="header-anchor" href="#level-1-bossâ€™s-angry-older-brotherï¼ˆä¸çŸ¥é“ä»€ä¹ˆæ„æ€â€¦ï¼‰">ğŸ”—</a></h2><blockquote><p>Ohh boy. Using the same example from above, what happens if we execute:</p></blockquote><p>è¯‘ï¼šä½¿ç”¨ä¸Šé¢åŒæ ·çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">inner</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">click</span><span style="--s-dark:#666666;--s-light:#999999;">();</span></span></code></pre><blockquote><p>This will start the event dispatching as before, but using script rather than a real interaction.</p></blockquote><p>è¯‘ï¼šè¿™ä¼šå’Œä¹‹å‰ä¸€æ ·å¼€å§‹äº‹ä»¶çš„åˆ†å‘ï¼Œä½†æ˜¯ä½¿ç”¨è„šæœ¬æ¥æ‰§è¡Œè€Œä¸æ˜¯ä¸€ä¸ªçœŸå®çš„äº’åŠ¨ã€‚</p><table><thead><tr><th>Chrome</th><th>Firefox</th><th>Safari</th><th>EDGE</th></tr></thead><tbody><tr><td>click <br> click <br> promise <br> mutate <br> promise <br> timeout <br> timeout</td><td>click <br> click <br> mutate <br> timeout <br> promise <br> promise <br>timeout</td><td>click <br> click <br> mutate <br> promise <br> promise <br> timeout <br> timeout</td><td>click <br> click <br> mutate <br> timeout <br> promise <br> timeout <br> promise</td></tr></tbody></table><blockquote><p>And I swear I keep getting different results from Chrome, Iâ€™ve updated this chart a ton of times thinking I was testing Canary by mistake. If you get different results in Chrome, tell me which version in the comments.</p></blockquote><p>è¯‘ï¼šæˆ‘å‘èª“æˆ‘ä»chromeå¾—åˆ°äº†ä¸åŒçš„ç»“æœã€‚æˆ‘å·²ç»æ›´æ–°äº†å¾ˆå¤šæ¬¡è¿™ä¸ªè¡¨æ ¼ï¼Œä»¥ä¸ºä¸€ç›´æµ‹è¯•å‡ºé”™ã€‚å¦‚æœä½ åœ¨chromeä¸­å¾—åˆ°äº†ä¸åŒçš„ç»“æœï¼Œå¯ä»¥åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘å¹¶é™„ä¸Šchromeçš„ç‰ˆæœ¬å·ã€‚</p><h2 id="why-is-it-different-ï¼ˆä¸ºä»€ä¹ˆä¼šä¸åŒï¼‰" tabindex="-1">Why is it different?ï¼ˆä¸ºä»€ä¹ˆä¼šä¸åŒï¼‰ <a class="header-anchor" href="#why-is-it-different-ï¼ˆä¸ºä»€ä¹ˆä¼šä¸åŒï¼‰">ğŸ”—</a></h2><p>PSï¼šè¿™é‡ŒåŸæ–‡æœ‰ä¸ªå¯æ“ä½œåŠ¨ç”»ã€‚</p><blockquote><p>So the correct order is: <code>click</code>, <code>click</code>, <code>promise</code>, <code>mutate</code>, <code>promise</code>, <code>timeout</code>, <code>timeout</code>, which Chrome seems to get right.</p></blockquote><p>è¯‘ï¼šæ‰€ä»¥æ­£ç¡®çš„é¡ºåºæ˜¯<code>click</code>, <code>click</code>, <code>promise</code>, <code>mutate</code>, <code>promise</code>, <code>timeout</code>, <code>timeout</code>ï¼Œchromeä¼¼ä¹æ˜¯æ­£ç¡®çš„ã€‚</p><blockquote><p>After each listener callback is calledâ€¦</p></blockquote><p>è¯‘ï¼šåœ¨æ¯ä¸€ä¸ªç›‘å¬å›è°ƒéƒ½è¢«è°ƒç”¨ä¹‹åâ€¦</p><blockquote><blockquote><p>If the stack of script settings objects is now empty, perform a microtask checkpoint â€” HTML: Cleaning up after a callback step 3</p></blockquote></blockquote><p>è¯‘ï¼šå¦‚æœè„šæœ¬è®¾ç½®å¯¹è±¡çš„å †æ ˆå·²ç»ä¸ºç©ºæ—¶ï¼Œæ‰§è¡Œå¾®ä»»åŠ¡æ£€æŸ¥ç‚¹ - HTMLï¼šåœ¨ä¼šè°ƒç”¨å›è°ƒåè¿›è¡Œæ¸…ç†çš„æ­¥éª¤3.</p><blockquote><p>Previously, this meant that microtasks ran between listener callbacks, but <code>.click()</code> causes the event to dispatch synchronously, so the script that calls <code>.click()</code> is still in the stack between callbacks. The above rule ensures microtasks donâ€™t interrupt JavaScript thatâ€™s mid-execution. This means we donâ€™t process the microtask queue between listener callbacks, theyâ€™re processed after both listeners.</p></blockquote><p>è¯‘ï¼šä¹‹å‰ï¼Œè¿™æ„å‘³ç€å¾®ä»»åŠ¡åœ¨ç›‘å¬åœ°å›è°ƒä¹‹å‰è¿è¡Œï¼Œä½†æ˜¯<code>.click()</code>è¿™ä¸ªæ“ä½œé€ æˆäº†äº‹ä»¶çš„åŒæ­¥åˆ†å‘ï¼Œæ‰€ä»¥è°ƒç”¨<code>.click()</code> åœ¨å›è°ƒä¹‹å‰ä»ç„¶å­˜åœ¨å †æ ˆä¸­ã€‚ä¸Šé¢çš„è§„åˆ™ç¡®ä¿äº†å¾®ä»»åŠ¡ä¸ä¼šæ‰“æ–­æ‰§è¡Œä¸­çš„JavaScriptã€‚è¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½å¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—åœ¨ç›‘å¬å›è°ƒä¹‹é—´ï¼Œå®ƒä»¬å¾—åœ¨ä¸¤ä¸ªç›‘å¬å›è°ƒä¹‹åæ‰èƒ½è¢«å¤„ç†ã€‚</p><h2 id="does-any-of-this-matter-ï¼ˆè¿™äº›æƒ…å†µæœ‰é—®é¢˜å—ï¼‰" tabindex="-1">Does any of this matter?ï¼ˆè¿™äº›æƒ…å†µæœ‰é—®é¢˜å—ï¼‰ <a class="header-anchor" href="#does-any-of-this-matter-ï¼ˆè¿™äº›æƒ…å†µæœ‰é—®é¢˜å—ï¼‰">ğŸ”—</a></h2><blockquote><p>Yeah, itâ€™ll bite you in obscure places (ouch). I encountered this while trying to create a simple wrapper library for IndexedDB that uses promises rather than weird <code>IDBRequest</code> objects. It almost makes IDB fun to use.</p></blockquote><p>è¯‘ï¼šemmmï¼Œå¯èƒ½ä¼šåœ¨æ™¦æ¶©çš„åœ°æ–¹è®©ä½ æ ½è·Ÿå¤´ã€‚æˆ‘é‡åˆ°è¿™ç§æƒ…å†µï¼Œå½“æˆ‘å°è¯•å»åˆ›å»ºä¸€ä¸ªç®€å•åŒ…è£…çš„IndexedDBçš„jsåº“ï¼Œä½¿ç”¨äº†promiseè€Œä¸æ˜¯å¥‡æ€ªçš„IDBRequestå¯¹è±¡ã€‚è¿™å‡ ä¹ä½¿å¾—IDBä½¿ç”¨èµ·æ¥å¾ˆé¡ºæ‰‹ã€‚</p><blockquote><p>When IDB fires a success event, the related <a href="https://w3c.github.io/IndexedDB/#fire-a-success-event" target="_blank" rel="noopener">transaction object becomes inactive after dispatching</a> (step 4). If I create a promise that resolves when this event fires, the callbacks should run before step 4 while the transaction is still active, but that doesnâ€™t happen in browsers other than Chrome, rendering the library kinda useless.</p></blockquote><p>è¯‘ï¼šå½“IDBå‘å°„ä¸€ä¸ªæˆåŠŸçš„äº‹ä»¶æ—¶ï¼Œç›¸å…³çš„äº‹ç‰©å¯¹è±¡åœ¨åˆ†å‘åä¼šå˜å¾—ä¸æ´»è·ƒï¼ˆåœ¨æ­¥éª¤4ï¼‰ã€‚å¦‚æœæˆ‘åˆ›å»ºä¸€ä¸ªpromiseï¼Œå½“è¿™ä¸ªäº‹ä»¶å‘å°„çš„æ—¶å€™resolveå®ƒï¼Œå›è°ƒå¯ä»¥åœ¨ç¬¬4æ­¥ä¹‹å‰æ‰§è¡Œï¼Œè¿™æ—¶çš„äº‹åŠ¡å¯¹è±¡ä»ç„¶æ´»è·ƒã€‚ä½†æ˜¯é‚£ä¸èƒ½åœ¨chromeä»¥å¤–çš„æµè§ˆå™¨ä¸­å‘ç”Ÿï¼Œä½¿å¾—è¿™ä¸ªjsåº“æœ‰ç‚¹æ²¡ç”¨ã€‚</p><blockquote><p>You can actually work around this problem in Firefox, because promise polyfills such as <a href="https://github.com/jakearchibald/es6-promise" target="_blank" rel="noopener">es6-promise</a> use mutation observers for callbacks, which correctly use microtasks. Safari seems to suffer from race conditions with that fix, but that could just be their <a href="http://www.raymondcamden.com/2014/09/25/IndexedDB-on-iOS-8-Broken-Bad" target="_blank" rel="noopener">broken implementation of IDB</a>. Unfortunately, things consistently fail in IE/Edge, as mutation events arenâ€™t handled after callbacks.</p></blockquote><p>è¯‘ï¼šäº‹å®ä¸Šä½ å¯ä»¥åœ¨Firefoxä¸­è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºpromiseçš„polyfillsï¼ˆä½ç‰ˆæœ¬æµè§ˆå™¨å®ç°ï¼‰ä½¿ç”¨äº†å¯å˜è§‚å¯Ÿè€…ä½œä¸ºå›è°ƒï¼Œè¿™ä¸ªå®ç°æ­£ç¡®ä½¿ç”¨äº†å¾®ä»»åŠ¡ã€‚å¯¹äºè¿™ä¸ªä¿®å¤ï¼ŒSafariå¥½åƒä¼šæœ‰ç«äº‰é—®é¢˜ï¼Œä½†æ˜¯é‚£å­˜åœ¨äºå®ƒä»¬çš„åçš„IDBçš„å®ç°ä¸­ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªä¿®å¤åœ¨IE/Edgeä¸­ä¸€è‡´å¤±è´¥ï¼Œå› ä¸ºå¯å˜çš„äº‹ä»¶åœ¨å›è°ƒä¹‹åä¸è¢«å¤„ç†ã€‚</p><blockquote><p>Hopefully weâ€™ll start to see some interoperability here soon.</p></blockquote><p>è¯‘ï¼šå¸Œæœ›æˆ‘ä»¬å¯ä»¥å¾ˆå¿«æ‰¾åˆ°è¿™é‡Œé¢çš„ä¸€äº›äº’é€šæ€§ã€‚</p><h2 id="you-made-it-ï¼ˆä½ åšåˆ°äº†ï¼ï¼‰" tabindex="-1">You made it!ï¼ˆä½ åšåˆ°äº†ï¼ï¼‰ <a class="header-anchor" href="#you-made-it-ï¼ˆä½ åšåˆ°äº†ï¼ï¼‰">ğŸ”—</a></h2><blockquote><p>In summary:</p><ul><li>Tasks execute in order, and the browser may render between them</li><li>Microtasks execute in order, and are executed:</li></ul></blockquote><ul><li>after every callback, as long as no other JavaScript is mid-execution</li></ul><blockquote><ul><li>at the end of each task</li></ul></blockquote><p>è¯‘ï¼š</p><p>ç»¼ä¸Šæ‰€å±ï¼š</p><ul><li>ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œæµè§ˆå™¨å¯èƒ½åœ¨å®ƒä»¬ä¹‹é—´æ¸²æŸ“</li><li>å¾®ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ <ul><li>åœ¨æ¯ä¸€ä¸ªå›è°ƒä¹‹åæ‰§è¡Œï¼Œåªæœ‰æ²¡æœ‰å…¶ä»–çš„JavaScriptåœ¨æ‰§è¡Œä¸­æ—¶ã€‚</li><li>åœ¨æ¯ä¸€ä¸ªä»»åŠ¡çš„æœ€åã€‚</li></ul></li></ul><blockquote><p>Hopefully you now know your way around the event loop, or at least have an excuse to go and have a lie down.</p></blockquote><p>è¯‘ï¼šå¸Œæœ›ä½ ç°åœ¨å¯ä»¥ä»¥ä½ çš„æ–¹å¼ç†è§£äº‹ä»¶å¾ªç¯ï¼Œæˆ–è€…è‡³å°‘æœ‰ä¸€ä¸ªå€Ÿå£å»èººä¸‹ï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰ã€‚</p><blockquote><p>Actually, is anyone still reading? Hello? Hello?</p></blockquote><p>è¯‘ï¼šå®é™…ä¸Šï¼Œæœ‰äººè¯»åˆ°è¿™é‡Œäº†å—ï¼Œhelloï¼Ÿhelloï¼Ÿ</p><h1 id="åè®°" tabindex="-1">åè®° <a class="header-anchor" href="#åè®°">ğŸ”—</a></h1><p>è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œè™½ç„¶æœ‰äº›åœ°æ–¹ç¿»è¯‘èµ·æ¥æ€ªæ€ªçš„ï¼Œå¹¶ä¸”æœ‰äº›æŒ‡å‘é“¾æ¥å·²ç»å¤±æ•ˆäº†ï¼Œä½†æ˜¯å•çº¯çš„åœ¨è¿™ç¯‡æ–‡ç« è¿˜æ˜¯èƒ½å­¦åˆ°å¾ˆå¤šæœ‰è¶£çš„çŸ¥è¯†çš„ã€‚</p>`,126)])))}};export{g as categories,d as date,m as default,h as key,u as tags,c as title,k as updated,b as wordCount};
