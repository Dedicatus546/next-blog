<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>什么是base64编码</title>
    <script type="module" crossorigin="" src="/assets/app-I7hi7fN_.js"></script>
    <link rel="stylesheet" crossorigin="" href="/assets/app-wnGglYIs.css">
  <link rel="modulepreload" crossorigin="" href="/assets/什么是base64编码-CwxopaRg.js"><meta property="og:title" content="什么是base64编码"><meta name="twitter:title" content="什么是base64编码"></head>
  <body>
    <div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="恋の歌的logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="自动" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="日间" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="夜间" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">什么是base64编码</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">发表于</span><span pl-1="">2022-02-21 16:35</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">更新于</span><span pl-1="">2023-02-13 18:28</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">分类于</span><!--[--><a pl-1="" href="/category/编程">编程</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">总字数</span><span pl-1="">1.4K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">阅读时长 ≈</span><span pl-1="">5 分钟</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言">🔗</a></h1><p>在看 <code>vueuse/core</code> 的源码时，看到 <code>useBase64</code> 函数时，有感而发</p><p>虽然平时都会很经常地看见 <code>base64</code> 编码，比如打包的时候如果图片大小很小的话，会直接内联成 <code>base64</code> 来减少网络请求</p><p>那么 <code>base64</code> 究竟是如何来编码的呢？</p><h1 id="正文" tabindex="-1">正文 <a class="header-anchor" href="#正文">🔗</a></h1><h2 id="base64-原理" tabindex="-1">base64 原理 <a class="header-anchor" href="#base64-原理">🔗</a></h2><p>这里放上维基百科对于 <code>base64</code> 的定义</p><blockquote><p>Base64（基底64）是一种基于64个可打印字符来表示二进制数据的表示方法。每6个比特为一个单元，对应某个可打印字符。3个字节相当于24个比特，对应于4个Base64单元，即3个字节可由4个可打印字符来表示。在Base64中的可打印字符包括字母A-Z、a-z、数字0-9，这样共有62个字符，此外两个可打印符号在不同的系统中而不同。</p></blockquote><p>从这个定义中我们就可以明白几个点</p><ul><li>编码后的结果为 <code>64</code> 个可打印字符的组合</li><li>使用 <code>6</code> 比特来表示一个可打印字符</li><li>由于单元长度为 <code>6</code>，所以需要使用 <code>4</code> 个可打印字符来表示 <code>3</code> 个字节（ <code>1</code> 个字节为 <code>8</code> 比特）</li></ul><p>根据第一点，可以知道应该存在一个对应表，每个字符对应一个长度为 <code>6</code> 的比特序列</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/22/202202221829722.avif" alt="来自维基百科"></p><p>可以看到经过 <code>base64</code> 编码之后，只会存在 <code>A-Z</code> ， <code>a-z</code> ， <code>0-9</code> ， <code>+/=</code> 这 <code>64</code> 个字符</p><p>使用 <code>hello</code> 来作为例子来解释 <code>base64</code> 是如何编码的</p><p>对于 <code>hello</code> 这个字符，其中</p><ul><li><code>h</code> 的 <code>10</code> 进制为 <code>104</code> ， <code>2</code> 进制为 <code>01101000</code></li><li><code>e</code> 的 <code>10</code> 进制为 <code>101</code> ， <code>2</code> 进制为 <code>01100101</code></li><li><code>l</code> 的 <code>10</code> 进制为 <code>108</code> ， <code>2</code> 进制为 <code>01101100</code></li><li><code>o</code> 的 <code>10</code> 进制为 <code>111</code> ， <code>2</code> 进制为 <code>01101111</code></li></ul><p>这时候我们就得到了 <code>hello</code> 的 <code>2</code> 进制数据 <code>01101000 01100101 01101100 01101100 01101111</code></p><p>然后我们按照 <code>6</code> 位一组进行划分，得到 <code>011010 000110 010101 101100 011011 000110 1111</code></p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202261719280.avif" alt=""></p><p>根据对照表，前面的四位 <code>011010 000110 010101 101100 011011 000110</code> 经过编码为 <code>aGVsbG</code></p><p>这时发现后面的 <code>1111</code> 并不能够被编码</p><p>除非变成 <code>1111xx</code></p><p>这时候我们要在原数据最后添加 <code>NUL</code> 来补充位数</p><p>这里的 <code>NUL</code> 为空字符的意思，它的 <code>2</code> 进制编码为 <code>00000000</code></p><p>在添加一个 <code>NUL</code> 之后，原数据变为 <code>01101000 01100101 01101100 01101100 01101111 00000000</code></p><p>这时分组之后为 <code>011010 000110 010101 101100 011011 000110 111100 000000</code></p><p>现在不存在不足 <code>6</code> 位的情况</p><p>根据对照表，可以得出编码后的字符 <code>aGVsbG8A</code></p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202261724091.avif" alt=""></p><p>但是由于我们添加了 <code>1</code> 个 <code>NUL</code> 在原数据的末尾</p><p>所以编码后的数据中最后一个 <code>A</code> 是不存在，这个 <code>A</code> 用 <code>=</code> 来代替</p><p>即编码后的字符串为 <code>aGVsbG8=</code></p><p>如果添加了两个 <code>NUL</code> ，那么就要把末尾的两个 <code>A</code> 改为 <code>=</code></p><p><code>=</code> 的数量取决于我们添加了多少个 <code>NUL</code> ，它的个数的值为 <code>0</code> ， <code>1</code> ，<code>2</code></p><p>为什么不会为 <code>3</code> 个呢，这是因为 <code>base64</code> 为 <code>4</code> 个 <code>6</code> 比特数据来表示 <code>3</code> 个 <code>8</code> 比特数据</p><p>如果添加了 <code>3</code> 个 <code>NUL</code>，那么在末尾就变为 <code>4</code> 个 <code>000000</code> 表示 <code>3</code> 个 <code>00000000</code> ，很明显这是没有意义的</p><p>换句话说，原数据的字节个数必须为 <code>3</code> 的倍数，对 <code>3</code> 取余可得到的值为 <code>1</code> ， <code>2</code> ，即分别对应了添加 <code>2</code> 个 <code>NUL</code>，添加 <code>1</code> 个 <code>NUL</code></p><h2 id="js-中的-base64" tabindex="-1">JS 中的 base64 <a class="header-anchor" href="#js-中的-base64">🔗</a></h2><p>在 <code>js</code> 中，也有两个 <code>api</code> 对应 <code>base64</code> 的编码和解码，分别是 <code>btoa</code>，<code>atob</code></p><p>使用 <code>btoa</code> 对 <code>hello</code> 进行编码</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202261754811.avif" alt=""></p><p>使用 <code>atob</code> 对 <code>aGVsbG8=</code> 进行解码</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202261755734.avif" alt=""></p><h2 id="usebase64-函数" tabindex="-1">useBase64 函数 <a class="header-anchor" href="#usebase64-函数">🔗</a></h2><p><code>vueuse/core</code> 里面提供了 <code>useBase64</code> 的函数</p><blockquote><p><a href="https://github.com/vueuse/vueuse/blob/main/packages/core/useBase64/index.ts" target="_blank" rel="noopener">vueuse/packages/core/useBase64/index.ts</a></p></blockquote><p>在源码中，我们可以看到 useBase64 的函数有许多个重载</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">MaybeRef</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">string</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> UseBase64Return</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">MaybeRef</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">Blob</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> UseBase64Return</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">MaybeRef</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">ArrayBuffer</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> UseBase64Return</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">MaybeRef</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">HTMLCanvasElement</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> options</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">?</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">ToDataURLOptions</span><span style="--s-dark:#666666;--s-light:#999999;">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> UseBase64Return</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">MaybeRef</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">HTMLImageElement</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> options</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">?</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">ToDataURLOptions</span><span style="--s-dark:#666666;--s-light:#999999;">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> UseBase64Return</span></span></code></pre><p>主要的区别是支持不同的源数据类型，除了字符串，还支持 <code>Blob</code> 数据， <code>ArrayBuffer</code> 数据， <code>canvas</code> 元素以及 <code>image</code> 元素</p><p>在源码中，使用了 <code>FileReader</code> 这个类来传入 <code>Blob</code> 类型的数据，然后通过 <code>readAsDataURL</code> 来获取编码后的 <code>base64</code> 数据</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202262103288.avif" alt=""></p><p>核心的转换函数为 <code>blobToBase64</code> ，源码如下</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> blobToBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">blob</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">Blob</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">  return</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> new</span><span style="--s-dark:#B8A965;--s-light:#998418;"> Promise</span><span style="--s-dark:#666666;--s-light:#999999;">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">string</span><span style="--s-dark:#666666;--s-light:#999999;">&gt;((</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">resolve</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> reject</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48;">fr</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> new </span><span style="--s-dark:#80A665;--s-light:#59873A;">FileReader</span><span style="--s-dark:#666666;--s-light:#999999;">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    fr</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">onload</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">e</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A;">      resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">e</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">!</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">result</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> string</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">    }</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    fr</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">onerror</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> reject</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">    fr</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">readAsDataURL</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">blob</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">  })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">}</span></span></code></pre><p>核心非常简单，就是读 <code>blob</code> 数据拿到 <code>base64</code> 而已，把结果包装成一个 <code>Promise</code></p><p>对于不同的类型，可以在 <code>useBase64</code> 的实现中看到它的转换方法</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> function</span><span style="--s-dark:#80A665;--s-light:#59873A;"> useBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">  target</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">any</span><span style="--s-dark:#666666;--s-light:#999999;">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">  options</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">?</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82;">any</span><span style="--s-dark:#666666;--s-light:#999999;">,</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">  // ...</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">        const </span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#80A665;--s-light:#59873A;"> unref</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">target</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">        // undefined or null</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> undefined</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> _target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> null</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">''</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        else</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">typeof</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> _target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">string</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#80A665;--s-light:#59873A;">blobToBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">new</span><span style="--s-dark:#80A665;--s-light:#59873A;"> Blob</span><span style="--s-dark:#666666;--s-light:#999999;">([</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;">],</span><span style="--s-dark:#666666;--s-light:#999999;"> { </span><span style="--s-dark:#B8A965;--s-light:#998418;">type</span><span style="--s-dark:#666666;--s-light:#999999;">: </span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">text/plain</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#666666;--s-light:#999999;"> })))</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        else</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> Blob</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#80A665;--s-light:#59873A;">blobToBase64</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;">))</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        else</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> ArrayBuffer</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">window</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">btoa</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">String</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">fromCharCode</span><span style="--s-dark:#666666;--s-light:#999999;">(...</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">new</span><span style="--s-dark:#80A665;--s-light:#59873A;"> Uint8Array</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;">))))</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        else</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> HTMLCanvasElement</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">toDataURL</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">options</span><span style="--s-dark:#666666;--s-light:#999999;">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">type</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> options</span><span style="--s-dark:#666666;--s-light:#999999;">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">quality</span><span style="--s-dark:#666666;--s-light:#999999;">))</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">        else</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> HTMLImageElement</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">          const </span><span style="--s-dark:#BD976A;--s-light:#B07D48;">img</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> _target</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">cloneNode</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#4D9375;--s-light:#1E754F;">false</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#4D9375;--s-light:#1E754F;"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> HTMLImageElement</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">          img</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">crossOrigin</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">Anonymous</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A;">          imgLoaded</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">img</span><span style="--s-dark:#666666;--s-light:#999999;">).</span><span style="--s-dark:#80A665;--s-light:#59873A;">then</span><span style="--s-dark:#666666;--s-light:#999999;">(()</span><span style="--s-dark:#666666;--s-light:#999999;"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">            const </span><span style="--s-dark:#BD976A;--s-light:#B07D48;">canvas</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> document</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">createElement</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">canvas</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959;">            const </span><span style="--s-dark:#BD976A;--s-light:#B07D48;">ctx</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">getContext</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#C98A7D;--s-light:#B56959;">2d</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977;">'</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">!</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">            canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">width</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> img</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">width</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">            canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">height</span><span style="--s-dark:#666666;--s-light:#999999;"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> img</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">height</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48;">            ctx</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">drawImage</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">img</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A;"> 0</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#4C9A91;--s-light:#2F798A;"> 0</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">width</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">height</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A;">            resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">canvas</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">toDataURL</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">options</span><span style="--s-dark:#666666;--s-light:#999999;">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">type</span><span style="--s-dark:#666666;--s-light:#999999;">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48;"> options</span><span style="--s-dark:#666666;--s-light:#999999;">?.</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">quality</span><span style="--s-dark:#666666;--s-light:#999999;">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">          }).</span><span style="--s-dark:#80A665;--s-light:#59873A;">catch</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">reject</span><span style="--s-dark:#666666;--s-light:#999999;">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">        }</span></span>
<span class="line"><span style="--s-dark:#DBD7CAEE;--s-light:#393A34;">  </span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999;">}</span></span></code></pre><p>这里可以看到，对于字符串，并不是直接使用 <code>btoa</code> 进行编码，而是通过构造 <code>blob</code> 数据然后通过 <code>FileReader</code> 来读取</p><p>原因是多数浏览器下 <code>btoa</code> 对 <code>Unicode</code> 字符串进行编码都会触发 <code>InvalidCharacterError</code> 异常</p><p>比如我对我的姓进行编码，直接报错</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202262137176.avif" alt=""></p><p>这是由于 <code>UTF-8</code> 是可变长度的，如果直接使用 <code>btoa</code> ，就可能报错</p><p><img src="https://fastly.jsdelivr.net/gh/Dedicatus546/image@main/2022/02/26/202202262136738.avif" alt=""></p><p>可以看到 <code>mdn</code> 也给出了编码 <code>Unicode</code> 字符串的一种方法，就是</p><p>转移任何扩展字符，转成 <code>ASCII</code> ，这样就可以使用 <code>btoa</code> 进行编码了</p><p>这里使用的是 <code>encodeURIComponent</code> 和 <code>decodeURIComponent</code></p><p>在截图的结尾，更加推荐使用类型化数组来进行转换</p><p>在源码中，对于 <code>ArrayBuffer</code> 类型就是使用 <code>Unit8Array</code> 来进行转化，然后再使用 <code>btoa</code></p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff;" tabindex="0"><code class="language-ts"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0;">// String.fromCharCode 拿到 ascii 编码后的字符串</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F;">if</span><span style="--s-dark:#666666;--s-light:#999999;"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#CB7676;--s-light:#AB5959;"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82;"> ArrayBuffer</span><span style="--s-dark:#666666;--s-light:#999999;">)</span><span style="--s-dark:#666666;--s-light:#999999;"> {</span><span style="--s-dark:#80A665;--s-light:#59873A;"> resolve</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">window</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">btoa</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">String</span><span style="--s-dark:#666666;--s-light:#999999;">.</span><span style="--s-dark:#80A665;--s-light:#59873A;">fromCharCode</span><span style="--s-dark:#666666;--s-light:#999999;">(...</span><span style="--s-dark:#CB7676;--s-light:#AB5959;">new</span><span style="--s-dark:#80A665;--s-light:#59873A;"> Uint8Array</span><span style="--s-dark:#666666;--s-light:#999999;">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48;">_target</span><span style="--s-dark:#666666;--s-light:#999999;">))))</span><span style="--s-dark:#666666;--s-light:#999999;"> }</span></span></code></pre><p>对于 <code>image</code> 和 <code>canvas</code> ，都是通过 <code>canvas.toDataURL</code> 来直接读取 <code>base64</code> 编码后的数据</p><p>其中 <code>image</code> 需要先 画 到 <code>canvas</code> 上，然后使用 <code>canvas.toDataURL</code> 处理</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#Base64</div><div>#JavaScript</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex=""><a href="/94f450fa1b14" class=""><i class="i-mi:chevron-left" mr-1=""></i><span>computed 可能成为一个错误的工具（译文）</span></a><a href="/25af57118a82" class="" ml-auto=""><span>解决嵌套flex布局子容器内容超出父容器</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-eedc551d="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-eedc551d=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-eedc551d=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-eedc551d=""></i></div><div flex="~ col grow" gap-4="" data-v-eedc551d=""><textarea disabled="" placeholder="万水千山总是情，留下评论行不行" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-4="" outline-0="" data-v-eedc551d=""></textarea><div flex="" items-start="" justify-between="" data-v-eedc551d=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-eedc551d=""> 支持 Markdown 语法 </a><button class="mujika-git-talk-button" cursor-pointer="" data-v-eedc551d=""> 点击登录 </button></div></div></div><!--]--></div></div><!----><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">文章目录</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153=""> CC BY-NC-SA 4.0 </a> 2021 - PRESENT © Dedicatus545 </div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153=""> 如果我和狗一样有尾巴的话，一定会藏不住这份喜悦，而尾巴一直摇个不停吧。 </div></footer></div></div>
  

</body></html>