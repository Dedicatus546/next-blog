<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/logo.svg"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Vue3.0Reactivityä¹‹reactive</title><script type="importmap">{"imports":{"vue":"https://esm.sh/vue","vue-router":"https://esm.sh/vue-router","pinia":"https://esm.sh/pinia","@vueuse/core":"https://esm.sh/@vueuse/core","@vueuse/components":"https://esm.sh/@vueuse/components","@vueuse/router":"https://esm.sh/@vueuse/router","date-fns":"https://esm.sh/date-fns","nprogress":"https://esm.sh/nprogress","octokit":"https://esm.sh/octokit","pinia-plugin-persistedstate":"https://esm.sh/pinia-plugin-persistedstate","vue-router-better-scroller":"https://esm.sh/vue-router-better-scroller"}}</script><script type="module" async="" crossorigin="" src="/assets/app-BzoAWw-A.js"></script><link rel="stylesheet" crossorigin="" href="/assets/app-DJrwyo0V.css"><link rel="modulepreload" crossorigin="" href="/assets/Vue3-0Reactivityä¹‹reactive-BYGjbPQn.js"><meta property="og:title" content="Vue3.0Reactivityä¹‹reactive"><meta name="twitter:title" content="Vue3.0Reactivityä¹‹reactive"></head><body><div id="app" data-server-rendered="true"><div class="mujika" min-h="100vh" flex="~ col" bg="[--mygo-c-bg-alt]"><header class="mujika-header" flex="~ shrink-0" px-4="" h="70px" bg="[var(--mygo-c-bg)]" items-center="" justify-between="" data-v-c1947e25=""><a href="/" class="" flex="" gap-4="" items-center="" data-v-c1947e25=""><img w="40px" aspect-ratio-square="" src="/logo.svg" alt="æ‹ã®æ­Œçš„logo" data-v-c1947e25=""></a><div data-v-c1947e25=""><div p-1="" flex="" gap-1="" rounded="6px" bg="[var(--mygo-c-bg-alt)]" data-v-c1947e25=""><!--[--><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="bg-[var(--mygo-c-bg)]" title="è‡ªåŠ¨" data-v-c1947e25=""><!--[-->Auto<!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="æ—¥é—´" data-v-c1947e25=""><!--[--><i class="i-ri:sun-line" data-v-c1947e25=""></i><!--]--></div><div leading="[1]" px-2="" py-1="" cursor-pointer="" rounded="6px" class="" title="å¤œé—´" data-v-c1947e25=""><!--[--><i class="i-ri:moon-line" data-v-c1947e25=""></i><!--]--></div><!--]--></div></div></header><main class="mujika-home" flex="grow" mx="auto" min-h="0" p-2="" w-full="" un-2xl:w="[calc(96rem-var(--spacing)*2)]"><div flex="" gap-2="" items-start=""><div flex="~ col grow" gap-2="" min-w-0=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ col" mb-4="" gap-4=""><h1 break-all="" text="34px center">Vue3.0Reactivityä¹‹reactive</h1></div><div flex="~ col" gap-3="" text="[var(--mygo-c-text-2)]"><div flex="~ wrap" gap-3="" justify-center=""><!----><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar"></i><span un-hidden="" lg:inline="">å‘è¡¨äº</span><span pl-1="">2020-06-12 11:12</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:calendar-check"></i><span un-hidden="" lg:inline="">æ›´æ–°äº</span><span pl-1="">2023-02-13 18:28</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:folder"></i><span un-hidden="" lg:inline="">åˆ†ç±»äº</span><!--[--><a pl-1="" href="/category/ç¼–ç¨‹">ç¼–ç¨‹</a><!--]--></div></div><div flex="~ wrap" gap-3="" justify-center=""><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:file-word"></i><span un-hidden="" lg:inline="">æ€»å­—æ•°</span><span pl-1="">4.0K</span></div><div flex="" gap-1="" items-center=""><i class="i-fa6-regular:clock"></i><span un-hidden="" lg:inline="">é˜…è¯»æ—¶é•¿ â‰ˆ</span><span pl-1="">15 åˆ†é’Ÿ</span></div></div></div><div class="mujika-doc-content"><!--[--><div class="kan-doc"><h1 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€">ğŸ”—</a></h1><p>å¼€å§‹æ¥å†™ä¸€äº›å…³äºVue3çš„reactivityåŒ…æºç çš„ç†è§£äº†ï¼Œå¯èƒ½æŸäº›åœ°æ–¹ä¼šæœ‰é”™è¯¯ï¼Œå¸Œæœ›å¯ä»¥æŒ‡å‡ºï¼Œæ„Ÿæ¿€ä¸å°½~</p><p>å› ä¸ºè¿™ä¸ªåŒ…ä¸­å…¶å®æ˜¯æ²¡æœ‰<code>watchEffect</code>å’Œ<code>watch</code>è¿™ä¸¤ä¸ªAPIçš„ï¼Œè¿™ä¸¤ä¸ªAPIåœ¨åˆ«çš„åŒ…ä¸­ï¼Œæ‰€ä»¥å¯èƒ½åœ¨åé¢å†è®²ï¼Œå› ä¸ºæˆ‘è¿˜æ²¡çœ‹â€¦</p><p>å¯¹äºè¿™ä¸ªåŒ…ï¼Œä¸»è¦çš„APIä¸º<code>reactive</code>ï¼Œ<code>readonly</code>ï¼Œ<code>ref</code>ï¼Œ<code>computed</code>ä»¥åŠæ²¡æœ‰åœ¨å…¨å±€Vueå¯¹è±¡æš´éœ²çš„<code>effect</code>ã€‚</p><h1 id="reactive" tabindex="-1"><code>reactive</code> <a class="header-anchor" href="#reactive">ğŸ”—</a></h1><p>é¦–å…ˆï¼Œéœ€è¦å»å•ç‹¬çš„æŠŠè¿™ä¸ªåŒ…ç¼–è¯‘æˆä¸€ä¸ªåœ¨æµè§ˆå™¨ç«¯å¯ä»¥å¼•å…¥çš„æ–‡ä»¶ï¼Œè¿™é‡Œå¯ä»¥çœ‹è¿™ä¸ªåŒ…ä¸‹é¢çš„<code>README.md</code>ï¼Œ</p><p>å¯ä»¥ç»“åˆä¹‹å‰çš„å¸–å­ Vue3.0å°é²œè¿™ä¸ªå¸–å­ã€‚</p><p>ç›´æ¥åœ¨vue-nextä¸‹ç›´æ¥è¿è¡Œ<code>yarn build reactivity --types</code>å°±å¯ä»¥ç¼–è¯‘å‡ºæ–‡ä»¶ï¼Œé€‰æ‹©<code>reactivity.global.js</code>å³å¯ã€‚</p><p><a data-fancybox="doc-gallery" href="https://i.loli.net/2020/04/27/qdIn4zOsF6NZMKk.png" target="_blank" rel="noopener noreferrer"><img src="https://i.loli.net/2020/04/27/qdIn4zOsF6NZMKk.png" alt=""></a></p><p>è¿™æ¬¡è®²ä¸‹<code>reactive</code>æ–¹æ³•ã€‚åœ¨å‰é¢å…³äºReactivityä¸»è¦APIçš„ç¿»è¯‘å¯ä»¥çŸ¥é“ï¼Œ<code>reactive</code>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åŒ…è£…ä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªå“åº”å¼çš„å¯¹è±¡ã€‚</p><p>åœ¨Reactivityçš„åŒ…ä¸­çš„srcä¸‹ï¼Œå¯ä»¥æ‰¾åˆ°reactiveçš„tsæ–‡ä»¶ï¼Œå…¶ä¸­å¯¹<code>reactive</code>çš„å®šä¹‰å¦‚ä¸‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // if trying to observe a readonly proxy, return the readonly version.</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // å¦‚æœå°è¯•å»è§‚å¯Ÿä¸€ä¸ªåªè¯»çš„ä»£ç†ï¼Œç›´æ¥è¿”å›åªè¯»çš„ç‰ˆæœ¬å³å¯</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">readonlyToRaw</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    target</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    rawToReactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    reactiveToRaw</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    mutableHandlers</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    mutableCollectionHandlers</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  )</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦çš„åˆ›å»ºé€»è¾‘æ˜¯<code>createReactiveObject</code>è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ª<code>readonlyToRaw</code>æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢</p><p>å¯ä»¥åœ¨å‰é¢çš„å®šä¹‰ä¸­ï¼Œå‘ç°æœ‰å››ä¸ªWeakMapçš„å®šä¹‰</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// WeakMaps that store {raw &lt;-&gt; observed} pairs.</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">// å­˜å‚¨åŸç”Ÿå¯¹è±¡ï¼ˆrawï¼‰ &lt;-&gt; è§‚å¯Ÿè€…å¯¹è±¡ï¼ˆobservedï¼‰</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">rawToReactive</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">reactiveToRaw</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">rawToReadonly</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">readonlyToRaw</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span></code></pre><p>æ ¹æ®å®˜æ–¹çš„æ³¨é‡Šå’Œå˜é‡çš„åå­—ä¸éš¾çœ‹å‡ºï¼Œè¿™å››ä¸ªWeakMapç”¨æ¥å­˜å‚¨åŸç”Ÿå¯¹è±¡å’Œè§‚å¯Ÿè€…å¯¹è±¡ä¹‹é—´çš„_åŒå‘å…³ç³»_</p><p>å…¶ä¸­</p><ul><li><code>rawToReactive</code>ï¼š åŸç”Ÿå¯¹è±¡ -&gt; å“åº”å¼å¯¹è±¡</li><li><code>reactiveToRaw</code>ï¼š å“åº”å¼å¯¹è±¡ -&gt; åŸç”Ÿå¯¹è±¡</li><li><code>rawToReadonly</code>ï¼š åŸç”Ÿå¯¹è±¡ -&gt; åªè¯»å¯¹è±¡</li><li><code>readonlyToRaw</code>ï¼š åªè¯»å¯¹è±¡ -&gt; åŸç”Ÿå¯¹è±¡</li></ul><p>å¯ä»¥çŒœæµ‹ï¼Œæ¯åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œå°±ä¼šé€šè¿‡è¿™äº›WeakMapå»ºç«‹ä»£ç†ä¸æºå¯¹è±¡çš„åŒå‘å…³ç³»ã€‚</p><p>okï¼Œæˆ‘ä»¬ç»§ç»­çœ‹<code>createReactiveObject</code>è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼ å…¥äº†äº”ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯targetï¼ˆæºå¯¹è±¡ï¼‰ï¼Œä¸¤ä¸ªå…³äºå“åº”å¼å¯¹è±¡çš„WeakMapï¼Œä»¥åŠä¸¤ä¸ªhandlersï¼Œ</p><p>è¿™ä¸¤ä¸ªhandlersåˆæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œå¯ä»¥çœ‹åˆ°å¤´éƒ¨å¼•ç”¨äº†å¦ä¸€ä¸ªæ–‡ä»¶çš„å¥½å‡ ä¸ªä¸åŒçš„handlers</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  mutableHandlers</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  readonlyHandlers</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  shallowReactiveHandlers</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  shallowReadonlyHandlers</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">./baseHandlers</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  mutableCollectionHandlers</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  readonlyCollectionHandlers</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">./collectionHandlers</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span></code></pre><p>ä»æ–‡ä»¶åæ¥çœ‹ï¼Œ<code>baseHandlers</code>åº”è¯¥æ˜¯åŸºç¡€çš„ä¸€ç§handlersï¼Œè€Œ<code>collectionHandlers</code>åº”è¯¥æ˜¯å…³äºé›†åˆçš„ä¸€ç§handlersï¼Œ</p><p>ç„¶åä»å¼•å…¥çš„handlersåå­—æ¥çœ‹ï¼Œ</p><ul><li><code>mutableHandlers</code>ï¼šå¯å˜handlers</li><li><code>readonlyHandlers</code>ï¼šåªè¯»handlers</li><li><code>shallowReactiveHandlers</code>ï¼šæµ…å“åº”handlers</li><li><code>shallowReadonlyHandlers</code>ï¼šæµ…åªè¯»handlers</li><li><code>mutableCollectionHandlers</code>ï¼šå¯å˜é›†åˆhandlers</li><li><code>readonlyCollectionHandlers</code>ï¼šåªè¯»é›†åˆhandlers</li></ul><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>mutableHandlers</code>çš„å®šä¹‰</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">mutableHandlers</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ProxyHandler</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  get</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  set</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  deleteProperty</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  has</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ownKeys</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œå°±æ˜¯Proxyç¬¬äºŒä¸ªå‚æ•°ä¸­å¯ä»¥é…ç½®çš„æ‹¦æˆªå‡½æ•°ã€‚</p><p>å¯¹äºè¿™ä¸ªhandlerï¼Œå…ˆä¸è®²é‚£ä¹ˆæ·±ï¼Œåªè¦çŸ¥é“ï¼Œè¿™ä¸ªhandlerså°±æ‹¦æˆªäº†æ“ä½œ</p><p>å…ˆçœ‹ä¹‹å‰è¯´çš„<code>createReactiveObject</code>å‡½æ•°ï¼Œå®ƒçš„å®šä¹‰ä¸º</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toProxy</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toRaw</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  baseHandlers</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ProxyHandler</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  collectionHandlers</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ProxyHandler</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#80A665;--s-light:#59873A">isObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">__DEV__</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">warn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">value cannot be made reactive: </span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#80A665;--s-light:#59873A">String</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D;--s-light:#B56959">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // target already has corresponding Proxy</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> toProxy</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> void</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // target is already a Proxy</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">toRaw</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // only a whitelist of value types can be observed.</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#80A665;--s-light:#59873A">canObserve</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handlers</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> collectionTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">constructor</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> collectionHandlers</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> baseHandlers</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  observed</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Proxy</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handlers</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toProxy</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toRaw</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>é¦–å…ˆæ˜¯ç¬¬ä¸€æ®µ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#80A665;--s-light:#59873A">isObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">__DEV__</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">warn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#C98A7D;--s-light:#B56959">value cannot be made reactive: </span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#80A665;--s-light:#59873A">String</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#C98A7D;--s-light:#B56959">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¾ˆæ˜æ˜¾ï¼Œæ ¹æ®å‡½æ•°åå°±å¯ä»¥åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯å¯¹è±¡çš„è¯ï¼Œç›´æ¥è¿”å›æºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½å¯¹åŸºæœ¬ç±»å‹è¿›è¡Œå“åº”å¼åŒ…è£…ã€‚</p><p><code>__DEV__</code>æ˜¯ä¸€ä¸ªå¼€å‘ç¯å¢ƒçš„å˜é‡ï¼Œå¦‚æœåœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œå°±ä¼šæ‰“å°ä¸€åˆ™è­¦å‘Šæ¥æé†’ç”¨æˆ·ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // target already has corresponding Proxy</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ç›®æ ‡æ—©å·²æœ‰ç›¸åº”çš„ä»£ç†</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> toProxy</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> void</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // target is already a Proxy</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ç›®æ ‡æœ¬èº«å°±æ˜¯ä¸€ä¸ªä»£ç†</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">toRaw</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¦‚æœæºå¯¹è±¡å­˜åœ¨ä»£ç†å¯¹è±¡æˆ–è€…æºå¯¹è±¡å·²æ˜¯ä¸€ä¸ªä»£ç†æ—¶ï¼Œå°±ç›´æ¥è¿”å›ï¼Œé˜²æ­¢åˆ›å»ºå¤šä¸ªå“åº”å¼å¯¹è±¡ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // only a whitelist of value types can be observed.</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // åªè¦åœ¨ç™½åå•ä¸­çš„ç±»å‹æ‰å¯ä»¥è¢«è§‚å¯Ÿ</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#80A665;--s-light:#59873A">canObserve</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™å¥ä¸éš¾ç†è§£ï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥è¢«è§‚å¯Ÿï¼Œè¿™ä¸ªå‡½æ•°çš„å®šä¹‰ä¸º</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#80A665;--s-light:#59873A">canObserve</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> boolean</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_isVue</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_isVNode</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    isObservableType</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">toRawType</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">rawValues</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">Object</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">isFrozen</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  )</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>æ ¹æ®å˜é‡åå¯ä»¥è¯»å‡ºï¼Œè¿™ä¸ªå¯¹è±¡å¿…é¡»</p><ul><li>ä¸æ˜¯<code>Vue</code>å¯¹è±¡</li><li>ä¸æ˜¯<code>VNode</code>å¯¹è±¡</li><li>åœ¨å¯å“åº”å¼çš„ç±»å‹ä¸­</li><li>æ²¡è¢«å†»ç»“</li><li>åŸç”Ÿå¯¹è±¡Mapä¸å«è¿™ä¸ªå¯¹è±¡</li></ul><p>è½¬åˆ°<code>isObservableType</code>çš„å®ç°ï¼Œå¯ä»¥ç¡®å®šå¯è§‚å¯Ÿçš„ç±»å‹åªæœ‰ <code>Object</code>,<code>Array</code>,<code>Map</code>,<code>Set</code>,<code>WeakMap</code>,<code>WeakSet</code>è¿™å‡ ç§ç±»å‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">isObservableType</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> /*#__PURE__*/</span><span style="--s-dark:#80A665;--s-light:#59873A"> makeMap</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#C98A7D77;--s-light:#B5695977">  '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">Object,Array,Map,Set,WeakMap,WeakSet</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span></span></code></pre><p>æœ€åä¸€æ®µï¼Œä¾¿æ˜¯åˆ›å»ºä»£ç†å¯¹è±¡äº†</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">handlers</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> collectionTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">constructor</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> collectionHandlers</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> baseHandlers</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  observed</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Proxy</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> handlers</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toProxy</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  toRaw</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">observed</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> observed</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>é¦–å…ˆæ˜¯åˆ¤æ–­æºå¯¹è±¡çš„ç±»å‹ï¼Œç”¨æ„é€ å™¨å»åˆ¤æ–­ï¼Œç„¶åä½¿ç”¨å¯¹åº”çš„handlersåˆ›å»ºProxyä»£ç†å¯¹è±¡ã€‚ç„¶åä¿å­˜ä»£ç†å¯¹è±¡å’Œæºå¯¹è±¡çš„å…³ç³»ï¼ˆé€šè¿‡å‰æ–‡è¯´åˆ°çš„WeakMapï¼‰ï¼Œæœ€åè¿”å›è¿™ä¸ªå“åº”å¼å¯¹è±¡ã€‚</p><p>è‡³æ­¤ï¼Œå¯¹äºå“åº”å¼å¯¹è±¡åˆ›å»ºçš„åŸºæœ¬æµç¨‹å·²ç»æ˜æœ—</p><p>å›è¿‡å¤´æ¥ï¼Œä¸ºä»€ä¹ˆè¿”å›çš„è¿™ä¸ªä»£ç†å¯¹è±¡å°±æ˜¯å“åº”å¼çš„å‘¢ï¼Ÿ</p><p>è¿™éœ€è¦æˆ‘ä»¬å»çœ‹åˆ›å»ºå“åº”å¼çš„handlersçš„å†…å®¹äº†</p><p>æˆ‘ä»¬åœ¨å‰é¢æœ‰è¯´åˆ°ï¼Œè¿™ä¸ªæ–‡ä»¶å¼•å…¥äº†å¤šä¸ªhandlersï¼Œå…¶ä¸­ä¸€ä¸ªä¸º</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">mutableHandlers</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ProxyHandler</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">&gt; =</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  get</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  set</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  deleteProperty</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  has</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  ownKeys</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»è¿™é‡Œå…¥æ‰‹ï¼Œæ¢ç©¶ä½•ä¸ºå“åº”å¼ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å»çœ‹Vueçš„RFCæ–‡æ¡£</p><p><a href="https://vue-composition-api-rfc.netlify.app/#api-introduction" target="_blank" rel="noopener">Composition API RFC | Vue Composition API</a></p><p>é‡Œé¢å…³äºDetailed Designï¼ˆè¯¦ç»†è®¾è®¡ï¼‰ä¸­çš„API Introductionï¼ˆAPIä»‹ç»ï¼‰æœ‰ä¸€æ®µæˆ‘è§‰å¾—å¾ˆå¥½çš„è§£é‡Šäº†å…³äºå“åº”å¼è¿™ä¸ªå«ä¹‰</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">import</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> watchEffect</span><span style="--s-dark:#666666;--s-light:#999999"> }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> from</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">vue</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  count</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">0</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">watchEffect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  document</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">body</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">innerHTML</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> `</span><span style="--s-dark:#C98A7D;--s-light:#B56959">count is </span><span style="--s-dark:#4D9375;--s-light:#1E754F">${</span><span style="--s-dark:#C98A7D;--s-light:#B56959">state</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#C98A7D;--s-light:#B56959">count</span><span style="--s-dark:#4D9375;--s-light:#1E754F">}</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">`</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">})</span></span></code></pre><p>è¿™ä¸€æ®µè¯ä¸­æˆ‘è§‰å¾—ä¸‹é¢è¿™å¥è¯ï¼ˆä»¥åŠç®€çŸ­çš„ä»£ç æ®µï¼‰é—´æ¥æ˜äº†åœ°è§£é‡Šäº†å“åº”å¼</p><blockquote><p>Thanks to dependency tracking, the view automatically updates when reactive state changes.</p></blockquote><p>è¿™å¥è¯å¤§æ„æ˜¯ï¼šå¤šäºäº†ä¾èµ–çš„æ”¶é›†ï¼Œè§†å›¾å¯ä»¥è‡ªåŠ¨åœ°åœ¨å“åº”å¼çŠ¶æ€çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶è€Œæ›´æ–°ã€‚</p><p>å¯¹åº”åˆ°ä»£ç ä¸­ï¼Œå°±æ˜¯å½“<code>state.count</code>å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä½¿ç”¨åˆ°<code>state.count</code>çš„å‡½æ•°ä¾¿ä¼šè‡ªåŠ¨çš„é‡æ–°æ‰§è¡Œã€‚</p><p>é‚£ä¹ˆç°åœ¨å…¶å®é—®é¢˜å°±å¾ˆæ˜äº†äº†ï¼Œå¦‚ä½•æ”¶é›†ä¾èµ–ï¼Ÿä¹Ÿå°±æ˜¯æ”¶é›†å˜é‡æ”¹å˜çš„å‡½æ•°ï¼Ÿ å¦‚ä½•è§¦å‘ä¾èµ–ï¼Ÿä¹Ÿå°±æ˜¯åœ¨å˜é‡æ”¹å˜æ—¶é‡æ–°æ‰§è¡Œè·Ÿå®ƒæœ‰å…³çš„å‡½æ•°ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ç”¨<code>effect</code>ä»£æ›¿<code>watchEffect</code>ï¼ˆ<code>watchEffect</code>å°±æ˜¯åœ¨<code>effect</code>ä¸Šæ‰©å±•çš„ï¼ŒåŒ…ä¸­æ˜¯æ²¡æœ‰<code>watchEffect</code>çš„ï¼‰ï¼Œæµ‹è¯•çš„åŠ¨å›¾å¦‚ä¸‹ï¼š</p><p><a data-fancybox="doc-gallery" href="https://i.loli.net/2020/04/28/ElmtjcoKY94AZnD.gif" target="_blank" rel="noopener noreferrer"><img src="https://i.loli.net/2020/04/28/ElmtjcoKY94AZnD.gif" alt=""></a></p><p>okï¼Œæˆ‘ä»¬å¼€å§‹æ¥çœ‹<code>mutableHandlers</code>ä¸­çš„<code>get</code>å±æ€§ï¼Œå‘ç°å®ƒçš„å®šä¹‰ä¸º</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">get</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> /*#__PURE__*/</span><span style="--s-dark:#80A665;--s-light:#59873A"> createGetter</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>æˆ‘ä»¬æ¥ç€çœ‹<code>createGetter</code>è¿™ä¸ªå‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createGetter</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isReadonly</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> shallow</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">symbol</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> receiver</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">targetIsArray</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> isArray</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">targetIsArray</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> hasOwn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">arrayInstrumentations</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Reflect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">arrayInstrumentations</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> receiver</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">res</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Reflect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> receiver</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">isSymbol</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> builtInSymbols</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> res</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shallow</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isReadonly</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">GET</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> res</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">isRef</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">res</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">targetIsArray</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">        !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isReadonly</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">GET</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> res</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">        // ref unwrapping, only for Objects, not for Arrays.</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> res</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isReadonly</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">GET</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#80A665;--s-light:#59873A"> isObject</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">res</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      ?</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> isReadonly</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">        ?</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> // need to lazy access readonly and reactive here to avoid</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">          // circular dependency</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">          readonly</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">res</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">        :</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">res</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">      :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> res</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å“‡ï¼Œè¿™ä¹ˆé•¿ï¼Œæˆ‘çœ‹ä¸æ‡‚å•Šå•Šå•Šå•Š</p><p>å…¶å®ï¼Œç°åœ¨å¹¶ä¸éœ€è¦å…¨éƒ¨éƒ½çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å‡½æ•°ä¸­é™¤äº†ä¸€ä¸ª<code>track</code>å‡½æ•°</p><p>ä¹Ÿå°±æ˜¯æ‰€è°“çš„æ”¶é›†ä¾èµ–å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹è¿›å»çœ‹ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°å®šä¹‰åœ¨<code>effect.ts</code>æ–‡ä»¶ä¸­</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shouldTrack</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeEffect</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Map</span><span style="--s-dark:#666666;--s-light:#999999">()))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Set</span><span style="--s-dark:#666666;--s-light:#999999">()))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    dep</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">deps</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">__DEV__</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">onTrack</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">onTrack</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">        effect</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        target</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        type</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        key</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™é‡Œå‡ºç°å‡ ä¸ªå…¨å±€å®šä¹‰çš„å˜é‡ï¼Œåˆ†åˆ«æ˜¯<code>shouldTrack</code>ï¼Œ<code>activeEffect</code>ï¼Œ<code>targetMap</code></p><p>æˆ‘ä»¬å¯ä»¥å¾€å‰æ‰¾ï¼Œæ‰¾åˆ°è¿™ä¸‰ä¸ªçš„å®šä¹‰</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">type</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Dep</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Set</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">type</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> KeyToDepMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Map</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Dep</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">targetMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">WeakMap</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> KeyToDepMap</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span></code></pre><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectStack</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">[] =</span><span style="--s-dark:#666666;--s-light:#999999"> []</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span></span></code></pre><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">shouldTrack</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">trackStack</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">boolean</span><span style="--s-dark:#666666;--s-light:#999999">[] =</span><span style="--s-dark:#666666;--s-light:#999999"> []</span></span></code></pre><p>æ ¹æ®å˜é‡çš„è¯­ä¹‰ä¸éš¾æ¨å‡ºæ„æ€ï¼Œ</p><p>å…¶ä¸­<code>targetMap</code>å­˜å‚¨ï¼šå¯¹è±¡ -&gt; å±æ€§ï¼Œè€Œè¿™ä¸ªå±æ€§ä¹Ÿæ˜¯ä¸€ä¸ªMapï¼Œå­˜å‚¨ å±æ€§ -&gt; ReactiveEffectï¼Œè¿™ä¸ªReactiveEffectæ˜¯ä¸€ä¸ªSetã€‚</p><p><code>activeEffect</code>è¡¨ç¤ºå½“å‰çš„æ´»åŠ¨Effectã€‚</p><p><code>shouldTrack</code>è¡¨ç¤ºåº”ä¸åº”è¯¥æ”¶é›†ä¾èµ–ã€‚</p><p>okï¼Œæ¥ç€æˆ‘ä»¬åˆ†æè¿™ä¸ªå‡½æ•°ï¼Œ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shouldTrack</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeEffect</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> undefined</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¼€å¤´å…ˆåˆ¤æ–­å¦‚æœä¸åº”è¯¥æ”¶é›†ï¼Œæˆ–è€…å½“å‰æ´»åŠ¨çš„Effectä¸º<code>undefined</code>ï¼Œç›´æ¥è¿”å›</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ç¬¬ä¸€æ¬¡ä¸ºç©ºï¼Œå°±åˆå§‹åŒ–</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Map</span><span style="--s-dark:#666666;--s-light:#999999">()))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  let </span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ç¬¬ä¸€æ¬¡ä¸ºç©ºï¼Œå°±åˆå§‹åŒ–</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new</span><span style="--s-dark:#80A665;--s-light:#59873A"> Set</span><span style="--s-dark:#666666;--s-light:#999999">()))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™ä¸€æ®µï¼Œæ‰¾å‡ºå¯¹è±¡çš„ä¾èµ–Mapï¼Œä¹Ÿå°±æ˜¯ <code>Map&amp;lt;å±æ€§å,Set&amp;lt;Effect&amp;gt;&amp;gt;</code>ï¼Œ</p><p>å†æ‰¾å‡ºå¯¹åº”å±æ€§åçš„Setï¼Œä¹Ÿå°±æ˜¯<code>Set&amp;lt;Effect&amp;gt;</code></p><p>å¹¶ä¸”å¯¹è¿™ä¸¤ä¸ªåšäº†ç©ºåˆ¤æ–­å¹¶åˆå§‹åŒ–ã€‚</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> track</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TrackOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">has</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    dep</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">deps</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">__DEV__</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">onTrack</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">onTrack</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">        effect</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        target</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        type</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        key</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>æœ€åï¼Œåˆ¤æ–­å¦‚æœå½“å‰çš„effectä¸åœ¨<code>Set&amp;lt;Effect&amp;gt;</code>ä¸­ï¼Œå°±æŠŠè¿™ä¸ªeffectå­˜è¿›å»ï¼Œå¹¶ä¸”åœ¨å½“å‰effectä¸Šçš„depsä¸ŠæŠŠæ‹¥æœ‰è‡ªå·±çš„Setä¹Ÿç»™å­˜è¿›å»ã€‚ç„¶åå°±æ˜¯åœ¨å¼€å‘æ¨¡å¼ä¸‹è°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„<code>onTrack</code>å‡½æ•°äº†ã€‚</p><p>è¿™é‡Œå¯èƒ½ä¼šç–‘é—®ï¼Œå¦‚ä½•çŸ¥é“å½“å‰çš„effectå°±æ˜¯è¿™ä¸ªtargetçš„keyçš„ä¾èµ–å‘¢ï¼Ÿ</p><p>è¿™é‡Œéœ€è¦æŠŠç›®å…‰å…ˆè½¬å‘<code>effect</code>å‡½æ•°</p><p>åœ¨å‰é¢çš„ä¸€ä¸ªæµè§ˆå™¨è·‘çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“</p><p>å¾€<code>effect</code>ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨ä½¿ç”¨å“åº”å¼å˜é‡å°±èƒ½æ”¶é›†è¿™ä¸ªå‡½æ•°ä½œä¸ºä¾èµ–ã€‚</p><p>åœ¨åŒä¸€ä¸ªæ–‡ä»¶å†…å¯ä»¥æ‰¾åˆ°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> effect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  fn</span><span style="--s-dark:#666666;--s-light:#999999">: () =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffectOptions</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> EMPTY_OBJ</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">isEffect</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fn</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    fn</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> fn</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">raw</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">fn</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> options</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">lazy</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">    effect</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å‘ç°<code>effect</code>çš„å®ç°ä¸éš¾ï¼Œä¸»è¦çš„é€»è¾‘åœ¨<code>createReactiveEffect</code>å‡½æ•°ä¸­ã€‚æ‰¾åˆ°å®ƒ</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  fn</span><span style="--s-dark:#666666;--s-light:#999999">: (...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">[]) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffectOptions</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function </span><span style="--s-dark:#80A665;--s-light:#59873A">reactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">[]):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> unknown</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">active</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ? undefined : </span><span style="--s-dark:#80A665;--s-light:#59873A">fn</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">includes</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      cleanup</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        enableTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> finally</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pop</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        resetTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effectStack</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">]</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> ReactiveEffect</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">id</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> uid</span><span style="--s-dark:#CB7676;--s-light:#AB5959">++</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">_isEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">active</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">raw</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> fn</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">deps</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> []</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> options</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>å¯¹äºè¿™ä¹ˆé•¿çš„ä»£ç ï¼Œåªéœ€å…³æ³¨æœ€é‡è¦çš„ä¸€éƒ¨åˆ†</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">&gt;(</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">  fn</span><span style="--s-dark:#666666;--s-light:#999999">: (...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">any</span><span style="--s-dark:#666666;--s-light:#999999">[]) =&gt; </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  options</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffectOptions</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">T</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function </span><span style="--s-dark:#80A665;--s-light:#59873A">reactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">[]):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> unknown</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">includes</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      cleanup</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      try</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        enableTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">push</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#80A665;--s-light:#59873A"> fn</span><span style="--s-dark:#666666;--s-light:#999999">(...</span><span style="--s-dark:#BD976A;--s-light:#B07D48">args</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> finally</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">pop</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        resetTracking</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        activeEffect</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effectStack</span><span style="--s-dark:#666666;--s-light:#999999">[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectStack</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#B8A965;--s-light:#998418">length</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> - </span><span style="--s-dark:#4C9A91;--s-light:#2F798A">1</span><span style="--s-dark:#666666;--s-light:#999999">]</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> ReactiveEffect</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>é¦–å…ˆåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯åœ¨effectçš„æ ˆä¸­ï¼Œå¦‚æœåœ¨æ ˆä¸­ï¼Œè¦å¯¹è¿™ä¸ªeffectè¿›è¡Œæ¸…ç†åˆå§‹åŒ–ï¼Œ</p><p>ç„¶å<code>enableTracking()</code>ï¼Œä¿å­˜ä¸Šä¸€ä¸ª<code>shouldTrack</code>çš„çŠ¶æ€ï¼Œå¹¶æŠŠå½“å‰<code>shouldTrack</code>ç½®ä¸ºtrueï¼Œç„¶åæŠŠè‡ªå·±ä¿å­˜åˆ°effectæ ˆçš„æ ˆé¡¶ï¼Œå¹¶å°†<code>activeEffect</code>æŒ‡å‘è‡ªèº«ã€‚</p><p>æ¥ç€ï¼Œç›´æ¥è¿è¡Œè¿™ä¸ªä¼ è¿›æ¥çš„å‡½æ•°</p><p>æ³¨æ„ï¼Œè¿˜è®°å¾—å—ï¼Œè¿™é‡Œè¿è¡Œå°±ä¼šè§¦å‘å“åº”å¼å¯¹è±¡<code>get</code>æ‹¦æˆªæ–¹æ³•ä¸­çš„<code>track</code>æ–¹æ³•ï¼Œè€Œ<code>track</code>æ–¹æ³•ä¼šå°†å½“å‰çš„effectä¸å¯¹åº”å¯¹è±¡çš„å±æ€§åè¿›è¡Œå…³è”ï¼Œ</p><p>æœ€ååœ¨finallyå—ä¸­å°†å½“å‰çš„effectå¼¹å‡ºï¼Œé‡ç½®<code>shouldTrack</code>ä¸ºä¸Šä¸€æ¬¡çš„çŠ¶æ€çš„ï¼ŒæŠŠå½“å‰çš„effectæŒ‡å‘æ ˆçš„å€’æ•°ç¬¬äºŒä¸ªeffectã€‚æ¢å¤äº†ä¸Šä¸€æ¬¡çš„çŠ¶æ€ã€‚</p><p>ä¸ºä»€ä¹ˆè¦ä¿å­˜å†å²çš„<code>shouldTrack</code>çŠ¶æ€ï¼Œå› ä¸ºåœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå¯èƒ½ä¼šè§¦å‘å¤šä¸ªå“åº”å¼å˜é‡å±æ€§çš„<code>get</code>ã€‚</p><p>æ‰€ä»¥ï¼Œå¯¹äºå‰é¢çš„å¦‚ä½•çŸ¥é“å½“å‰çš„effectå°±æ˜¯è¿™ä¸ªtargetçš„keyçš„ä¾èµ–å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬å°±è§£å†³äº†ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç†æ˜ç™½å¦‚ä½•åœ¨æ”¹å˜å“åº”å¼å¯¹è±¡çš„å€¼ä¹‹åï¼Œè§¦å‘ä¾èµ–ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼‰</p><p>æˆ‘ä»¬å›åˆ°<code>mutableHandlers</code>ï¼Œè¿™æ¬¡æˆ‘ä»¬çœ‹ä¸‹<code>set</code>çš„å®ç°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">set</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0"> /*#__PURE__*/</span><span style="--s-dark:#80A665;--s-light:#59873A"> createSetter</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span></code></pre><p>å‘ç°ä»–ä¹Ÿæ˜¯è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬è½¬åˆ°è¿™ä¸ªå‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">function</span><span style="--s-dark:#80A665;--s-light:#59873A"> createSetter</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shallow</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> false</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  return</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> set</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    key</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">string</span><span style="--s-dark:#666666;--s-light:#999999"> | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">symbol</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    value</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    receiver</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  ):</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> boolean</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">oldValue</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> any</span><span style="--s-dark:#666666;--s-light:#999999">)[</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">]</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shallow</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> toRaw</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#80A665;--s-light:#59873A">isArray</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> isRef</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">oldValue</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !</span><span style="--s-dark:#80A665;--s-light:#59873A">isRef</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        oldValue</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        return</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> true</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">      // in shallow mode, objects are set as-is regardless of reactive or not</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">hadKey</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> hasOwn</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">result</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> Reflect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">set</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> receiver</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // don't trigger if target is something up in the prototype chain of original</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#80A665;--s-light:#59873A"> toRaw</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">receiver</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">hadKey</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ADD</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#80A665;--s-light:#59873A">hasChanged</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">value</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> oldValue</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SET</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> value</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> oldValue</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> result</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€ä¸ª<code>trigger</code>çš„å‡½æ•°ï¼Œæ ¹æ®è‹±æ–‡çŸ¥é“å®ƒçš„æ„æ€æ˜¯è§¦å‘çš„æ„æ€ã€‚å¯ä»¥åˆ¤æ–­å®ƒåº”è¯¥å°±æ˜¯è§¦å‘ä¾èµ–çš„å‡½æ•°ã€‚æˆ‘ä»¬è½¬åˆ°è¿™ä¸ªå‡½æ•°</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-typescript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  target</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#CB7676;--s-light:#AB5959">object</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  type</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  key</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  newValue</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  oldValue</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  oldTarget</span><span style="--s-dark:#CB7676;--s-light:#AB5959">?</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Map</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">, </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">&gt; | </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Set</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">unknown</span><span style="--s-dark:#666666;--s-light:#999999">&gt;</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> targetMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#CB7676;--s-light:#AB5959">!</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // never been tracked</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    return</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">effects</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">Set</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">computedRunners</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> new </span><span style="--s-dark:#80A665;--s-light:#59873A">Set</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&gt;()</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectsToAdd</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">Set</span><span style="--s-dark:#666666;--s-light:#999999">&lt;</span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">&gt; | </span><span style="--s-dark:#CB7676;--s-light:#AB5959">undefined</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effectsToAdd</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      effectsToAdd</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">        if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !== </span><span style="--s-dark:#BD976A;--s-light:#B07D48">activeEffect</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> || !</span><span style="--s-dark:#BD976A;--s-light:#B07D48">shouldTrack</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">          if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">computed</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">            computedRunners</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">          }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">            effects</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">          }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">          // the effect mutated its own dependency during its execution.</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">          // this can be caused by operations like foo.value++</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">          // do not trigger or we end in an infinite loop</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">        }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">type</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">CLEAR</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // collection being cleared</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // trigger all effects for target</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">add</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">length</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#80A665;--s-light:#59873A"> isArray</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">    depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">((</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">      if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">length</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> key</span><span style="--s-dark:#666666;--s-light:#999999"> &gt;=</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">newValue</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> as</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> number</span><span style="--s-dark:#666666;--s-light:#999999">))</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">        add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">dep</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // schedule runs for SET | ADD | DELETE</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> void</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // also run for iteration key on ADD | DELETE | Map.SET</span></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">    const </span><span style="--s-dark:#BD976A;--s-light:#B07D48">isAddOrDelete</span><span style="--s-dark:#666666;--s-light:#999999"> =</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      type</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> === </span><span style="--s-dark:#BD976A;--s-light:#B07D48">TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">ADD</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">type</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> === </span><span style="--s-dark:#BD976A;--s-light:#B07D48">TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">DELETE</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp; !</span><span style="--s-dark:#80A665;--s-light:#59873A">isArray</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      isAddOrDelete</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ||</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">type</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ===</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> TriggerOpTypes</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">SET</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Map</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    )</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#80A665;--s-light:#59873A">isArray</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">target</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> ?</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977"> '</span><span style="--s-dark:#C98A7D;--s-light:#B56959">length</span><span style="--s-dark:#C98A7D77;--s-light:#B5695977">'</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> :</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> ITERATE_KEY</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">isAddOrDelete</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp;</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> target</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> instanceof</span><span style="--s-dark:#5DA994;--s-light:#2E8F82"> Map</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">MAP_KEY_ITERATE_KEY</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">  const </span><span style="--s-dark:#80A665;--s-light:#59873A">run</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">: </span><span style="--s-dark:#5DA994;--s-light:#2E8F82">ReactiveEffect</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">__DEV__</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> &amp;&amp; </span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">onTrigger</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">onTrigger</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        effect</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        target</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        key</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        type</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        newValue</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        oldValue</span><span style="--s-dark:#666666;--s-light:#999999">,</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">        oldTarget</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">      })</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">      effect</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">options</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">scheduler</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">effect</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      effect</span><span style="--s-dark:#666666;--s-light:#999999">()</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // Important: computed effects must be run first so that computed getters</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // can be invalidated before any normal effects that depend on them are run.</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  computedRunners</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">run</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  effects</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">forEach</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">run</span><span style="--s-dark:#666666;--s-light:#999999">)</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>è¿™ä¹ˆé•¿çš„å‡½æ•°ï¼Œåªéœ€å…³æ³¨é‡è¦çš„åœ°æ–¹å³å¯ã€‚</p><p>æˆ‘ä»¬å‘ç°å¼€å¤´å°±æ˜¯æŠŠå¯¹è±¡çš„å±æ€§Mapç»™å–äº†å‡ºæ¥ã€‚</p><p>ç„¶åæˆ‘ä»¬åªéœ€æ³¨æ„<code>add</code>å‡½æ•°å’Œ<code>run</code>å‡½æ•°ï¼Œ<code>add</code>å‡½æ•°æŠŠä¼ è¿›æ¥çš„ä¾èµ–æ·»åŠ åˆ°<code>effects</code>å’Œ<code>computedRunners</code>ï¼ˆè¿™ä¸ªæ˜¯è®¡ç®—å±æ€§ï¼Œä¹Ÿæ˜¯ç”±<code>effect</code>å®ç°ï¼Œä¹‹åä¼šå°†ï¼‰ï¼Œ</p><p>ç„¶åä¸­é—´æ˜¯ä¸€å¤§å †çš„ifåˆ¤æ–­ï¼Œæˆ‘ä»¬åªéœ€çœ‹å…¶ä¸­çš„ä¸€å¥</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">export</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> function</span><span style="--s-dark:#80A665;--s-light:#59873A"> trigger</span><span style="--s-dark:#666666;--s-light:#999999">(</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">  // ...</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">  if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0">/* ... */</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#758575DD;--s-light:#A0ADA0">/* ... */</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span><span style="--s-dark:#4D9375;--s-light:#1E754F"> else</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // schedule runs for SET | ADD | DELETE</span></span>
<span class="line"><span style="--s-dark:#4D9375;--s-light:#1E754F">    if</span><span style="--s-dark:#666666;--s-light:#999999"> (</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> !==</span><span style="--s-dark:#CB7676;--s-light:#AB5959"> void</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span><span style="--s-dark:#666666;--s-light:#999999">)</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">      add</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">depsMap</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">get</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">key</span><span style="--s-dark:#666666;--s-light:#999999">))</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">    }</span></span>
<span class="line"><span style="--s-dark:#758575DD;--s-light:#A0ADA0">    // ...</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">  }</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">}</span></span></code></pre><p>æˆ‘ä»¬å‘ç°ï¼Œè¿™é‡ŒæŠŠè·å–äº†ä¼ è¿›æ¥å±æ€§åï¼ˆ<code>key</code>ï¼‰çš„<code>Set&lt;Effect&gt;</code>ï¼Œå¹¶ä¸”æ·»åŠ åœ¨ä¸Šé¢è¯´åˆ°çš„ä¸¤ä¸ªæ•°ç»„ä¸­ã€‚</p><p>ç„¶åå®šä¹‰äº†ä¸€ä¸ª<code>run</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¼€å¤´å¤„ç†äº†å¼€å‘æ¨¡å¼ä¸‹çš„<code>onTrigger</code>å‡½æ•°ï¼Œæœ€åï¼Œæ‰§è¡Œäº†ä¼ è¿›æ¥çš„effect</p><p>æœ€åéå†ä¸¤ä¸ªå‰é¢è¯´åˆ°çš„æ•°ç»„ï¼Œæ‰§è¡Œäº†å…¨éƒ¨å’Œ<code>target</code>çš„<code>key</code>æœ‰å…³çš„effectã€‚</p><p>è‡³æ­¤ï¼Œå“åº”å¼çš„åŸç†åŸºæœ¬ä¸Šå·²ç»æ˜äº†äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ®µå¾ˆç®€å•çš„ä»£ç æ¥æ¢³ç†æ•´ä¸ªæµç¨‹</p><pre class="shiki shiki-themes vitesse-dark vitesse-light" style="--s-dark:#dbd7caee;--s-light:#393a34;--s-dark-bg:#121212;--s-light-bg:#ffffff" tabindex="0"><code class="language-javascript"><span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#666666;--s-light:#999999"> {</span><span style="--s-dark:#BD976A;--s-light:#B07D48">reactive</span><span style="--s-dark:#666666;--s-light:#999999">,</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> effect</span><span style="--s-dark:#666666;--s-light:#999999">}</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> VueReactivity</span><span style="--s-dark:#666666;--s-light:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#CB7676;--s-light:#AB5959">const</span><span style="--s-dark:#BD976A;--s-light:#B07D48"> state</span><span style="--s-dark:#666666;--s-light:#999999"> =</span><span style="--s-dark:#80A665;--s-light:#59873A"> reactive</span><span style="--s-dark:#666666;--s-light:#999999">({</span></span>
<span class="line"><span style="--s-dark:#B8A965;--s-light:#998418">  count</span><span style="--s-dark:#666666;--s-light:#999999">:</span><span style="--s-dark:#4C9A91;--s-light:#2F798A"> 0</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span>
<span class="line"></span>
<span class="line"><span style="--s-dark:#80A665;--s-light:#59873A">effect</span><span style="--s-dark:#666666;--s-light:#999999">(()</span><span style="--s-dark:#666666;--s-light:#999999"> =&gt;</span><span style="--s-dark:#666666;--s-light:#999999"> {</span></span>
<span class="line"><span style="--s-dark:#BD976A;--s-light:#B07D48">  console</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#80A665;--s-light:#59873A">log</span><span style="--s-dark:#666666;--s-light:#999999">(</span><span style="--s-dark:#BD976A;--s-light:#B07D48">state</span><span style="--s-dark:#666666;--s-light:#999999">.</span><span style="--s-dark:#BD976A;--s-light:#B07D48">count</span><span style="--s-dark:#666666;--s-light:#999999">);</span></span>
<span class="line"><span style="--s-dark:#666666;--s-light:#999999">});</span></span></code></pre><p>é¦–å…ˆæˆ‘ä»¬é€šè¿‡<code>reactive</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œè¿™ä¸ªå“åº”å¼å¯¹è±¡ä»£ç†äº†æºå¯¹è±¡ï¼Œå®ƒçš„<code>set</code>å’Œ<code>get</code>ä¸­åˆ†åˆ«æœ‰<code>track</code>ï¼ˆæ”¶é›†ä¾èµ–ï¼‰å’Œ<code>trigger</code>ï¼ˆè§¦å‘ä¾èµ–ï¼‰è¿™ä¸¤ä¸ªæ“ä½œã€‚</p><p>ç„¶åæˆ‘ä»¬é€šè¿‡<code>effect</code>æ¥æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ï¼Œåœ¨æ‰§è¡Œä¸­ï¼Œä¼šæ ‡è®°è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>activeEffect</code>ï¼Œç„¶åè¿è¡Œå®ƒï¼Œ</p><p>ä¸€è¿è¡Œï¼Œå¦‚æœä½¿ç”¨äº†å“åº”å¼çš„å˜é‡ï¼Œå°±ä¼šè§¦å‘ä»£ç†å¯¹è±¡çš„<code>get</code>ï¼Œæ‰§è¡Œäº†<code>track</code>å‡½æ•°</p><p>å°±æŠŠå½“å‰è¿è¡Œçš„å‡½æ•°å’Œè¿™ä¸ªå“åº”å¼å¯¹è±¡å»ºç«‹ä¸€ä¸ªåŒå‘çš„è¿æ¥ã€‚</p><p>å½“æˆ‘ä»¬ä¿®æ”¹å“åº”å¼å˜é‡ï¼Œæ¯”å¦‚æ‰§è¡Œ<code>state.count++</code>æ—¶ï¼Œä¼šè§¦å‘ä»£ç†å¯¹è±¡çš„<code>set</code>ï¼Œæ‰§è¡Œäº†<code>trigger</code>å‡½æ•°ï¼Œ</p><p><code>trigger</code>å‡½æ•°ä¼šé€šè¿‡ä¹‹å‰å»ºç«‹çš„è¿æ¥ï¼Œæ‰¾åˆ°å’Œè‡ªå·±ç›¸å…³çš„effectï¼Œç„¶åæ‰§è¡Œã€‚</p><p>æˆ‘æ„Ÿè§‰å¦‚æœæ˜ç™½äº†åŸºæœ¬çš„æµç¨‹ï¼Œé‚£æºä»£ç çœ‹èµ·æ¥åº”è¯¥ä¸éš¾ï¼Œå› ä¸ºçŸ¥é“ä¸‹ä¸€æ­¥è¦å¹²ä»€ä¹ˆï¼Œå‰©ä¸‹çš„å°±æ˜¯ä¸€äº›åˆ¤æ–­ä¹‹ç±»çš„ä»£ç äº†ã€‚</p><h1 id="åè®°" tabindex="-1">åè®° <a class="header-anchor" href="#åè®°">ğŸ”—</a></h1><p>ç¬¬ä¸€æ¬¡å†™è¿™ä¹ˆé•¿çš„ç¬”è®°ï¼Œå¦‚æœå“ªé‡Œå†™çš„ä¸å¥½å¸Œæœ›æå‡ºæ¥ï¼Œéå¸¸æ„Ÿè°¢ï¼</p></div><!--]--></div><div flex="~ wrap" text="[var(--mygo-c-text-2)]" mt-8="" gap-4="" justify-center=""><!--[--><div>#JavaScript</div><div>#Vue</div><!--]--></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="~ wrap" gap-4=""><a href="/f2ce2a5d2fc0" class="" truncate="" title="Vue3.0Reactivityä¹‹ref"><i class="i-mi:chevron-left" mr-1=""></i><span>Vue3.0Reactivityä¹‹ref</span></a><a href="/a7ffec850800" class="" ml-auto="" truncate="" title="Vue3.0çš„Reactivity-APIsï¼ˆè¯‘ï¼‰"><span>Vue3.0çš„Reactivity-APIsï¼ˆè¯‘ï¼‰</span><i class="i-mi:chevron-right" ml-1=""></i></a></div><!--]--></div></div><!--[--><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-4c769fad="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" gap-4="" items-start="" data-v-4c769fad=""><div flex="~ shrink-0" bg="[var(--mygo-c-bg-alt)]" rounded-6px="" w-60px="" aspect-ratio-square="" items-center="" justify-center="" data-v-4c769fad=""><i text-40px="" text="[#999]" class="i-fa6-regular:user" data-v-4c769fad=""></i></div><div flex="~ col grow" gap-2="" lg:gap-4="" data-v-4c769fad=""><textarea disabled="" placeholder="ä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼Œç•™ä¸‹è¯„è®ºè¡Œä¸è¡Œ" class="mujika-git-talk-textarea" un-disabled:cursor-not-allowed="" p-2="" outline-0="" lg:p-4="" data-v-4c769fad=""></textarea><div flex="" items-start="" data-v-4c769fad=""><a target="_blank" href="https://guides.github.com/features/mastering-markdown/" data-v-4c769fad="">æ”¯æŒ Markdown è¯­æ³•</a><div ml-auto="" data-v-4c769fad=""></div><!----><button class="mujika-button" data-v-4c769fad="" data-v-15330f5f=""><!--[--><!--]--><!--[-->ç‚¹å‡»ç™»å½•<!--]--></button></div></div></div><!--]--></div></div><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" data-v-4c769fad="" data-v-7ac4adc5=""><div class="p-4 lg:p-8" data-v-7ac4adc5=""><!--[--><div flex="" items-center="" justify-center="" data-v-4c769fad="">å“¦å‘¢è¯¥ï¼Œå¦‚æœæ²¡æœ‰è¯„è®ºçš„è¯ï¼Œç“¦è¾¾è¥¿...</div><!----><!----><!--]--></div></div><!--]--></div><aside class="mujika-aside" w="280px" flex="~ col shrink-0" top-2="" sticky="" max-h="[calc(100vh-var(--spacing)*4)]" un-hidden="" lg:block=""><div class="mujika-card mujika-card--hover mujika-card--border" w-full="" overflow-auto="" flex="~ col" gap-4="" data-v-7ac4adc5=""><!--[--><div p="4 b-0" flex-shrink-0="">æ–‡ç« ç›®å½•</div><div p="4 t-0" flex-grow="" min-h-0="" overflow-y-auto=""><!----></div><!--]--></div></aside><!--teleport start--><!--teleport end--></div></main><footer class="mujika-footer" px-4="" py-6="" bg="[var(--mygo-c-bg)]" flex="~ col shrink-0" gap-2="" items-center="" data-v-d1d7a153=""><div flex="" items-center="" data-v-d1d7a153=""><span data-v-d1d7a153="">Power by&nbsp;</span><i class="i-logos:vue" data-v-d1d7a153=""></i><span data-v-d1d7a153="">&nbsp;+&nbsp;</span><i class="i-logos:vitejs" data-v-d1d7a153=""></i></div><div text-center="" data-v-d1d7a153=""><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" data-v-d1d7a153="">CC BY-NC-SA 4.0 </a>2021 - PRESENT Â© Dedicatus545</div><div text="[var(--mygo-c-text-2)]" text-center="" data-v-d1d7a153="">å¦‚æœæˆ‘å’Œç‹—ä¸€æ ·æœ‰å°¾å·´çš„è¯ï¼Œä¸€å®šä¼šè—ä¸ä½è¿™ä»½å–œæ‚¦ï¼Œè€Œå°¾å·´ä¸€ç›´æ‘‡ä¸ªä¸åœå§ã€‚</div></footer></div></div></body></html>